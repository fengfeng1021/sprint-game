<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seth Casino II - V2.1 Stable</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+TC:wght@400;700&family=Roboto+Condensed:wght@700&family=Rye&display=swap"
        rel="stylesheet">

    <!-- 优化1: 资源预加载 - 提前加载关键资源以提升性能 -->
    <link rel="preload" href="./images/man.png" as="image">
    <link rel="preload" href="./images/woman.png" as="image">
    <link rel="preload" href="./images/10.png" as="image">
    <link rel="preload" href="./sound/bgm.MP3" as="audio">
    <link rel="preload" href="./sound/sprint.mp3" as="audio">
    <link rel="preload" href="./sound/clear.mp3" as="audio">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            /* [优化] 移动端核心：禁止双击缩放，消除点击延迟，提升手感 */
            touch-action: manipulation; 
            /* [优化] 禁止 iOS 长按弹出菜单 */
            -webkit-touch-callout: none;
            /* [优化] 禁止移动端下拉刷新/橡皮筋效果，保持APP体验 */
            overscroll-behavior: none;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .font-roboto {
            font-family: 'Roboto Condensed', sans-serif;
        }

        .font-noto {
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* 黃金字體 */
        .font-egyptian-gold {
            font-family: 'Rye', cursive;
            background: linear-gradient(to bottom, #fff7ed 20%, #fbbf24 45%, #d97706 75%, #78350f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-text-stroke: 1.5px #290d02;
            text-shadow: 0 2px 0 #451a03, 0 4px 4px rgba(0, 0, 0, 0.8), 0 0 15px rgba(251, 191, 36, 0.3);
        }

        .font-gold-3d {
            font-family: 'Rye', serif;
            background: linear-gradient(180deg, #fffbeb 10%, #fbbf24 45%, #d97706 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            -webkit-text-stroke: 1.5px #451a03;
            filter: drop-shadow(0 2px 0 #451a03) drop-shadow(0 4px 2px rgba(0, 0, 0, 0.5));
            font-weight: normal;
        }

        /* 滾動條 */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #0f0500;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        /* ------------------------------------------------
       A. 下落與位移動畫 (Drop Animations)
       ------------------------------------------------ */

        /* 1. 重力下落 (新圖案) */
        @keyframes fallingDown {
            0% {
                transform: translateY(-500%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

.animate-heavy-drop {
            animation: fallingDown calc(0.5s / var(--speed-factor, 1)) ease-out both;
        }

        /* 2. 幸存者短距离滑落 (舊圖案) */
        @keyframes survivorDrop {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(0);
            }
        }

        .animate-survivor-drop {
            animation: survivorDrop calc(0.4s / var(--speed-factor, 1)) cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        /* ------------------------------------------------
       B. 消除動畫 (Elimination: 2s 劃圈 + 爆閃)
       ------------------------------------------------ */

        /* 1. 容器動畫 (邊框發光 - 固定大小) */
        @keyframes borderGlowEffect {
            0% {
                border-color: transparent;
                background: rgba(46, 16, 101, 0.3);
                box-shadow: none;
                z-index: 50;
                transform: scale(1);
            }

            10% {
                /* 初始亮起：青色電光 + 綠光填充 */
                border-color: #e0ffff;
                background: rgba(0, 255, 200, 0.1);
                box-shadow: inset 0 0 10px #00ffea, inset 0 0 40px rgba(0, 255, 100, 0.6), 0 0 15px #00ffea;
                opacity: 1;
            }

            37.5% {
                /* 中間閃白：配合圖案高亮 */
                border-color: #ffffff;
                background: rgba(255, 255, 255, 0.3);
                box-shadow: inset 0 0 30px #ffffff, 0 0 40px #ffffff;
            }

            75% {
                /* 歸位狀態：恢復青綠光 */
                border-color: #e0ffff;
                background: rgba(0, 255, 200, 0.1);
                box-shadow: inset 0 0 10px #00ffea, inset 0 0 40px rgba(0, 255, 100, 0.6), 0 0 15px #00ffea;
                transform: scale(1);
                opacity: 1;
            }

            90% {
                /* 爆炸蓄力 */
                border-color: #ffffff;
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 0 60px #ffffff, inset 0 0 60px #ffffff;
                transform: scale(1.05);
                /* 輕微放大，增加衝擊波 */
            }

            100% {
                /* 爆炸結束：邊框消失但不放大 */
                border-color: #ffffff;
                background: transparent;
                box-shadow: 0 0 100px transparent;
                transform: scale(1);
                opacity: 0;
            }
        }

        /* 2. 圖案動畫 (3D劃圈 -> 歸位 -> 爆炸) */
        @keyframes symbolRotateScale {
            0% {
                transform: perspective(500px) translate3d(0, 0, 0) rotateY(0deg) scale(1);
                filter: brightness(1);
            }

            /* 向左前劃圈 (放大) */
            20% {
                transform: perspective(500px) translate3d(-10%, 0, 0) rotateY(-30deg) scale(1.02);
                filter: brightness(1.1);
            }

            /* 中間：最大放大 + 閃白高亮 (1.5s 總時長中的 0.75s 點) */
            37.5% {
                transform: perspective(500px) translate3d(0, 0, 30px) rotateY(0deg) scale(1.08);
                filter: brightness(1.4) contrast(1.2) drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            }

            /* 向右前劃圈 */
            55% {
                transform: perspective(500px) translate3d(10%, 0, 0) rotateY(30deg) scale(1.02);
                filter: brightness(1.1);
            }

            /* 完美歸位 (1.5s) */
            75% {
                transform: perspective(500px) translate3d(0, 0, 0) rotateY(0deg) scale(1);
                filter: brightness(1);
                opacity: 1;
            }

            /* 蓄力後縮 */
            85% {
                transform: perspective(500px) translate3d(0, 0, -30px) rotateY(0deg) scale(0.95);
                filter: brightness(2) contrast(1.5);
            }

            /* 爆炸 */
            100% {
                transform: perspective(500px) translate3d(0, 0, 80px) rotateY(0deg) scale(2);
                filter: brightness(5) blur(20px);
                opacity: 0;
            }
        }

.animate-eliminate-shake {
            /* [總時長] 2秒 -> 动态倍速 */
            animation: borderGlowEffect calc(2s / var(--speed-factor, 1)) cubic-bezier(0.4, 0, 0.2, 1) forwards;
            border-width: 4px;
            border-style: solid;
            box-sizing: border-box;
        }

        .animate-eliminate-shake img,
        .animate-eliminate-shake>div {
            /* [總時長] 2秒 (必須同步) -> 动态倍速 */
            animation: symbolRotateScale calc(2s / var(--speed-factor, 1)) cubic-bezier(0.4, 0, 0.2, 1) forwards;
            will-change: transform, filter, opacity;
        }

        /* ------------------------------------------------
       C. 人物施法動作 (Character Casting)
       ------------------------------------------------ */
        @keyframes characterCastAction {
            0% {
                transform: translateY(-50%) scale(1);
                filter: brightness(1) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            }

            20% {
                transform: translateY(-50%) scale(1.1);
                filter: brightness(1.3) contrast(1.1) drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
            }

            100% {
                transform: translateY(-50%) scale(1);
                filter: brightness(1) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            }
        }

        .animate-character-cast {
            animation: characterCastAction calc(0.8s / var(--speed-factor, 1)) ease-out forwards;
            z-index: 20 !important;
        }
        /* ------------------------------------------------
       D. 閃電與衝擊波 (Lightning & Impact)
       ------------------------------------------------ */
        @keyframes fallingLightningBolt {
            0% {
                opacity: 0;
                transform: translateY(-100%) scaleX(0.2);
            }

            15% {
                opacity: 1;
                transform: translateY(0) scaleX(1);
                filter: brightness(2.5);
            }

            60% {
                opacity: 1;
                transform: translateY(0) scaleX(1);
                filter: brightness(2.5);
            }

            100% {
                opacity: 0;
                transform: translateY(0) scaleX(0);
            }
        }

        @keyframes impactShockwave {
            0% {
                opacity: 0;
                transform: scale(0.2);
            }

            15% {
                opacity: 1;
                transform: scale(1.45);
                background: radial-gradient(circle, #ffffff 20%, #00eaff 80%, #0044aa 100%);
                box-shadow: 0 0 40px #00eaff, inset 0 0 20px #ffffff;
                filter: brightness(2.5);
                z-index: 90;
            }

            60% {
                opacity: 1;
                transform: scale(1.45);
                filter: brightness(1.8);
            }

            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

/* 閃電光束容器 */
        .lightning-bolt-container {
            position: absolute;
            top: -100%;
            bottom: 50%;
            left: 40%;
            right: 40%;
            z-index: 95;
            pointer-events: none;
            background: linear-gradient(to bottom, transparent 0%, rgba(0, 68, 170, 0.8) 70%, #00eaff 90%, #ffffff 100%);
            filter: drop-shadow(0 0 10px #00eaff) blur(3px) brightness(2.5);
            border-radius: 0 0 100px 100px;
            animation: fallingLightningBolt calc(0.8s / var(--speed-factor, 1)) ease-out forwards;
        }

        /* 衝擊波容器 */
        .lightning-impact-cell {
            position: absolute;
            inset: 0;
            z-index: 90;
            pointer-events: none;
            border-radius: 50%;
            filter: blur(3px);
            animation: impactShockwave calc(0.8s / var(--speed-factor, 1)) ease-out forwards;
        }

        /* ------------------------------------------------
       E. 其他通用動畫 (Misc / Legacy)
       ------------------------------------------------ */
        @keyframes floatGroupWin {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -150%) scale(1.5);
                opacity: 1;
                text-shadow: 0 0 20px gold;
            }

            80% {
                transform: translate(-50%, -200%) scale(1.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -300%) scale(1);
                opacity: 0;
            }
        }

        @keyframes winPulse {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.15);
                filter: brightness(1.3) drop-shadow(0 0 10px gold);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        @keyframes spinButtonPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(147, 51, 234, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
            }
        }

        /* ------------------------------------------------
           F. 粒子系統升级 (Visual Upgrade: 3D Coins & Sparks)
           ------------------------------------------------ */
        @keyframes coinFall3D {
            0% { transform: translate3d(0, -100px, 0) rotateX(0) rotateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translate3d(0, 0, 0) rotateX(45deg) rotateY(180deg) scale(1); }
            100% { transform: translate3d(0, 110vh, 0) rotateX(360deg) rotateY(1080deg) scale(1); opacity: 0; }
        }

        @keyframes sparkBurst {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0); opacity: 0; }
        }

        .coin-particle {
            position: fixed;
            top: 0; left: 0;
            width: 40px; height: 40px;
            /* 高级质感渐变 */
            background: radial-gradient(circle at 30% 30%, #fff7ed, #ffd700, #b45309);
            border-radius: 50%;
            border: 2px solid #fbbf24;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.8);
            z-index: 9999;
            pointer-events: none;
            will-change: transform;
            /* 自动适配倍速变量 */
            animation: coinFall3D calc(var(--duration, 3s) / var(--speed-factor, 1)) linear forwards;
            animation-delay: calc(var(--delay, 0s) / var(--speed-factor, 1));
        }
        /* 金币纹理 */
        .coin-particle::after {
            content: '$';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #92400e;
            font-size: 24px;
            opacity: 0.8;
        }

        .click-particle {
            position: fixed;
            width: 6px; height: 6px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #fbbf24;
            z-index: 99999;
            pointer-events: none;
            /* 点击火花动画 */
            animation: sparkBurst calc(0.6s / var(--speed-factor, 1)) ease-out forwards;
        }
        /* ------------------------------------------------
           G. 背景呼吸光效 (Background Breathing Light)
           ------------------------------------------------ */
        @keyframes bgBreathingAnim {
            0% { opacity: 0.2; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0.2; transform: translate(-50%, -50%) scale(0.8); }
        }

        .bg-breathing-light {
            position: absolute;
            top: 50%; left: 50%;
            width: 120vmax; height: 120vmax; /* 覆盖全屏 */
            background: radial-gradient(circle, rgba(251, 191, 36, 0.15) 0%, rgba(180, 83, 9, 0.05) 40%, transparent 70%);
            pointer-events: none;
            z-index: 5; /* 位于背景(0)之上，人物(10)之下 */
            mix-blend-mode: screen; /* 混合模式产生发光感 */
            will-change: transform, opacity;
            /* 自动适配倍速：基准呼吸周期 5秒 */
            animation: bgBreathingAnim calc(5s / var(--speed-factor, 1)) infinite ease-in-out;
        }

        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            color: #ff5555;
            padding: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <div id="error-overlay"></div>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const overlay = document.getElementById('error-overlay');
            overlay.style.display = 'block';
            overlay.innerHTML += `<strong>Error:</strong> ${msg}\nAt: ${url}:${lineNo}:${columnNo}\n\n${error ? error.stack : ''}\n----------------\n`;
            return false;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { User, Lock, LogIn, Loader2, AlertTriangle } from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ★★★ 引用外部組件 (注意路徑) ★★★
        import GamePlatformLobby from './Lobby.js';
        import SethCasinoGame from './SethGame.js';

        // --- 全局配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5a41T_dk-k8iEIxaoAQcET5noB6Zy0ko",
            authDomain: "aiapp-93616.firebaseapp.com",
            projectId: "aiapp-93616",
            storageBucket: "aiapp-93616.firebasestorage.app",
            messagingSenderId: "144618205398",
            appId: "1:144618205398:web:f27098e35e4f5424279977",
            measurementId: "G-67RXLTP8QN"
        };

        const APP_ID = 'seth-casino-v1';
        const COL_USERS = 'users';
        const COL_CONFIG = 'config';
        const DEFAULT_USERS = [
            { id: 'admin', name: '系統管理員', password: 'admin', role: 'admin', balance: 0 },
            { id: 'player1', name: '測試玩家一號', password: '1234', role: 'player', balance: 50000 },
        ];

        let app, auth, db;
        const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";
        if (isConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        // --- 登入組件 ---
        function LoginScreen({ onLogin, loading, isConfigured }) {
            const [id, setId] = useState('');
            const [pass, setPass] = useState('');

            if (!isConfigured) {
                return <div className="fixed inset-0 bg-black text-white flex items-center justify-center">Firebase Config Error</div>;
            }

            return (
                <div className="fixed inset-0 w-full h-full bg-[#0f0500] flex items-center justify-center p-4 font-noto">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#2d1b0e_0%,_#0f0500_100%)] z-0 opacity-50"></div>
                    <div className="w-full max-w-md bg-[#1c1917] border border-[#fbbf24]/30 p-8 rounded-2xl shadow-2xl relative z-10 animate-in">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-cinzel font-bold text-[#fbbf24] tracking-widest mb-2">SETH PLATFORM</h1>
                            <p className="text-gray-500 text-sm tracking-wide uppercase">Cloud Gaming System</p>
                        </div>
                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs text-gray-400 uppercase mb-2 font-bold">User ID</label>
                                <div className="relative">
                                    <User className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} />
                                    <input type="text" value={id} onChange={e => setId(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-3 pl-10 pr-4 text-white focus:border-[#fbbf24] outline-none" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 uppercase mb-2 font-bold">Password</label>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} />
                                    <input type="password" value={pass} onChange={e => setPass(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-3 pl-10 pr-4 text-white focus:border-[#fbbf24] outline-none" />
                                </div>
                            </div>
                            <button onClick={() => onLogin(id, pass)} disabled={loading} className="w-full bg-gradient-to-r from-[#b45309] to-[#fbbf24] text-black font-bold py-3 rounded-lg hover:brightness-110 transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                {loading ? <Loader2 className="animate-spin" /> : <><LogIn size={18} /> LOGIN</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 主平台入口 ---
        function PlatformApp() {
            const [userAuth, setUserAuth] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            const [currentView, setCurrentView] = useState('login'); 

            useEffect(() => {
                if (!isConfigured) return;
                signInAnonymously(auth);
                return onAuthStateChanged(auth, (u) => setUserAuth(u));
            }, []);

            useEffect(() => {
                if (!userAuth) return;
                const usersRef = collection(db, 'apps', APP_ID, COL_USERS);
                const unsub = onSnapshot(usersRef, (snap) => {
                    const list = []; snap.forEach(d => list.push(d.data()));
                    if (list.length === 0) DEFAULT_USERS.forEach(u => setDoc(doc(db, 'apps', APP_ID, COL_USERS, u.id), u));
                    if (currentUser) {
                        const fresh = list.find(u => u.id === currentUser.id);
                        if (fresh) setCurrentUser(prev => ({ ...prev, ...fresh }));
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, [userAuth, currentUser?.id]); 

            const handleLogin = async (id, pass) => {
                setLoading(true);
                try {
                    const userRef = doc(db, 'apps', APP_ID, COL_USERS, id);
                    const snap = await getDoc(userRef);
                    if (snap.exists() && snap.data().password === pass) {
                        setCurrentUser(snap.data());
                        setCurrentView('lobby'); 
                    } else {
                        alert("帳號或密碼錯誤");
                    }
                } catch (e) { console.error(e); alert("登入錯誤"); }
                setLoading(false);
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setCurrentView('login');
            };

            const renderContent = () => {
                if (!currentUser) return <LoginScreen onLogin={handleLogin} loading={loading} isConfigured={isConfigured} />;

                switch (currentView) {
                    case 'lobby':
                        return <GamePlatformLobby user={currentUser} onSelectGame={(id) => setCurrentView(`game-${id}`)} onLogout={handleLogout} />;
                    case 'game-seth':
                        return <SethCasinoGame user={currentUser} onBack={() => setCurrentView('lobby')} db={db} APP_ID={APP_ID} COL_CONFIG={COL_CONFIG} COL_USERS={COL_USERS} />;
                    default:
                        return <div className="text-white p-10">Error: Unknown View</div>;
                }
            };

            return renderContent();
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<PlatformApp />);
    </script>
</body>

</html>
