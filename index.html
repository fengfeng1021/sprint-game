<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seth Casino II - V2.1 Stable</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+TC:wght@400;700&family=Roboto+Condensed:wght@700&family=Rye&display=swap"
        rel="stylesheet">

    <!-- ‰ºòÂåñ1: ËµÑÊ∫êÈ¢ÑÂä†ËΩΩ - ÊèêÂâçÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê‰ª•ÊèêÂçáÊÄßËÉΩ -->
    <link rel="preload" href="./images/man.png" as="image">
    <link rel="preload" href="./images/woman.png" as="image">
    <link rel="preload" href="./images/10.png" as="image">
    <link rel="preload" href="./sound/bgm.MP3" as="audio">
    <link rel="preload" href="./sound/sprint.mp3" as="audio">
    <link rel="preload" href="./sound/clear.mp3" as="audio">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .font-roboto {
            font-family: 'Roboto Condensed', sans-serif;
        }

        .font-noto {
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* ÈªÉÈáëÂ≠óÈ´î */
        .font-egyptian-gold {
            font-family: 'Rye', cursive;
            background: linear-gradient(to bottom, #fff7ed 20%, #fbbf24 45%, #d97706 75%, #78350f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-text-stroke: 1.5px #290d02;
            text-shadow: 0 2px 0 #451a03, 0 4px 4px rgba(0, 0, 0, 0.8), 0 0 15px rgba(251, 191, 36, 0.3);
        }

        .font-gold-3d {
            font-family: 'Rye', serif;
            background: linear-gradient(180deg, #fffbeb 10%, #fbbf24 45%, #d97706 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            -webkit-text-stroke: 1.5px #451a03;
            filter: drop-shadow(0 2px 0 #451a03) drop-shadow(0 4px 2px rgba(0, 0, 0, 0.5));
            font-weight: normal;
        }

        /* ÊªæÂãïÊ¢ù */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #0f0500;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        /* ------------------------------------------------
       A. ‰∏ãËêΩËàá‰ΩçÁßªÂãïÁï´ (Drop Animations)
       ------------------------------------------------ */

        /* 1. ÈáçÂäõ‰∏ãËêΩ (Êñ∞ÂúñÊ°à) */
        @keyframes fallingDown {
            0% {
                transform: translateY(-500%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-heavy-drop {
            animation: fallingDown 0.5s ease-out both;
        }

        /* 2. Âπ∏Â≠òËÄÖÁü≠Ë∑ùÁ¶ªÊªëËêΩ (ËàäÂúñÊ°à) */
        @keyframes survivorDrop {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(0);
            }
        }

        .animate-survivor-drop {
            animation: survivorDrop 0.4s cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        /* ------------------------------------------------
       B. Ê∂àÈô§ÂãïÁï´ (Elimination: 2s ÂäÉÂúà + ÁàÜÈñÉ)
       ------------------------------------------------ */

        /* 1. ÂÆπÂô®ÂãïÁï´ (ÈÇäÊ°ÜÁôºÂÖâ - Âõ∫ÂÆöÂ§ßÂ∞è) */
        @keyframes borderGlowEffect {
            0% {
                border-color: transparent;
                background: rgba(46, 16, 101, 0.3);
                box-shadow: none;
                z-index: 50;
                transform: scale(1);
            }

            10% {
                /* ÂàùÂßã‰∫ÆËµ∑ÔºöÈùíËâ≤ÈõªÂÖâ + Á∂†ÂÖâÂ°´ÂÖÖ */
                border-color: #e0ffff;
                background: rgba(0, 255, 200, 0.1);
                box-shadow: inset 0 0 10px #00ffea, inset 0 0 40px rgba(0, 255, 100, 0.6), 0 0 15px #00ffea;
                opacity: 1;
            }

            37.5% {
                /* ‰∏≠ÈñìÈñÉÁôΩÔºöÈÖçÂêàÂúñÊ°àÈ´ò‰∫Æ */
                border-color: #ffffff;
                background: rgba(255, 255, 255, 0.3);
                box-shadow: inset 0 0 30px #ffffff, 0 0 40px #ffffff;
            }

            75% {
                /* Ê≠∏‰ΩçÁãÄÊÖãÔºöÊÅ¢Âæ©ÈùíÁ∂†ÂÖâ */
                border-color: #e0ffff;
                background: rgba(0, 255, 200, 0.1);
                box-shadow: inset 0 0 10px #00ffea, inset 0 0 40px rgba(0, 255, 100, 0.6), 0 0 15px #00ffea;
                transform: scale(1);
                opacity: 1;
            }

            90% {
                /* ÁàÜÁÇ∏ËìÑÂäõ */
                border-color: #ffffff;
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 0 60px #ffffff, inset 0 0 60px #ffffff;
                transform: scale(1.05);
                /* ËºïÂæÆÊîæÂ§ßÔºåÂ¢ûÂä†Ë°ùÊìäÊ≥¢ */
            }

            100% {
                /* ÁàÜÁÇ∏ÁµêÊùüÔºöÈÇäÊ°ÜÊ∂àÂ§±‰ΩÜ‰∏çÊîæÂ§ß */
                border-color: #ffffff;
                background: transparent;
                box-shadow: 0 0 100px transparent;
                transform: scale(1);
                opacity: 0;
            }
        }

        /* 2. ÂúñÊ°àÂãïÁï´ (3DÂäÉÂúà -> Ê≠∏‰Ωç -> ÁàÜÁÇ∏) */
        @keyframes symbolRotateScale {
            0% {
                transform: perspective(500px) translate3d(0, 0, 0) rotateY(0deg) scale(1);
                filter: brightness(1);
            }

            /* ÂêëÂ∑¶ÂâçÂäÉÂúà (ÊîæÂ§ß) */
            20% {
                transform: perspective(500px) translate3d(-10%, 0, 0) rotateY(-30deg) scale(1.02);
                filter: brightness(1.1);
            }

            /* ‰∏≠ÈñìÔºöÊúÄÂ§ßÊîæÂ§ß + ÈñÉÁôΩÈ´ò‰∫Æ (1.5s Á∏ΩÊôÇÈï∑‰∏≠ÁöÑ 0.75s Èªû) */
            37.5% {
                transform: perspective(500px) translate3d(0, 0, 30px) rotateY(0deg) scale(1.08);
                filter: brightness(1.4) contrast(1.2) drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            }

            /* ÂêëÂè≥ÂâçÂäÉÂúà */
            55% {
                transform: perspective(500px) translate3d(10%, 0, 0) rotateY(30deg) scale(1.02);
                filter: brightness(1.1);
            }

            /* ÂÆåÁæéÊ≠∏‰Ωç (1.5s) */
            75% {
                transform: perspective(500px) translate3d(0, 0, 0) rotateY(0deg) scale(1);
                filter: brightness(1);
                opacity: 1;
            }

            /* ËìÑÂäõÂæåÁ∏Æ */
            85% {
                transform: perspective(500px) translate3d(0, 0, -30px) rotateY(0deg) scale(0.95);
                filter: brightness(2) contrast(1.5);
            }

            /* ÁàÜÁÇ∏ */
            100% {
                transform: perspective(500px) translate3d(0, 0, 80px) rotateY(0deg) scale(2);
                filter: brightness(5) blur(20px);
                opacity: 0;
            }
        }

        .animate-eliminate-shake {
            /* [Á∏ΩÊôÇÈï∑] 2Áßí */
            animation: borderGlowEffect 2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            border-width: 4px;
            border-style: solid;
            box-sizing: border-box;
        }

        .animate-eliminate-shake img,
        .animate-eliminate-shake>div {
            /* [Á∏ΩÊôÇÈï∑] 2Áßí (ÂøÖÈ†àÂêåÊ≠•) */
            animation: symbolRotateScale 2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            will-change: transform, filter, opacity;
        }

        /* ------------------------------------------------
       C. ‰∫∫Áâ©ÊñΩÊ≥ïÂãï‰Ωú (Character Casting)
       ------------------------------------------------ */
        @keyframes characterCastAction {
            0% {
                transform: translateY(-50%) scale(1);
                filter: brightness(1) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            }

            20% {
                transform: translateY(-50%) scale(1.1);
                filter: brightness(1.3) contrast(1.1) drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
            }

            100% {
                transform: translateY(-50%) scale(1);
                filter: brightness(1) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            }
        }

        .animate-character-cast {
            animation: characterCastAction 0.8s ease-out forwards;
            z-index: 20 !important;
        }

        /* ------------------------------------------------
       D. ÈñÉÈõªËàáË°ùÊìäÊ≥¢ (Lightning & Impact)
       ------------------------------------------------ */
        @keyframes fallingLightningBolt {
            0% {
                opacity: 0;
                transform: translateY(-100%) scaleX(0.2);
            }

            15% {
                opacity: 1;
                transform: translateY(0) scaleX(1);
                filter: brightness(2.5);
            }

            60% {
                opacity: 1;
                transform: translateY(0) scaleX(1);
                filter: brightness(2.5);
            }

            100% {
                opacity: 0;
                transform: translateY(0) scaleX(0);
            }
        }

        @keyframes impactShockwave {
            0% {
                opacity: 0;
                transform: scale(0.2);
            }

            15% {
                opacity: 1;
                transform: scale(1.45);
                background: radial-gradient(circle, #ffffff 20%, #00eaff 80%, #0044aa 100%);
                box-shadow: 0 0 40px #00eaff, inset 0 0 20px #ffffff;
                filter: brightness(2.5);
                z-index: 90;
            }

            60% {
                opacity: 1;
                transform: scale(1.45);
                filter: brightness(1.8);
            }

            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

        /* ÈñÉÈõªÂÖâÊùüÂÆπÂô® */
        .lightning-bolt-container {
            position: absolute;
            top: -100%;
            bottom: 50%;
            left: 40%;
            right: 40%;
            z-index: 95;
            pointer-events: none;
            background: linear-gradient(to bottom, transparent 0%, rgba(0, 68, 170, 0.8) 70%, #00eaff 90%, #ffffff 100%);
            filter: drop-shadow(0 0 10px #00eaff) blur(3px) brightness(2.5);
            border-radius: 0 0 100px 100px;
            animation: fallingLightningBolt 0.8s ease-out forwards;
        }

        /* Ë°ùÊìäÊ≥¢ÂÆπÂô® */
        .lightning-impact-cell {
            position: absolute;
            inset: 0;
            z-index: 90;
            pointer-events: none;
            border-radius: 50%;
            filter: blur(3px);
            animation: impactShockwave 0.8s ease-out forwards;
        }

        /* ------------------------------------------------
       E. ÂÖ∂‰ªñÈÄöÁî®ÂãïÁï´ (Misc / Legacy)
       ------------------------------------------------ */
        @keyframes floatGroupWin {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -150%) scale(1.5);
                opacity: 1;
                text-shadow: 0 0 20px gold;
            }

            80% {
                transform: translate(-50%, -200%) scale(1.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -300%) scale(1);
                opacity: 0;
            }
        }

        @keyframes winPulse {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.15);
                filter: brightness(1.3) drop-shadow(0 0 10px gold);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        @keyframes spinButtonPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(147, 51, 234, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
            }
        }

        @keyframes coinFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Animation Classes */
        .animate-group-win {
            animation: floatGroupWin 1.5s ease-out forwards;
        }

        .animate-win-pulse {
            animation: winPulse 1.5s infinite ease-in-out;
            z-index: 10;
        }

        .animate-spin-btn {
            animation: spinButtonPulse 2s infinite;
        }

        .animate-magic-appear {
            animation: magicHit 0.5s ease-out forwards;
        }

        .coin-particle {
            position: fixed;
            top: -50px;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 10px gold;
            z-index: 9999;
            animation: coinFall linear forwards;
        }

        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            color: #ff5555;
            padding: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <div id="error-overlay"></div>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const overlay = document.getElementById('error-overlay');
            overlay.style.display = 'block';
            overlay.innerHTML += `<strong>Error:</strong> ${msg}\nAt: ${url}:${lineNo}:${columnNo}\n\n${error ? error.stack : ''}\n----------------\n`;
            return false;
        };
    </script>

<script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { User, Lock, LogIn, Users, Settings, Play, Plus, Minus, RotateCw, Zap, X, Save, LogOut, Terminal, ChevronsRight, Trophy, Flame, Trash2, PlusCircle, RefreshCw, Database, Activity, BarChart2, Hash, Cpu, Cloud, Loader2, AlertTriangle, Copy, ShoppingCart, Coins, Volume2, VolumeX } from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. Ê†∏ÂøÉÈÖçÁΩÆ ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5a41T_dk-k8iEIxaoAQcET5noB6Zy0ko", authDomain: "aiapp-93616.firebaseapp.com", projectId: "aiapp-93616",
            storageBucket: "aiapp-93616.firebasestorage.app", messagingSenderId: "144618205398", appId: "1:144618205398:web:f27098e35e4f5424279977", measurementId: "G-67RXLTP8QN"
        };
        const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";
        const APP_ID = 'seth-casino-v1';
        const ROWS = 5, COLS = 6;
        const COL_USERS = 'users', COL_CONFIG = 'config';

        const SYMBOLS_DEF = [
            { id: 99, type: 'scatter', icon: './images/10.png', name: 'Scatter', scale: 1 },
            { id: 88, type: 'mult', icon: 'üíé', color: 'text-green-400', name: 'Multiplier' },
            { id: 9, type: 'normal', icon: './images/9.png', payout: { 12: 50, 10: 25, 8: 10 }, name: 'Eye', scale: 1 },
            { id: 8, type: 'normal', icon: './images/8.png', payout: { 12: 25, 10: 10, 8: 2.5 }, name: 'Snake', scale: 1 },
            { id: 7, type: 'normal', icon: './images/7.png', payout: { 12: 15, 10: 5, 8: 2 }, name: 'Bow', scale: 1 },
            { id: 6, type: 'normal', icon: './images/6.png', payout: { 12: 12, 10: 2, 8: 1.5 }, name: 'Blade', scale: 1 },
            { id: 5, type: 'normal', icon: './images/5.png', payout: { 12: 10, 10: 1.5, 8: 1 }, name: 'Gold', scale: 0.7 },
            { id: 4, type: 'normal', icon: './images/4.png', payout: { 12: 8, 10: 1.2, 8: 0.8 }, name: 'Red', scale: 0.7 },
            { id: 3, type: 'normal', icon: './images/3.png', payout: { 12: 5, 10: 1, 8: 0.5 }, name: 'Purple', scale: 0.7 },
            { id: 2, type: 'normal', icon: './images/2.png', payout: { 12: 4, 10: 0.9, 8: 0.4 }, name: 'Blue', scale: 0.7 },
            { id: 1, type: 'normal', icon: './images/1.png', payout: { 12: 2, 10: 0.75, 8: 0.25 }, name: 'Green', scale: 0.7 },
        ];

        const DEFAULT_CONFIG = {
            emptySpinProbability: 0.2, smashProbability: 0.3,
            symbolWeights: { 1: 15, 2: 15, 3: 15, 4: 15, 5: 15, 6: 8, 7: 8, 8: 3.5, 9: 3.5, 99: 2 },
            multiplierWeights: { 2: 40, 3: 25, 4: 15, 5: 15, 6: 15, 8: 10, 10: 5, 15: 3, 25: 15, 100: 1.5, 500: 0.5 }
        };

        const DEFAULT_USERS = [
            { id: 'admin', name: 'Á≥ªÁªüÁÆ°ÁêÜÂëò', password: 'admin', role: 'admin', balance: 0 },
            { id: 'player1', name: 'ÊµãËØïÁé©ÂÆ∂‰∏ÄÂè∑', password: '1234', role: 'player', balance: 50000 },
        ];

        // --- 2. Â∑•ÂÖ∑ÂáΩÂºè ---
        let app, auth, db;
        try { if (isConfigured) { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } } catch (e) { console.error("Firebase:", e); }

        let globalAudioCtx = null;
        const initAudio = () => {
            if (!globalAudioCtx) { const AC = window.AudioContext || window.webkitAudioContext; if (AC) globalAudioCtx = new AC(); }
            if (globalAudioCtx?.state === 'suspended') globalAudioCtx.resume();
        };

        const spawnCoins = (amount = 20) => {
            for (let i = 0; i < amount; i++) {
                const coin = document.createElement('div');
                coin.className = 'coin-particle';
                Object.assign(coin.style, { left: Math.random() * 100 + 'vw', animationDuration: (Math.random() * 2 + 2) + 's', animationDelay: Math.random() + 's' });
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 4000);
            }
        };

        // --- 3. ÁÆóÊ≥ïÈÄªËæë ---
        const Algo = {
            getWeights: (cfg, type = 'symbol') => {
                const source = type === 'symbol' ? (cfg?.symbolWeights || DEFAULT_CONFIG.symbolWeights) : (cfg?.multiplierWeights || DEFAULT_CONFIG.multiplierWeights);
                return Object.entries(source).map(([k, v]) => ({ id: Number(k), val: Number(k), weight: Number(v) })).filter(w => type !== 'symbol' || w.id !== 88);
            },
            getRandomByWeight: (weights) => {
                let r = Math.random() * weights.reduce((a, w) => a + w.weight, 0);
                for (let w of weights) { r -= w.weight; if (r <= 0) return w.id || w.val; }
                return weights[0]?.id || 1;
            },
            getSymbol: (id) => ({ ...SYMBOLS_DEF.find(s => s.id === id) || SYMBOLS_DEF.find(s => s.id === 1) }),
            getUniformSymbol: () => {
                const valid = SYMBOLS_DEF.filter(s => s.id !== 88);
                return { ...valid[Math.floor(Math.random() * valid.length)] };
            }
        };

        const getMultWeightsFromConfig = (cfg) => Algo.getWeights(cfg, 'mult');
        
        const generateLosingGrid = (cfg) => {
            const grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            const counts = {};
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let sym, isValid = false, attempts = 0;
                    while (attempts++ < 20) {
                        sym = Algo.getUniformSymbol();
                        const cnt = counts[sym.id] || 0, limit = (sym.id === 99) ? 2 : 7;
                        const left = c > 0 ? grid[r][c - 1] : null, top = r > 0 ? grid[r - 1][c] : null;
                        if (cnt < limit && (!left || left.id !== sym.id) && (!top || top.id !== sym.id)) { isValid = true; break; }
                    }
                    if (!isValid) {
                        let safeId = 1;
                        while (safeId === (c > 0 ? grid[r][c - 1]?.id : -1) || safeId === (r > 0 ? grid[r - 1][c]?.id : -1)) safeId++;
                        sym = Algo.getSymbol(safeId);
                    }
                    counts[sym.id] = (counts[sym.id] || 0) + 1;
                    grid[r][c] = sym;
                }
            }
            return grid;
        };

        const generateWinningGrid = (cfg, isFG) => {
            const grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            const weights = Algo.getWeights(cfg);
            const usedPos = new Set();
            let target = null, safe = 0;
            while (!target && safe++ < 20) { const id = Algo.getRandomByWeight(weights); if (id !== 88) target = Algo.getSymbol(id); }
            if (!target) target = Algo.getSymbol(1);
            const isWinFG = (target.id === 99);
            const winCount = isWinFG ? 4 : (Math.floor(Math.random() * 2) + 8);
            let placed = 0;
            while (placed < winCount) {
                const r = Math.floor(Math.random() * ROWS), c = Math.floor(Math.random() * COLS);
                if (!usedPos.has(`${r}-${c}`)) { grid[r][c] = { ...target }; usedPos.add(`${r}-${c}`); placed++; }
            }
            const counts = { [target.id]: winCount };
            let scatterCount = isWinFG ? 4 : 0;
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (!grid[r][c]) {
                        let filler, subSafe = 0;
                        do {
                            filler = Algo.getSymbol(Algo.getRandomByWeight(weights)); subSafe++;
                            if (filler.id === 88 || filler.id === target.id) { filler = null; continue; }
                            if (filler.id === 99) { if (scatterCount >= (isWinFG ? 4 : 2)) { filler = null; continue; } } 
                            else if ((counts[filler.id] || 0) >= 7) { filler = null; continue; }
                        } while (!filler && subSafe < 15);
                        if (!filler) { let safeId = (target.id === 1) ? 2 : 1; filler = Algo.getSymbol(safeId); }
                        if (filler.id === 99) scatterCount++;
                        counts[filler.id] = (counts[filler.id] || 0) + 1;
                        grid[r][c] = filler;
                    }
                }
            }
            return grid;
        };

        const generateGridData = (cfg) => {
            const weights = Algo.getWeights(cfg);
            let scatterCount = 0;
            return Array(ROWS).fill(null).map(() => Array(COLS).fill(null).map(() => {
                let sym, safe = 0;
                do {
                    sym = Algo.getSymbol(Algo.getRandomByWeight(weights));
                    if (sym.id === 88) sym = Algo.getSymbol(1);
                    if (sym.id === 99 && scatterCount >= 4) sym = null;
                    safe++;
                } while (!sym && safe < 10);
                if (!sym) sym = Algo.getSymbol(1);
                if (sym.id === 99) scatterCount++;
                return sym;
            }));
        };

        const generateRiggedGrid = (cfg, type) => {
            const grid = generateGridData(cfg);
            if (type === 'SCATTER') {
                const pos = [];
                while (pos.length < 4) {
                    const r = Math.floor(Math.random() * ROWS), c = Math.floor(Math.random() * COLS);
                    if (!pos.some(p => p.r === r && p.c === c)) pos.push({ r, c });
                }
                pos.forEach(p => grid[p.r][p.c] = Algo.getSymbol(99));
            } else if (type === 'BIG_WIN') {
                let count = 0;
                const target = Algo.getSymbol(9);
                grid.forEach((row, r) => row.forEach((_, c) => { if (Math.random() > 0.4 && count < 12) { grid[r][c] = { ...target }; count++; } }));
            }
            return grid;
        };

        const getPayout = (id, count) => {
            const s = SYMBOLS_DEF.find(sym => sym.id === id);
            return (s?.payout) ? (count >= 12 ? s.payout[12] : count >= 10 ? s.payout[10] : count >= 8 ? s.payout[8] : 0) : 0;
        };

        // --- 4. ÁªÑ‰ª∂ÂÆö‰πâ (SymbolCell) - Â∑≤ÁßªÈô§Âø´ÈÄüÊ®°ÂºèÈÄªËæë ---
        const SymbolCell = ({ cell, isEliminating, isStruck, isSpecialScatter, isSpinning, c }) => {
            if (!cell) return <div className="bg-transparent"></div>;

            let animClass = '';
            if (isSpinning && !isEliminating) {
                animClass = cell.isNew ? 'animate-heavy-drop' : (cell.isDropping ? 'animate-survivor-drop' : '');
            }
            
            // Âä®ÁîªÊó∂ÈïøÈÄªËæëÔºöÂõ∫ÂÆö‰∏∫Ê≠£Â∏∏ÈÄüÂ∫¶
            let duration = undefined;
            if (isEliminating) {
                duration = '2s'; 
            } else if (isSpinning && cell.isNew) {
                duration = '0.5s';
            }

            let innerContent;
            
            if (cell.id === 88) {
                let imgName = 'small4.png';
                if (cell.val <= 3) imgName = 'small.png';
                else if (cell.val <= 8) imgName = 'small2.png';
                else if (cell.val <= 15) imgName = 'small3.png';
                
                innerContent = (
                    <div className="relative w-full h-full flex items-center justify-center p-1 group">
                        <img src={`./images/${imgName}`} alt={`${cell.val}x`} className="w-full h-full object-contain drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] transition-transform duration-200 group-hover:scale-105" />
                        <span className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 font-egyptian-gold text-5xl md:text-7xl z-20 pointer-events-none pb-2">{cell.val}x</span>
                    </div>
                );
            } else if (cell.id === 99) {
                innerContent = (
                    <div className="relative w-full h-full flex flex-col items-center justify-center p-1">
                        <img src={cell.icon} alt="Scatter" className="w-full h-full object-contain drop-shadow-[0_0_10px_rgba(255,215,0,0.6)]" />
                        <div className="absolute bottom-0 w-full text-center">
                            <span className="text-[10px] md:text-xs font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-600 drop-shadow-[0_2px_0_rgba(0,0,0,1)] tracking-wider font-cinzel block -mt-2">SCATTER</span>
                        </div>
                    </div>
                );
            } else {
                innerContent = (
                    <div className="w-full h-full flex items-center justify-center p-1 relative">
                        <img src={cell.icon} alt={cell.name} className="object-contain drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] transition-transform duration-200" style={{ width: `${(cell.scale || 1) * 100}%`, height: `${(cell.scale || 1) * 100}%` }} />
                    </div>
                );
            }

            const style = {
                zIndex: isEliminating ? 100 : (isSpecialScatter ? 90 : 10),
                animationDelay: (cell.isNew && isSpinning) ? `${c * 0.1}s` : '0s',
                animationDuration: duration, 
                transition: 'all 0.2s'
            };

            const containerClass = `relative flex items-center justify-center border border-white/5 overflow-visible transition-all duration-200 ${animClass} ${isEliminating ? 'animate-eliminate-shake' : 'bg-black/20'} ${isSpecialScatter ? 'scale-125 animate-pulse drop-shadow-[0_0_15px_gold]' : ''} ${cell.isJustRevealed ? 'animate-magic-appear' : ''}`;

            return (
                <div style={style} className={containerClass}>
                    {isStruck && <React.Fragment><div className="lightning-impact-cell"></div><div className="lightning-bolt-container"></div></React.Fragment>}
                    {innerContent}
                </div>
            );
        };

        const GameGrid = ({ grid, visuals, status, modals }) => {
            return (
                <div className="relative w-full max-w-[95vw] md:max-w-[800px] aspect-[4/3] landscape:w-auto landscape:h-[85%] landscape:aspect-[16/10] landscape:max-w-none z-20 transition-all duration-300">
                    {modals.fgTrigger && (<div className="absolute inset-0 z-50 flex items-center justify-center pointer-events-none"><div className="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 via-yellow-500 to-yellow-800 drop-shadow-[0_0_20px_rgba(255,215,0,0.8)] animate-bounce-drop font-cinzel tracking-tighter text-center leading-tight">FREE<br />GAMES</div></div>)}
                    
                    <div className="w-full h-full bg-gradient-to-b from-[#0b1c38] via-[#2b5a7a] to-[#0b1c38] rounded-lg border-2 md:border-4 border-amber-600 shadow-[0_0_60px_rgba(0,0,0,0.9)] grid grid-cols-6 grid-rows-5 gap-px p-0.5 relative overflow-hidden ring-2 ring-[#fbbf24]/30">
                        {grid.map((row, r) => row.map((cell, c) => (
                            <SymbolCell 
                                key={`${r}-${c}`} 
                                cell={cell} 
                                isEliminating={visuals.eliminating.has(`${r}-${c}`)} 
                                isStruck={visuals.strikes.has(`${r}-${c}`)} 
                                isSpecialScatter={cell?.id === 99 && grid.flat().filter(x=>x?.id===99).length>=4 && modals.fgTrigger} 
                                isSpinning={status.spinning} 
                                c={c} 
                            />
                        )))}
                        {visuals.texts.map(f => (
                            <div key={f.id} className="absolute z-[200] font-black text-4xl md:text-6xl text-yellow-400 animate-group-win pointer-events-none select-none whitespace-nowrap font-noto drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] flex items-center justify-center" style={{ top: `calc(${f.r} * 20% + 10%)`, left: `calc(${f.c} * 16.666% + 8.333%)`, transform: 'translate(-50%, -50%)' }}>{f.val}</div>
                        ))}
                    </div>
                </div>
            );
        };

        const PermissionErrorModal = ({ isOpen }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-4 font-noto">
                    <div className="bg-[#1c1917] border border-red-500 w-full max-w-2xl rounded-xl shadow-2xl p-6 text-white">
                        <h2 className="text-2xl font-bold text-red-500 mb-4">Permission Denied</h2>
                        <p className="mb-4 text-gray-300">ËØ∑Ëá≥ Firebase Console ËÆæÂÆö Firestore Rules„ÄÇ</p>
                        <button onClick={() => window.location.reload()} className="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded w-full">ÈáçÊï¥È°µÈù¢</button>
                    </div>
                </div>
            );
        };

        const BuyBonusModal = ({ isOpen, onClose, bet, onBuy, playSound = () => { } }) => {
            if (!isOpen) return null;
            const cost = bet * 100;
            return (
                <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 font-noto animate-bounce-drop">
                    <div className="bg-gradient-to-b from-[#2d1b0e] to-[#0f0500] border-2 border-[#fbbf24] w-full max-w-sm rounded-xl shadow-[0_0_50px_rgba(251,191,36,0.3)] p-6 text-center relative">
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><X size={24} /></button>
                        <h2 className="text-2xl font-black text-[#fbbf24] mb-2 font-cinzel tracking-widest">BUY FREE SPINS</h2>
                        <div className="flex items-center justify-center gap-4 mb-6 mt-4">
                            <div className="text-right"><div className="text-[10px] text-gray-500">Cost</div><div className="text-2xl font-mono text-white font-bold">${cost.toLocaleString()}</div></div>
                            <div className="text-4xl">‚ûî</div>
                            <div className="text-left"><div className="text-[10px] text-gray-500">Get</div><div className="text-2xl font-black text-rose-500 flex items-center gap-1"><Trophy size={24} /> 15 SPINS</div></div>
                        </div>
                        <button onClick={() => { playSound('click'); onBuy(cost); }} className="w-full bg-gradient-to-r from-[#b45309] to-[#fbbf24] hover:brightness-110 text-black font-black py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 active:scale-95">
                            <ShoppingCart size={20} /> Á°ÆËÆ§Ë¥≠‰π∞
                        </button>
                    </div>
                </div>
            );
        };

        const BigWinOverlay = ({ winAmount, onClose }) => {
            const [displayWin, setDisplayWin] = useState(0);
            useEffect(() => {
                spawnCoins(50);
                let start = 0, duration = 2000, startTime = performance.now();
                const animate = (currentTime) => {
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    setDisplayWin(Math.floor(winAmount * (1 - Math.pow(1 - progress, 3))));
                    if (progress < 1) requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }, [winAmount]);
            return (
                <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in duration-300" onClick={onClose}>
                    <div className="text-center relative">
                        <div className="absolute inset-0 bg-[#fbbf24] blur-[100px] opacity-20 rounded-full animate-pulse"></div>
                        <h1 className="text-6xl md:text-8xl font-black text-[#fbbf24] font-cinzel tracking-tighter mb-4 animate-text-zoom">BIG WIN</h1>
                        <div className="text-4xl md:text-6xl font-mono font-bold text-white drop-shadow-lg">{displayWin.toLocaleString()}</div>
                        <p className="text-gray-400 mt-8 animate-pulse">ÁÇπÂáª‰ªªÊÑèÂ§ÑÂÖ≥Èó≠</p>
                    </div>
                </div>
            );
        };

        const SimulatorModal = ({ isOpen, onClose, config }) => {
            const [simCount, setSimCount] = useState(1000);
            const [inputCount, setInputCount] = useState("1000");
            const [isRunning, setIsRunning] = useState(false);
            const [progress, setProgress] = useState(0);
            const [stats, setStats] = useState(null);
            
            const runSim = async () => {
                if (simCount <= 0) return;
                setIsRunning(true); setProgress(0); setStats(null);
                
                const tempStats = { runs: 0, totalBet: 0, totalWin: 0, maxWin: 0, fgCount: 0, baseGameEmptyCount: 0, smashCount: 0, multCounts: {}, winDistribution: { "Zero": 0, "0-1x": 0, "1-10x": 0, "10-50x": 0, "50-100x": 0, "100x+": 0 } };
                const bet = 100;
                const multWeights = getMultWeightsFromConfig(config);

                const simulateRound = (initialGrid, isFG, currentAccMult = 0) => {
                    let grid = initialGrid.map(row => row.map(c => ({...c})));
                    let roundTotalWin = 0, active = true, loops = 0, triggerFG = false, retriggerFG = false;
                    let localAccMult = currentAccMult;
                    
                    while (active && loops < 20) {
                        loops++;
                        const candidates = [];
                        for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(grid[r][c]?.id <= 9) candidates.push({r,c});
                        if (Math.random() < (config.smashProbability || 0.3) && candidates.length > 0) {
                            tempStats.smashCount++;
                            const t = candidates[Math.floor(Math.random() * candidates.length)];
                            let randomM = Math.random() * multWeights.reduce((a,w)=>a+w.weight,0);
                            let selectedVal = 2;
                            for(let w of multWeights) { randomM -= w.weight; if(randomM <= 0) { selectedVal = w.val; break; } }
                            tempStats.multCounts[selectedVal] = (tempStats.multCounts[selectedVal] || 0) + 1;
                            grid[t.r][t.c] = { id: 88, val: selectedVal };
                        }
                        const counts = {};
                        grid.flat().forEach(c => { if (c?.type === 'normal') counts[c.id] = (counts[c.id] || 0) + 1; });
                        const wins = Object.keys(counts).filter(id => counts[id] >= 8);
                        const scatters = grid.flat().filter(c => c?.id === 99).length;
                        
                        if (!isFG && scatters >= 4) triggerFG = true;
                        if (isFG && scatters >= 3) retriggerFG = true;
                        if (wins.length === 0) { active = false; break; }

                        wins.forEach(id => roundTotalWin += bet * getPayout(Number(id), counts[id]));
                        const eliminatedSet = new Set();
                        wins.forEach(id => grid.forEach((row,r) => row.forEach((col,c) => { if(String(col?.id)===String(id)) eliminatedSet.add(`${r}-${c}`); })));

                        const nextGrid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
                        const isNextDropEmpty = Math.random() < (config.emptySpinProbability || 0.2);
                        let predictedScatterCount = grid.flat().filter((c, i) => { 
                            const r = Math.floor(i/COLS), col = i%COLS; 
                            return c?.id === 99 && !eliminatedSet.has(`${r}-${col}`); 
                        }).length;

                        for (let c = 0; c < COLS; c++) {
                            let colData = [];
                            for (let r = 0; r < ROWS; r++) if (grid[r][c] && !eliminatedSet.has(`${r}-${c}`)) colData.push(grid[r][c]);
                            while (colData.length < ROWS) {
                                let sym;
                                const isScatterRoll = (Math.random() * 100) < (config.symbolWeights?.[99] || 2);
                                if (isScatterRoll) sym = Algo.getSymbol(99);
                                else sym = Algo.getUniformSymbol();

                                if (sym.id === 88) sym = Algo.getSymbol(1);
                                if (sym.id === 99 && predictedScatterCount >= 4) sym = Algo.getUniformSymbol();
                                if (isNextDropEmpty && colData.length > 0 && colData[0].id === sym.id) sym = null;
                                
                                if (sym) { 
                                    if (sym.id === 99) predictedScatterCount++;
                                    colData.unshift(sym); 
                                }
                            }
                            for (let r = 0; r < ROWS; r++) nextGrid[r][c] = colData[r];
                        }
                        grid = nextGrid;
                    }
                    
                    const mults = grid.flat().filter(c => c?.id === 88).reduce((a,b)=>a+b.val,0);
                    let finalWin = isFG ? (roundTotalWin > 0 ? roundTotalWin * (localAccMult + mults || 1) : 0) : roundTotalWin * (mults || 1);
                    return { win: finalWin, triggerFG, retriggerFG, newAccMult: localAccMult + mults };
                };

                setTimeout(() => {
                    let currentRun = 0;
                    const processBatch = () => {
                        const end = Math.min(currentRun + 100, simCount);
                        while (currentRun < end) {
                            currentRun++; tempStats.runs++; tempStats.totalBet += bet;
                            const isForcedEmpty = Math.random() < (config.emptySpinProbability || 0.2);
                            if (isForcedEmpty) tempStats.baseGameEmptyCount++;
                            
                            const baseGrid = isForcedEmpty ? generateLosingGrid(config) : generateWinningGrid(config);
                            const baseResult = simulateRound(baseGrid, false, 0);
                            let totalSpinWin = baseResult.win;

                            if (baseResult.triggerFG) {
                                tempStats.fgCount++;
                                let spins = 15, fgAccMult = 0;
                                while (spins > 0) {
                                    spins--;
                                    const fgGrid = (Math.random() < (config.emptySpinProbability || 0.2)) ? generateLosingGrid(config) : generateWinningGrid(config, true);
                                    const fgResult = simulateRound(fgGrid, true, fgAccMult);
                                    totalSpinWin += fgResult.win;
                                    fgAccMult = fgResult.newAccMult;
                                    if (fgResult.retriggerFG) spins += 5;
                                }
                            }
                            tempStats.totalWin += totalSpinWin;
                            if (totalSpinWin > tempStats.maxWin) tempStats.maxWin = totalSpinWin;
                            const x = totalSpinWin / bet;
                            const label = x === 0 ? "Zero" : x < 1 ? "0-1x" : x < 10 ? "1-10x" : x < 50 ? "10-50x" : x < 100 ? "50-100x" : "100x+";
                            tempStats.winDistribution[label]++;
                        }
                        setProgress(Math.round((currentRun / simCount) * 100));
                        if (currentRun < simCount) setTimeout(processBatch, 0); else { setStats(tempStats); setIsRunning(false); }
                    };
                    processBatch();
                }, 100);
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[150] bg-black/95 backdrop-blur flex items-center justify-center p-4 font-noto overflow-y-auto">
                    <div className="bg-[#1c1917] border border-[#fbbf24] w-full max-w-4xl rounded-xl p-6 relative my-8">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={24} /></button>
                        <h2 className="text-2xl font-bold text-[#fbbf24] mb-6 flex items-center gap-2"><Activity /> Ê®°ÊãüÂô®</h2>
                        <div className="flex gap-4 mb-6 items-end">
                            <div className="flex-grow">
                                <label className="text-xs text-gray-400 font-bold uppercase block mb-1">Ê®°ÊãüÂ±ÄÊï∞</label>
                                <div className="flex gap-2">
                                    <input type="number" value={inputCount} onChange={e => { setInputCount(e.target.value); setSimCount(Number(e.target.value)); }} className="flex-grow bg-black border border-white/20 rounded px-3 py-2 text-white font-mono outline-none focus:border-[#fbbf24]" />
                                    <button onClick={() => { setInputCount("1000"); setSimCount(1000) }} className="px-3 border border-white/10 rounded hover:bg-white/5 text-gray-300">1K</button>
                                    <button onClick={() => { setInputCount("10000"); setSimCount(10000) }} className="px-3 border border-white/10 rounded hover:bg-white/5 text-gray-300">10K</button>
                                </div>
                            </div>
                            <button onClick={runSim} disabled={isRunning} className={`px-8 py-2 h-[42px] rounded font-bold text-black transition-colors flex items-center gap-2 ${isRunning ? 'bg-gray-600' : 'bg-[#fbbf24] hover:bg-[#f59e0b]'}`}>
                                {isRunning ? <Loader2 className="animate-spin" /> : <Play size={18} />} {isRunning ? 'ËÆ°ÁÆó‰∏≠...' : 'ÂºÄÂßãÊ®°Êãü'}
                            </button>
                        </div>
                        {isRunning && (<div className="mb-6"><div className="flex justify-between text-xs text-gray-400 mb-1"><span>ËøõÂ∫¶</span><span>{progress}%</span></div><div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-[#fbbf24]" style={{ width: `${progress}%` }}></div></div></div>)}
                        {stats && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-black/40 p-4 rounded border border-white/10"><div className="text-xs text-gray-500 uppercase font-bold">RTP</div><div className={`text-3xl font-bold font-mono ${stats.totalWin / stats.totalBet > 1 ? 'text-red-500' : 'text-emerald-500'}`}>{((stats.totalWin / stats.totalBet) * 100).toFixed(2)}%</div></div>
                                    <div className="bg-black/40 p-4 rounded border border-white/10"><div className="text-xs text-gray-500 uppercase font-bold">Max Win</div><div className="text-3xl font-bold font-mono text-[#fbbf24]">x{(stats.maxWin / 100).toFixed(0)}</div></div>
                                    <div className="bg-black/40 p-4 rounded border border-white/10"><div className="text-xs text-gray-500 uppercase font-bold">FG Ëß¶ÂèëÁéá</div><div className="text-xl font-mono text-white">1 / {stats.fgCount > 0 ? Math.round(stats.runs / stats.fgCount) : '-'}</div><div className="text-xs text-gray-600">Ê¨°Êï∞: {stats.fgCount}</div></div>
                                    <div className="bg-black/40 p-4 rounded border border-white/10"><div className="text-xs text-gray-500 uppercase font-bold">Á©∫ËΩ¨Áéá</div><div className="text-xl font-mono text-rose-400">{((stats.baseGameEmptyCount / stats.runs) * 100).toFixed(1)}%</div></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <h3 className="text-sm font-bold text-gray-300 mb-4 border-b border-white/10 pb-2">Ëµ¢ÂàÜÂàÜ‰Ωà</h3>
                                        <div className="space-y-2 text-xs">{Object.entries(stats.winDistribution).map(([range, count]) => (<div key={range} className="flex items-center gap-2"><span className="w-24 text-gray-400">{range}</span><div className="flex-grow h-4 bg-gray-800 rounded overflow-hidden relative"><div className="h-full bg-blue-600" style={{ width: `${(count / stats.runs) * 100}%` }}></div><span className="absolute inset-0 flex items-center justify-start px-2 text-[10px] text-white drop-shadow">{count} ({((count / stats.runs) * 100).toFixed(1)}%)</span></div></div>))}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const FloatingLogger = ({ logs, visible, onToggle }) => {
            if (!visible) return <button onClick={onToggle} className="fixed top-2 left-2 z-[100] bg-black/50 text-white p-2 rounded-full border border-white/20 hover:bg-black/80"><Terminal size={16} /></button>;
            return (
                <div className="fixed top-2 left-2 z-[100] w-64 max-h-[300px] flex flex-col font-noto animate-in slide-in-from-left-10">
                    <div className="bg-black/80 backdrop-blur-md border border-white/20 rounded-t-lg p-2 flex justify-between items-center cursor-pointer" onClick={onToggle}><span className="text-xs font-bold text-[#fbbf24] flex items-center gap-2"><Terminal size={12} /> Á≥ªÁµ±Êó•Ë™å</span><Minus size={12} className="text-gray-400" /></div>
                    <div className="bg-black/60 border-x border-b border-white/10 rounded-b-lg p-2 overflow-y-auto custom-scroll h-full text-[10px] font-mono">
                        {logs.length === 0 && <div className="text-gray-500 italic">Á≠âÂæÖÊï∏Êìö...</div>}
                        {logs.map((l, i) => (<div key={i} className={`mb-1 border-b border-white/5 pb-1 last:border-0 ${l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-emerald-400' : l.type === 'gold' ? 'text-yellow-400' : 'text-gray-300'}`}><span className="opacity-50 mr-1">[{l.time}]</span>{l.msg}</div>))}
                    </div>
                </div>
            );
        };

        const GameEngine = ({ user, globalConfig, onLogout, onUpdateBalance }) => {
            const [config, setConfig] = useState(globalConfig);
            const configRef = useRef(globalConfig);
            const [grid, setGrid] = useState(() => generateGridData(globalConfig).map(row => row.map(c => ({ ...c, key: Math.random().toString(36) }))));
            const [status, setStatus] = useState({ spinning: false, auto: false, bet: 10 });
            const [winState, setWinState] = useState({ current: 0, mult: 0, text: "0.00", fg: { active: false, left: 0, accMult: 0, total: 0 } });
            const [visuals, setVisuals] = useState({ eliminating: new Set(), texts: [], lasers: [], strikes: new Set(), manCast: false, womanCast: false });
            const [modals, setModals] = useState({ buy: false, bigWin: null, sim: false, fgTrigger: false, admin: false, logs: [], showLogs: true, volPanel: false });
            const [vol, setVol] = useState({ bgm: 0.4, sfx: 0.6 });

            const bgmRef = useRef(null);
            const audioPool = useRef({});
            useEffect(() => {
                const sources = { 'spin': './sound/sprint.mp3', 'win': './sound/clear.mp3', 'man': './sound/man.mp3', 'woman': './sound/woman.mp3', 'bigwin': './sound/clear.mp3', 'click': './sound/sprint.mp3', 'drop': './sound/sprint.mp3' };
                Object.entries(sources).forEach(([k, src]) => { const a = new Audio(src); a.preload = 'auto'; a.volume = vol.sfx; audioPool.current[k] = a; });
            }, []);
            useEffect(() => { Object.values(audioPool.current).forEach(a => a.volume = vol.sfx); }, [vol.sfx]);
            useEffect(() => { if (bgmRef.current) { bgmRef.current.volume = vol.bgm; if (vol.bgm > 0 && bgmRef.current.paused) bgmRef.current.play().catch(()=>{}); else if (vol.bgm === 0) bgmRef.current.pause(); } }, [vol.bgm]);

            const play = useCallback((type) => {
                const m = audioPool.current[type];
                if (!m) return;
                if (m.paused || m.ended) { m.currentTime = 0; m.play().catch(()=>{}); }
                else { try { const c = m.cloneNode(); c.volume = vol.sfx; c.play().catch(()=>{}); } catch (e) { m.currentTime = 0; m.play().catch(()=>{}); } }
            }, [vol.sfx]);

            useEffect(() => { setConfig(globalConfig); configRef.current = globalConfig; }, [globalConfig]);
            useEffect(() => { if (status.auto && !status.spinning && !winState.fg.active) setTimeout(() => startSpin(), 100); }, [status.auto, status.spinning, winState.fg.active]);
            useEffect(() => { 
                if (winState.fg.active && !status.spinning) {
                    if (winState.fg.left > 0) setTimeout(startSpin, 800);
                    else setTimeout(() => { setWinState(p => ({ ...p, fg: { ...p.fg, active: false } })); setStatus(p => ({ ...p, spinning: false, auto: false })); alert(`ÂÖçË≤ªÈÅäÊà≤ÁµêÊùüÔºÅÁ∏ΩÂàÜ: ${Math.floor(winState.fg.total)}`); }, 1000);
                } 
            }, [winState.fg.active, winState.fg.left, status.spinning]);

            useEffect(() => {
                const handleKey = (e) => { if (e.code === 'Space' && !status.spinning && !modals.buy && !modals.sim && !modals.admin && !winState.fg.active) { e.preventDefault(); startSpin(); } };
                window.addEventListener('keydown', handleKey); return () => window.removeEventListener('keydown', handleKey);
            }, [status.spinning, modals, winState.fg.active]);

            const addLog = (msg, type = 'info') => setModals(p => ({ ...p, logs: [{ time: new Date().toLocaleTimeString().split(' ')[0], msg, type }, ...p.logs].slice(0, 50) }));
            const smartWait = (ms) => new Promise(r => setTimeout(r, ms));

            const startSpin = async (forceType = null, isBuy = false, buyCost = 0) => {
                if (status.spinning) return;
                const cost = isBuy ? buyCost : status.bet;
                if (!winState.fg.active && user.balance < cost && !forceType) { setStatus(p => ({ ...p, auto: false })); alert("È§òÈ°ç‰∏çË∂≥"); return; }

                setStatus(p => ({ ...p, spinning: true })); setModals(p => ({ ...p, buy: false, fgTrigger: false }));
                setWinState(p => ({ ...p, current: 0, mult: 0, text: "0.00" }));
                setVisuals({ eliminating: new Set(), texts: [], lasers: [], strikes: new Set(), manCast: false, womanCast: false });

                if (!winState.fg.active) onUpdateBalance(user.balance - cost);
                else setWinState(p => ({ ...p, fg: { ...p.fg, left: p.fg.left - 1 } }));

                play('spin'); await new Promise(r => setTimeout(r, 50));

                const cfg = configRef.current;
                const isEmpty = !isBuy && !forceType && Math.random() < (cfg.emptySpinProbability || 0.2);
                let rawGrid;
                
                if (isBuy) { rawGrid = generateRiggedGrid(cfg, 'SCATTER'); addLog(`üõí Ë≥ºË≤∑ÁâπËâ≤ÈÅäÊà≤`, 'gold'); }
                else if (forceType) { rawGrid = generateRiggedGrid(cfg, forceType); addLog(`üî® GOD MODE: ${forceType}`, 'warning'); }
                else if (isEmpty) { rawGrid = generateLosingGrid(cfg); if(user.role==='admin') addLog(`üíÄ Âº∑Âà∂Á©∫ËΩâ`, 'gray'); }
                else { rawGrid = generateWinningGrid(cfg, winState.fg.active); if(user.role==='admin') addLog(`üéâ Âº∑Âà∂‰∏≠Áçé`, 'success'); }

                let currentGrid = rawGrid.map(row => row.map(c => ({ ...c, key: Math.random().toString(36), isNew: true })));
                setGrid(currentGrid);

                if (Math.random() < (cfg.smashProbability || 0.3)) {
                    const cands = []; currentGrid.forEach((r,ri)=>r.forEach((c,ci)=>{if(c.id<=9) cands.push({r:ri,c:ci})}));
                    if (cands.length > 0) {
                        const t = cands[Math.floor(Math.random() * cands.length)];
                        setTimeout(() => { setVisuals(p => ({ ...p, strikes: new Set([`${t.r}-${t.c}`]), manCast: t.c < 3, womanCast: t.c >= 3 })); play(t.c < 3 ? 'man' : 'woman'); }, 250);
                        
                        const val = Algo.getRandomByWeight(getMultWeightsFromConfig(cfg));
                        currentGrid[t.r][t.c] = { id: 88, type: 'mult', val, icon: 'üíé', color: 'text-green-400', name: 'Multiplier', isJustRevealed: true };
                        
                        setTimeout(() => setGrid([...currentGrid]), 450);
                        setTimeout(() => setVisuals(p => ({ ...p, strikes: new Set(), manCast: false, womanCast: false })), 1050);
                        
                        await new Promise(r => setTimeout(r, 1100));
                    } else await smartWait(1100);
                } else await smartWait(1100);

                await processLoop(currentGrid, cfg);
            };

            const processLoop = async (initGrid, cfg) => {
                let grid = initGrid, roundWin = 0, active = true, loops = 0;
                while (active && loops < 20) {
                    loops++;
                    const counts = {}; grid.flat().forEach(c => { if (c?.type === 'normal') counts[c.id] = (counts[c.id] || 0) + 1; });
                    const wins = Object.keys(counts).filter(id => counts[id] >= 8);
                    if (wins.length === 0) { active = false; break; }

                    let batchWin = 0, totalR = 0, totalC = 0, count = 0;
                    const elimSet = new Set();
                    wins.forEach(id => {
                        batchWin += status.bet * getPayout(Number(id), counts[id]);
                        grid.forEach((r, ri) => r.forEach((c, ci) => { if (String(c?.id) === String(id)) { elimSet.add(`${ri}-${ci}`); totalR += ri; totalC += ci; count++; } }));
                    });

                    if (batchWin > 0) {
                        play('win'); roundWin += batchWin;
                        setWinState(p => ({ ...p, current: roundWin, text: roundWin.toFixed(2) }));
                        setVisuals(p => ({ ...p, eliminating: elimSet, texts: [...p.texts, { id: Math.random(), r: totalR/count, c: totalC/count, val: batchWin.toFixed(1) }] }));
                    }
                    
                    await smartWait(2000);

                    grid = grid.map((r, ri) => r.map((c, ci) => elimSet.has(`${ri}-${ci}`) ? null : c));
                    setGrid([...grid]); setVisuals(p => ({ ...p, eliminating: new Set() }));

                    const nextGrid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
                    const isEmpty = Math.random() < (cfg.emptySpinProbability || 0.2);
                    let scatterCnt = grid.flat().filter(c => c?.id === 99).length;

                    for (let c = 0; c < COLS; c++) {
                        const col = [];
                        for (let r = 0; r < ROWS; r++) if (grid[r][c]) col.push({ ...grid[r][c], isNew: false, oldRow: r });
                        while (col.length < ROWS) {
                            let sym = Algo.getUniformSymbol();
                            if (sym.id === 88) sym = Algo.getSymbol(1);
                            if (sym.id === 99 && scatterCnt >= 4) sym = Algo.getSymbol(1);
                            if (isEmpty && col.length > 0 && col[0].id === sym.id) sym = Algo.getSymbol(sym.id === 1 ? 2 : 1);
                            if (sym.id === 99) scatterCnt++;
                            col.unshift({ ...sym, key: Math.random().toString(36), isNew: true });
                        }
                        for (let r = 0; r < ROWS; r++) { const cell = col[r]; if (!cell.isNew) cell.isDropping = (r !== cell.oldRow); nextGrid[r][c] = cell; }
                    }
                    play('drop'); grid = nextGrid; setGrid(grid); setVisuals(p => ({ ...p, texts: [] }));
                    await smartWait(1100);
                }

                const mults = grid.flat().filter(c => c?.id === 88).reduce((a, b) => a + b.val, 0);
                let finalMult = mults, applyMult = mults;
                if (winState.fg.active) {
                    if (roundWin > 0) { const newAcc = winState.fg.accMult + mults; setWinState(p => ({ ...p, fg: { ...p.fg, accMult: newAcc } })); finalMult = newAcc; applyMult = newAcc; }
                    else finalMult = winState.fg.accMult;
                }
                finalMult = Math.max(1, finalMult);

                if (roundWin > 0 && mults > 0) { play('bigwin'); setWinState(p => ({ ...p, text: `x ${applyMult}` })); await smartWait(800); }
                
                const finalWin = roundWin * finalMult;
                setWinState(p => ({ ...p, mult: finalMult > 1 ? finalMult : 0, current: finalWin, text: finalWin > 0 ? finalWin.toFixed(2) : "0.00" }));

                if (finalWin > 0) {
                    onUpdateBalance(user.balance + finalWin);
                    if (winState.fg.active) setWinState(p => ({ ...p, fg: { ...p.fg, total: p.fg.total + finalWin } }));
                    if (finalWin > status.bet * 20) { play('bigwin'); setModals(p => ({ ...p, bigWin: finalWin })); await smartWait(5000); setModals(p => ({ ...p, bigWin: null })); }
                    else if (finalWin > status.bet * 5) { play('bigwin'); await smartWait(1500); }
                }

                const scatters = grid.flat().filter(c => c?.id === 99).length;
                if (!winState.fg.active && scatters >= 4) {
                    addLog("‚ú® Ëß∏Áôº Free Game", 'gold'); setModals(p => ({ ...p, fgTrigger: true })); play('bigwin'); await smartWait(3000);
                    setWinState(p => ({ ...p, fg: { active: true, left: 15, accMult: 0, total: 0 } }));
                } else if (winState.fg.active && scatters >= 3) {
                    addLog("üîÑ Retrigger +5", 'gold'); setWinState(p => ({ ...p, fg: { ...p.fg, left: p.fg.left + 5 } }));
                }
                setStatus(p => ({ ...p, spinning: false }));
            };

            return (
                <div className="fixed inset-0 w-full h-[100dvh] bg-black font-roboto select-none flex flex-col landscape:flex-row overflow-hidden text-white">
                    <SimulatorModal isOpen={modals.sim} onClose={() => setModals(p => ({ ...p, sim: false }))} config={configRef.current} />
                    <BuyBonusModal isOpen={modals.buy} onClose={() => setModals(p => ({ ...p, buy: false }))} bet={status.bet} onBuy={(c) => startSpin(null, true, c)} playSound={play} />
                    {modals.bigWin && <BigWinOverlay winAmount={modals.bigWin} onClose={() => setModals(p => ({ ...p, bigWin: null }))} />}
                    {user.role === 'admin' && <FloatingLogger logs={modals.logs} visible={modals.showLogs} onToggle={() => setModals(p => ({ ...p, showLogs: !p.showLogs }))} />}

                    <div className="hidden landscape:flex fixed top-2 right-2 z-50 gap-2 items-start">
                        <div className="relative flex flex-col items-end">
                            <button onClick={() => setModals(p => ({...p, volPanel: !p.volPanel}))} className={`p-2 rounded-full border transition-colors ${modals.volPanel || vol.bgm > 0 ? 'bg-emerald-900/50 border-emerald-500 text-emerald-400' : 'bg-black/50 border-gray-500 text-gray-400'}`}>{vol.bgm > 0 ? <Volume2 size={14} /> : <VolumeX size={14} />}</button>
                            {modals.volPanel && (<div className="absolute top-10 right-0 bg-[#1c1917] border border-[#fbbf24]/30 p-4 rounded-xl shadow-2xl flex flex-col gap-4 w-48 animate-in fade-in slide-in-from-top-2 z-[60]"><div className="space-y-1"><div className="flex justify-between text-xs text-[#fbbf24] font-bold"><span>Music</span><span>{Math.round(vol.bgm * 100)}%</span></div><input type="range" min="0" max="1" step="0.05" value={vol.bgm} onChange={(e) => setVol(p=>({...p, bgm:Number(e.target.value)}))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#fbbf24]" /></div><div className="space-y-1"><div className="flex justify-between text-xs text-emerald-400 font-bold"><span>Sound</span><span>{Math.round(vol.sfx * 100)}%</span></div><input type="range" min="0" max="1" step="0.05" value={vol.sfx} onChange={(e) => setVol(p=>({...p, sfx:Number(e.target.value)}))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" /></div></div>)}
                        </div>
                        {user.role === 'admin' && <button onClick={() => setModals(p => ({ ...p, admin: !p.admin }))} className="bg-black/50 text-[#fbbf24] p-2 rounded-full border border-[#fbbf24]/30"><Settings size={14} /></button>}
                        <button onClick={onLogout} className="bg-black/50 text-rose-400 p-2 rounded-full border border-rose-500/30"><LogOut size={14} /></button>
                    </div>

                    <div className="relative flex-grow flex flex-col items-center justify-center p-2 landscape:p-0 landscape:pb-8 overflow-hidden w-full">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#2d1b0e_0%,_#0f0500_100%)] z-0"></div>
                        <img src="./images/man.png" className={`hidden lg:block absolute left-[2%] xl:left-[2%] top-1/2 -translate-y-1/2 h-[90%] max-h-[900px] w-auto object-contain z-10 drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)] pointer-events-none transition-transform duration-500 hover:scale-105 ${visuals.manCast ? 'animate-character-cast' : ''}`} />
                        <img src="./images/woman.png" className={`hidden lg:block absolute right-[2%] xl:right-[4%] top-1/2 -translate-y-1/2 h-[90%] max-h-[900px] w-auto object-contain z-10 drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)] pointer-events-none transition-transform duration-500 hover:scale-105 ${visuals.womanCast ? 'animate-character-cast' : ''}`} style={{ transform: 'translateY(-50%)' }} />

                        {winState.fg.active && (<div className="absolute left-24 top-1/2 -translate-y-1/2 z-40 hidden lg:block animate-bounce-drop pointer-events-none"><div className="flex flex-col items-center justify-center"><div className="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-b from-[#fff7ed] via-[#fbbf24] to-[#b45309] drop-shadow-[0_5px_0_#78350f] font-cinzel tracking-tighter leading-[0.8]">{winState.fg.left}</div><div className="flex flex-col items-center mt-4 space-y-[-5px]"><span className="text-3xl font-black text-[#fbbf24] drop-shadow-[0_2px_0_black] font-cinzel tracking-[0.2em]">FREE</span><span className="text-3xl font-black text-[#fbbf24] drop-shadow-[0_2px_0_black] font-cinzel tracking-[0.2em]">GAMES</span></div><div className="mt-6 bg-black/60 border border-[#fbbf24] px-4 py-1 rounded-full backdrop-blur-sm"><span className="text-xs text-gray-300 uppercase mr-2">Total Win</span><span className="text-xl font-mono text-white font-bold">{Math.floor(winState.fg.total).toLocaleString()}</span></div></div></div>)}

                        {!winState.fg.active && !status.spinning && (<div className="absolute left-2 top-2 z-30 lg:hidden landscape:hidden"><button onClick={() => { play('click'); setModals(p => ({ ...p, buy: true })); }} className="bg-[#b45309] border border-[#fbbf24] text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1"><ShoppingCart size={12} /> BUY</button></div>)}
                        {!winState.fg.active && (<div className="hidden landscape:block absolute left-4 z-30"><button onClick={() => { play('click'); setModals(p => ({ ...p, buy: true })); }} disabled={status.spinning} className="flex flex-col items-center justify-center w-16 h-16 bg-gradient-to-b from-[#b45309] to-[#451a03] border-2 border-[#fbbf24] rounded-xl shadow-lg hover:scale-105 active:scale-95 transition-all group"><div className="text-sm font-egyptian-gold -mt-3 mb-1">BUY</div><ShoppingCart className="text-white w-6 h-6 group-hover:text-[#fbbf24] transition-colors" /></button></div>)}

                        <div className="hidden landscape:flex flex-col gap-3 absolute right-4 top-1/2 -translate-y-1/2 z-50 items-center">
                            <button onClick={() => setStatus(p => ({...p, auto: !p.auto}))} className={`w-10 h-10 rounded-full border flex items-center justify-center shadow-lg bg-black/60 backdrop-blur ${status.auto ? 'border-emerald-500 text-emerald-400' : 'border-white/20 text-gray-400'}`}><RotateCw size={16} className={status.auto ? 'animate-spin-btn' : ''} /></button>
                            <div className="relative flex flex-col items-center bg-black/80 rounded-2xl border border-white/20 p-1 gap-1 backdrop-blur-md shadow-lg"><button disabled={status.spinning} onClick={(e) => { e.stopPropagation(); setStatus(p=>({...p, bet: Math.max(1, p.bet - (p.bet<=10?1:p.bet<=100?10:100))})); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-white active:scale-90 transition-transform"><Minus size={14} /></button><div className="text-[#fbbf24] font-bold font-mono text-xs py-1 select-none min-w-[24px] text-center">{status.bet}</div><button disabled={status.spinning} onClick={(e) => { e.stopPropagation(); setStatus(p=>({...p, bet: Math.max(1, p.bet + (p.bet<10?1:p.bet<100?10:100))})); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-white active:scale-90 transition-transform"><Plus size={14} /></button></div>
                            <button onClick={() => startSpin()} disabled={status.spinning && !status.auto} className="w-20 h-20 rounded-full bg-gradient-to-b from-[#f59e0b] to-[#b45309] border-4 border-[#451a03] shadow-[0_5px_15px_rgba(0,0,0,0.5)] flex items-center justify-center active:scale-95 transition-transform hover:brightness-110">{status.spinning ? <RotateCw className="animate-spin text-[#451a03]" size={28} /> : <Play className="fill-[#451a03] text-[#451a03] ml-1" size={32} />}</button>
                        </div>

                        <div className="relative z-20 w-full max-w-[95vw] md:max-w-[800px] h-10 md:h-16 mb-1 bg-black/60 border border-[#fbbf24]/30 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(0,0,0,0.5)] backdrop-blur-sm transition-all"><div className={`text-3xl md:text-5xl font-black tracking-widest transition-all duration-200 ${visuals.lasers.length > 0 ? 'text-white scale-125 drop-shadow-[0_0_10px_white]' : 'text-[#fbbf24] drop-shadow-md'}`}>{winState.text}</div></div>

                        {/* Grid Logic */}
                        <GameGrid grid={grid} visuals={visuals} status={status} modals={modals} />

                        <div className="hidden landscape:flex absolute bottom-0 w-full h-16 bg-black/90 border-t border-[#fbbf24]/30 z-50 items-center justify-center font-noto gap-12">
                            <div className="flex items-center gap-4"><span className="text-[#fbbf24] font-black text-lg tracking-widest">È§òÈ°ç</span><span className="text-5xl font-black text-white font-mono drop-shadow-[0_0_15px_rgba(251,191,36,0.6)]">{Math.floor(user.balance).toLocaleString()}</span></div>
                            <div className="flex items-center gap-4 absolute right-8 opacity-90"><span className="text-gray-400 font-bold text-sm">Ë¥èÂàÜ</span><span className="text-3xl font-black text-[#fbbf24] font-mono">{Math.floor(winState.fg.active ? winState.fg.total : winState.current)}</span></div>
                        </div>

                        <div className="shrink-0 bg-[#0c0a09] border-t border-[#fbbf24]/20 relative z-30 shadow-lg pb-safe landscape:hidden">
                            <div className="flex flex-col items-center justify-between px-4 py-2 gap-2">
                                <div className="flex w-full justify-between gap-2"><div className="bg-[#1c1917] px-2 py-1 rounded border border-white/5 flex-1 text-center"><div className="text-[8px] text-gray-500 font-bold tracking-wider font-noto">È§òÈ°ç</div><div className="text-sm font-mono text-white">{Math.floor(user.balance).toLocaleString()}</div></div><div className="bg-[#1c1917] px-2 py-1 rounded border border-yellow-900/30 flex-1 text-center"><div className="text-[8px] text-yellow-600 font-bold tracking-wider font-noto">Ë¥èÂàÜ</div><div className="text-sm font-mono text-[#fbbf24]">{Math.floor(winState.fg.active ? winState.fg.total : winState.current)}</div></div></div>
                                <div className="flex w-full items-center justify-between gap-2">
                                    <button onClick={() => setStatus(p=>({...p, auto: !p.auto}))} className={`w-10 h-10 rounded-full border flex items-center justify-center ${status.auto ? 'bg-emerald-900/50 border-emerald-500 text-emerald-400' : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10'}`}><RotateCw size={16} className={status.auto ? 'animate-spin-btn' : ''} /></button>
                                    <div className="relative flex items-center bg-[#1c1917] rounded-full border border-white/10 p-1 gap-1 flex-grow max-w-[200px] justify-between"><button disabled={status.spinning} onClick={(e) => { e.stopPropagation(); setStatus(p=>({...p, bet: Math.max(1, p.bet - (p.bet<=10?1:p.bet<=100?10:100))})); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 active:scale-90 transition-transform"><Minus size={12} /></button><div className="w-full text-center font-bold text-sm text-white select-none">{status.bet}</div><button disabled={status.spinning} onClick={(e) => { e.stopPropagation(); setStatus(p=>({...p, bet: Math.max(1, p.bet + (p.bet<10?1:p.bet<100?10:100))})); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 active:scale-90 transition-transform"><Plus size={12} /></button></div>
                                    <button onClick={() => startSpin()} disabled={status.spinning && !status.auto} className="w-16 h-16 rounded-full bg-gradient-to-b from-[#f59e0b] to-[#b45309] border-2 border-[#451a03] shadow-xl flex items-center justify-center active:scale-95 transition-transform hover:brightness-110 group shrink-0"><RotateCw className={status.spinning ? "animate-spin text-[#451a03]" : "hidden"} size={24} /><Play className={!status.spinning ? "fill-[#451a03] text-[#451a03] ml-1" : "hidden"} size={28} /></button>
                                </div>
                            </div>
                        </div>

                        {user.role === 'admin' && (
                            <div className={`fixed right-0 top-0 bottom-0 bg-[#121212] border-l border-[#fbbf24]/20 shadow-2xl transition-transform duration-300 flex flex-col z-[60] w-[300px] ${modals.admin ? 'translate-x-0' : 'translate-x-full'}`}>
                                <div className="h-14 shrink-0 flex items-center justify-between px-4 border-b border-white/10 bg-[#1a1a1a]"><div className="flex items-center gap-2 text-[#fbbf24] font-bold text-sm font-noto"><Settings size={16} /> ÁÆ°ÁêÜÂì°ÊéßÂà∂Âè∞</div><button onClick={() => setModals(p => ({ ...p, admin: false }))} className="text-gray-500 hover:text-white"><ChevronsRight size={20} /></button></div>
                                <div className="p-4 space-y-6 overflow-y-auto custom-scroll flex-grow font-noto">
                                    <div className="space-y-3"><h3 className="text-xs font-bold text-gray-400 uppercase flex items-center gap-2"><Zap size={12} className="text-yellow-500" /> ‰∏äÂ∏ùÊ®°Âºè</h3><div className="grid grid-cols-2 gap-2"><button disabled={status.spinning} onClick={() => startSpin('SCATTER')} className="bg-rose-900/20 hover:bg-rose-900/40 border border-rose-700/50 text-rose-400 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition-colors">FG</button><button disabled={status.spinning} onClick={() => startSpin('BIG_WIN')} className="bg-emerald-900/20 hover:bg-emerald-900/40 border border-emerald-700/50 text-emerald-400 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition-colors">WIN</button></div></div>
                                </div>
                            </div>
                        )}
                        <style>{`@keyframes laserShoot { 0% { stroke-dasharray: 0, 1000; stroke-dashoffset: 0; opacity: 0.8; } 50% { opacity: 1; stroke-width: 8; } 100% { stroke-dasharray: 1000, 0; stroke-dashoffset: 0; opacity: 0; stroke-width: 2; } } .animate-laser-shot { animation: laserShoot 0.6s ease-out forwards; }`}</style>
                        <audio ref={bgmRef} loop src="./sound/bgm.MP3" />
                    </div>
                </div>
                );
        };

        // --- 6. Admin Dashboard ËàáÂÖ∂‰ªñ ---
        const AdminDashboard = ({ users, onCreateUser, onDeleteUser, onUpdateUserBalance, config, onUpdateConfig, onLogout, onResetData }) => {
            const [activeTab, setActiveTab] = useState('config');
            const [newUser, setNewUser] = useState({ id: '', name: '', password: '', balance: 10000 });
            const [localWeights, setLocalWeights] = useState(config.symbolWeights || DEFAULT_CONFIG.symbolWeights);
            useEffect(() => { if (config.symbolWeights) setLocalWeights(config.symbolWeights); }, [config]);
            const handleWeightChange = (id, val) => { const w = { ...localWeights, [id]: Number(val) }; setLocalWeights(w); onUpdateConfig({ ...config, symbolWeights: w }); };
            const handleCreate = () => { if (!newUser.id || !newUser.name || !newUser.password) { alert("Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áÊñô"); return; } onCreateUser(newUser); setNewUser({ id: '', name: '', password: '', balance: 10000 }); };

            // [‰øÆÂæ©] Á¢∫‰øùË®àÁÆóËÆäÈáèÂú® return ‰πãÂâçÂÆ£Âëä
            const totalSymbolWeight = SYMBOLS_DEF.filter(s => s.id !== 88).reduce((acc, s) => acc + (localWeights[s.id] !== undefined ? Number(localWeights[s.id]) : 0), 0);
            const DISPLAY_MULTS = [2, 3, 4, 5, 6, 8, 10, 15, 25, 50, 100, 500];
            const totalMultWeight = DISPLAY_MULTS.reduce((acc, val) => {
                const weight = (config.multiplierWeights && config.multiplierWeights[val]) !== undefined ? Number(config.multiplierWeights[val]) : (DEFAULT_CONFIG.multiplierWeights[val] || 0);
                return acc + weight;
            }, 0);

            return (
                <div className="min-h-screen bg-[#0f0500] text-white font-noto flex">
                    <div className="w-64 bg-[#1c1917] border-r border-white/10 flex flex-col shrink-0">
                        <div className="h-16 flex items-center gap-2 px-6 border-b border-white/10 text-[#fbbf24] font-cinzel font-bold text-xl"><Settings className="text-[#fbbf24]" /> SETH ADMIN</div>
                        <nav className="flex-grow p-4 space-y-2">
                            {['config', 'users', 'data'].map(t => <button key={t} onClick={() => setActiveTab(t)} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-colors capitalize ${activeTab === t ? 'bg-[#fbbf24] text-black font-bold' : 'text-gray-400 hover:bg-white/5'}`}>{t==='config' ? <RotateCw size={18} /> : t==='users' ? <Users size={18} /> : <Database size={18} />} {t}</button>)}
                        </nav>
                        <div className="p-4 border-t border-white/10"><button onClick={onLogout} className="w-full flex items-center gap-2 px-4 py-2 text-gray-400 hover:text-white hover:bg-white/5 rounded transition-colors"><LogOut size={16} /> ÁôªÂá∫Á≥ªÁµ±</button></div>
                    </div>
                    <div className="flex-grow p-8 overflow-y-auto custom-scroll">
                        {activeTab === 'config' && (
                            <div className="max-w-5xl mx-auto">
                                <div className="mb-8">
                                    <div className="flex justify-between items-end mb-4 border-b border-white/10 pb-2"><h2 className="text-xl font-bold flex items-center gap-2 text-[#fbbf24]"><BarChart2 /> Á¨¶ËôüÊéâËêΩÊ©üÁéá</h2><div className="text-sm font-mono">Á∏ΩË®à: <span className={`${totalSymbolWeight.toFixed(1) == 100 ? 'text-green-400' : 'text-red-400'} font-bold`}>{totalSymbolWeight.toFixed(1)}%</span></div></div>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {SYMBOLS_DEF.filter(s=>s.id!==88).map(s => (
                                            <div key={s.id} className="bg-[#1c1917] p-3 rounded-lg border border-white/10 flex items-center gap-3 relative group">
                                                <div className="w-12 h-12 flex items-center justify-center shrink-0"><img src={s.icon} className="w-full h-full object-contain" /></div>
                                                <div className="flex-grow"><div className="flex justify-between mb-1"><span className="text-xs text-gray-400 font-bold uppercase">{s.name}</span><span className="text-[10px] text-gray-600 font-mono">ID:{s.id}</span></div><div className="relative"><input type="number" min="0" max="100" step="0.1" value={localWeights[s.id]!==undefined?localWeights[s.id]:0} onChange={(e) => handleWeightChange(s.id, e.target.value)} className="w-full bg-black border border-white/20 rounded px-2 py-1 text-[#fbbf24] font-mono font-bold text-sm outline-none pr-6" /><span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs">%</span></div></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="mb-8 bg-[#1c1917] p-6 rounded-lg border border-rose-900/30">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-rose-400 border-b border-white/10 pb-2"><Activity /> ÈÅäÊà≤ÁØÄÂ•è (RTP)</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        {['emptySpinProbability', 'smashProbability'].map(k => (
                                            <div key={k}><label className="text-sm text-gray-300 mb-2 block">{k}</label><div className="flex items-center gap-2"><input type="number" step="0.01" min="0" max="1" value={config[k]!==undefined?config[k]:(k==='smashProbability'?0.3:0.2)} onChange={e => onUpdateConfig({ ...config, [k]: Number(e.target.value) })} className="flex-grow bg-black border border-white/20 rounded px-3 py-2 text-rose-400 font-mono font-bold outline-none" /><span className="text-xs text-gray-500 w-12 text-right">{Math.round((config[k]||0.2)*100)}%</span></div></div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between items-end mb-4 border-b border-white/10 pb-2"><h2 className="text-xl font-bold flex items-center gap-2 text-purple-400"><Zap /> ÂÄçÊï∏ÁêÉÊ©üÁéá</h2><div className="text-sm font-mono">Total: <span className={`${totalMultWeight.toFixed(1) == 100 ? 'text-green-400' : 'text-red-400'} font-bold`}>{totalMultWeight.toFixed(1)}%</span></div></div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {DISPLAY_MULTS.map(val => (
                                            <div key={val} className="bg-[#1c1917] p-3 rounded-lg border border-purple-900/30 flex flex-col gap-2"><div className="flex justify-between items-center"><span className="text-lg font-black text-white">{val}x</span></div><div className="relative"><input type="number" min="0" max="100" step="0.1" value={config.multiplierWeights?.[val]!==undefined?config.multiplierWeights[val]:(DEFAULT_CONFIG.multiplierWeights[val]||0)} onChange={(e) => onUpdateConfig({ ...config, multiplierWeights: { ...(config.multiplierWeights||DEFAULT_CONFIG.multiplierWeights), [val]: Number(e.target.value) } })} className="w-full bg-black border border-white/20 rounded px-2 py-1 text-purple-400 font-mono font-bold outline-none pr-6" /><span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs">%</span></div></div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'users' && (
                            <div className="space-y-8 max-w-5xl mx-auto">
                                <div className="glass-panel p-6 rounded-xl"><h3 className="text-lg font-bold text-[#fbbf24] mb-4 flex items-center gap-2"><PlusCircle size={18} /> ÂâµÂª∫Êñ∞Áé©ÂÆ∂</h3><div className="grid grid-cols-4 gap-4"><input placeholder="Â∏≥Ëôü" value={newUser.id} onChange={e => setNewUser({ ...newUser, id: e.target.value })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white outline-none" /><input placeholder="Êö±Á®±" value={newUser.name} onChange={e => setNewUser({ ...newUser, name: e.target.value })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white outline-none" /><input placeholder="ÂØÜÁ¢º" type="password" value={newUser.password} onChange={e => setNewUser({ ...newUser, password: e.target.value })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white outline-none" /><div className="flex gap-2"><input type="number" placeholder="È§òÈ°ç" value={newUser.balance} onChange={e => setNewUser({ ...newUser, balance: Number(e.target.value) })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white outline-none w-full" /><button onClick={handleCreate} className="bg-[#fbbf24] text-black font-bold px-4 rounded hover:bg-[#f59e0b] whitespace-nowrap">ÂâµÂª∫</button></div></div></div>
                                <div className="glass-panel p-6 rounded-xl"><h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Users size={18} /> Áé©ÂÆ∂ÂàóË°®</h3><table className="w-full text-sm text-left"><thead className="text-xs text-gray-400 uppercase bg-black/30"><tr><th className="px-4 py-3">Â∏≥Ëôü</th><th className="px-4 py-3">Êö±Á®±</th><th className="px-4 py-3">È§òÈ°ç</th><th className="px-4 py-3">Êìç‰Ωú</th></tr></thead><tbody className="divide-y divide-white/10">{users.filter(u => u.role !== 'admin').map(u => (<tr key={u.id} className="hover:bg-white/5"><td className="px-4 py-3 font-mono">{u.id}</td><td className="px-4 py-3">{u.name}</td><td className="px-4 py-3"><input type="number" value={u.balance} onChange={(e) => onUpdateUserBalance(u.id, Number(e.target.value))} className="bg-transparent border border-transparent hover:border-white/20 focus:border-[#fbbf24] rounded px-2 py-1 outline-none font-mono text-[#fbbf24] w-32" /></td><td className="px-4 py-3"><button onClick={() => onDeleteUser(u.id)} className="text-red-400 hover:text-red-300 flex items-center gap-1"><Trash2 size={14} /> Âà™Èô§</button></td></tr>))}</tbody></table></div>
                            </div>
                        )}
                        {activeTab === 'data' && (
                            <div className="glass-panel p-6 rounded-xl max-w-lg mx-auto mt-10"><h3 className="text-lg font-bold text-red-400 mb-4 flex items-center gap-2"><Trash2 size={18} /> Âç±Èö™ÂçÄÂüü</h3><p className="text-gray-400 text-sm mb-6">ÈªûÊìä‰∏ãÊñπÊåâÈàïÂ∞áÊ∏ÖÈô§ÊâÄÊúâÈõ≤Á´ØÊï∏Êìö„ÄÇ</p><button onClick={onResetData} className="bg-red-900/50 border border-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded w-full flex items-center justify-center gap-2 transition-colors"><RefreshCw size={18} /> ÈáçÁΩÆÊâÄÊúâÊï∏Êìö</button></div>
                        )}
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, loading, isConfigured }) => {
            const [id, setId] = useState(''); const [pass, setPass] = useState('');
            if (!isConfigured) return <div className="fixed inset-0 w-full h-full bg-black flex items-center justify-center text-white p-8"><div className="max-w-lg text-center space-y-4"><AlertTriangle className="w-16 h-16 text-yellow-500 mx-auto" /><h1 className="text-2xl font-bold">Â∞öÊú™ËÆæÂÆö Firebase</h1></div></div>;
            return (
                <div className="fixed inset-0 w-full h-full bg-[#0f0500] flex items-center justify-center p-4 font-noto">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#2d1b0e_0%,_#0f0500_100%)] z-0 opacity-50"></div>
                    <div className="w-full max-w-md bg-[#1c1917] border border-[#fbbf24]/30 p-8 rounded-2xl shadow-2xl relative z-10">
                        <div className="text-center mb-8"><h1 className="text-3xl font-cinzel font-bold text-[#fbbf24] tracking-widest mb-2 flex items-center justify-center gap-2">SETH II <Cloud size={20} className="text-blue-400" /></h1><p className="text-gray-500 text-sm tracking-wide">CLOUD CASINO SYSTEM</p></div>
                        <form onSubmit={e => { e.preventDefault(); onLogin(id, pass); }} className="space-y-6">
                            <div><label className="block text-xs text-gray-400 uppercase mb-2 font-bold">User ID</label><div className="relative"><User className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} /><input value={id} onChange={e => setId(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-3 pl-10 pr-4 text-white focus:border-[#fbbf24] outline-none" /></div></div>
                            <div><label className="block text-xs text-gray-400 uppercase mb-2 font-bold">Password</label><div className="relative"><Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} /><input type="password" value={pass} onChange={e => setPass(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-3 pl-10 pr-4 text-white focus:border-[#fbbf24] outline-none" /></div></div>
                            <button disabled={loading} type="submit" className="w-full bg-gradient-to-r from-[#b45309] to-[#fbbf24] text-black font-bold py-3 rounded-lg hover:shadow-[0_0_15px_rgba(251,191,36,0.4)] transition-all flex items-center justify-center gap-2">{loading ? <Loader2 className="animate-spin" /> : <><LogIn size={18} /> ÁôªÂÖ•Á≥ªÁµ±</>}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const SethCasinoCloud = () => {
            const [userAuth, setUserAuth] = useState(null);
            const [usersData, setUsersData] = useState([]);
            const [configData, setConfigData] = useState(DEFAULT_CONFIG);
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [permErr, setPermErr] = useState(false);

            useEffect(() => { if (!isConfigured) return; signInAnonymously(auth); onAuthStateChanged(auth, setUserAuth); }, []);
            useEffect(() => {
                if (!userAuth) return;
                const unsubUsers = onSnapshot(collection(db, 'apps', APP_ID, COL_USERS), s => {
                    const list = []; s.forEach(d => list.push(d.data()));
                    if (!list.length) DEFAULT_USERS.forEach(u => setDoc(doc(db, 'apps', APP_ID, COL_USERS, u.id), u));
                    setUsersData(list); setLoading(false);
                }, e => { if (e.code === 'permission-denied') setPermErr(true); });
                const unsubConfig = onSnapshot(doc(db, 'apps', APP_ID, COL_CONFIG, 'main'), d => { if (d.exists()) setConfigData(d.data()); else setDoc(doc(db, 'apps', APP_ID, COL_CONFIG, 'main'), DEFAULT_CONFIG); }, e => { if (e.code === 'permission-denied') setPermErr(true); });
                return () => { unsubUsers(); unsubConfig(); };
            }, [userAuth]);

            const handleLogin = (id, pass) => { const u = usersData.find(u => u.id === id && u.password === pass); if (u) setCurrentUser(u); else alert("Â∏≥ËôüÂØÜÁ¢ºÈåØË™§"); };
            useEffect(() => { if (currentUser) { const u = usersData.find(u => u.id === currentUser.id); if (u) setCurrentUser(p => ({ ...p, ...u })); } }, [usersData]);

            return (
                <>
                    <PermissionErrorModal isOpen={permErr} />
                    {!currentUser && <LoginScreen onLogin={handleLogin} loading={loading} isConfigured={isConfigured} />}
                    {currentUser?.role === 'admin' && (
                        <div className="relative w-full h-full">
                            <AdminDashboard users={usersData} onCreateUser={(u)=>setDoc(doc(db,'apps',APP_ID,COL_USERS,u.id),{...u,role:'player'})} onDeleteUser={(id)=>alert("Ë´ãËá≥FirebaseÂà™Èô§")} onUpdateUserBalance={(id,b)=>setDoc(doc(db,'apps',APP_ID,COL_USERS,id),{...usersData.find(u=>u.id===id),balance:b})} config={configData} onUpdateConfig={(c)=>setDoc(doc(db,'apps',APP_ID,COL_CONFIG,'main'),c)} onLogout={()=>setCurrentUser(null)} onResetData={()=>{if(confirm("ÈáçÁΩÆ?")){setDoc(doc(db,'apps',APP_ID,COL_CONFIG,'main'),DEFAULT_CONFIG);DEFAULT_USERS.forEach(u=>setDoc(doc(db,'apps',APP_ID,COL_USERS,u.id),u));alert("Â∑≤ÈáçÁΩÆ");}}} />
                            <div className="fixed bottom-6 right-6"><button onClick={() => setCurrentUser({ ...currentUser, playing: true })} className="bg-[#1c1917] border border-[#fbbf24] text-[#fbbf24] px-4 py-2 rounded-full shadow-xl hover:bg-[#fbbf24] hover:text-black font-bold transition-colors flex items-center gap-2 animate-pulse"><Play size={16} /> ÈÄ≤ÂÖ•ÈÅäÊà≤Ê∏¨Ë©¶</button></div>
                            {currentUser.playing && <div className="fixed inset-0 z-[100]"><GameEngine user={currentUser} globalConfig={configData} onLogout={() => setCurrentUser({ ...currentUser, playing: false })} onUpdateBalance={(val) => setDoc(doc(db, 'apps', APP_ID, COL_USERS, currentUser.id), { ...currentUser, balance: val })} /></div>}
                        </div>
                    )}
                    {currentUser?.role === 'player' && <GameEngine user={currentUser} globalConfig={configData} onLogout={() => setCurrentUser(null)} onUpdateBalance={(val) => setDoc(doc(db, 'apps', APP_ID, COL_USERS, currentUser.id), { ...currentUser, balance: val })} />}
                </>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SethCasinoCloud />);
    </script>
</body>

</html>