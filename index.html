<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seth Casino II - V2.1 Stable</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+TC:wght@400;700&family=Roboto+Condensed:wght@700&family=Rye&display=swap"
        rel="stylesheet">

    <!-- ä¼˜åŒ–1: èµ„æºé¢„åŠ è½½ - æå‰åŠ è½½å…³é”®èµ„æºä»¥æå‡æ€§èƒ½ -->
    <link rel="preload" href="./images/man.png" as="image">
    <link rel="preload" href="./images/woman.png" as="image">
    <link rel="preload" href="./images/10.png" as="image">
    <link rel="preload" href="./sound/bgm.MP3" as="audio">
    <link rel="preload" href="./sound/sprint.mp3" as="audio">
    <link rel="preload" href="./sound/clear.mp3" as="audio">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            /* [ä¼˜åŒ–] ç§»åŠ¨ç«¯æ ¸å¿ƒï¼šç¦æ­¢åŒå‡»ç¼©æ”¾ï¼Œæ¶ˆé™¤ç‚¹å‡»å»¶è¿Ÿï¼Œæå‡æ‰‹æ„Ÿ */
            touch-action: manipulation; 
            /* [ä¼˜åŒ–] ç¦æ­¢ iOS é•¿æŒ‰å¼¹å‡ºèœå• */
            -webkit-touch-callout: none;
            /* [ä¼˜åŒ–] ç¦æ­¢ç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–°/æ©¡çš®ç­‹æ•ˆæœï¼Œä¿æŒAPPä½“éªŒ */
            overscroll-behavior: none;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .font-roboto {
            font-family: 'Roboto Condensed', sans-serif;
        }

        .font-noto {
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* é»ƒé‡‘å­—é«” */
        .font-egyptian-gold {
            font-family: 'Rye', cursive;
            background: linear-gradient(to bottom, #fff7ed 20%, #fbbf24 45%, #d97706 75%, #78350f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-text-stroke: 1.5px #290d02;
            text-shadow: 0 2px 0 #451a03, 0 4px 4px rgba(0, 0, 0, 0.8), 0 0 15px rgba(251, 191, 36, 0.3);
        }

        .font-gold-3d {
            font-family: 'Rye', serif;
            background: linear-gradient(180deg, #fffbeb 10%, #fbbf24 45%, #d97706 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            -webkit-text-stroke: 1.5px #451a03;
            filter: drop-shadow(0 2px 0 #451a03) drop-shadow(0 4px 2px rgba(0, 0, 0, 0.5));
            font-weight: normal;
        }

        /* æ»¾å‹•æ¢ */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #0f0500;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        /* ------------------------------------------------
       A. ä¸‹è½èˆ‡ä½ç§»å‹•ç•« (Drop Animations)
       ------------------------------------------------ */

        /* 1. é‡åŠ›ä¸‹è½ (æ–°åœ–æ¡ˆ) */
        @keyframes fallingDown {
            0% {
                transform: translateY(-500%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

.animate-heavy-drop {
            animation: fallingDown calc(0.5s / var(--speed-factor, 1)) ease-out both;
        }

        /* 2. å¹¸å­˜è€…çŸ­è·ç¦»æ»‘è½ (èˆŠåœ–æ¡ˆ) */
        @keyframes survivorDrop {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(0);
            }
        }

        .animate-survivor-drop {
            animation: survivorDrop calc(0.4s / var(--speed-factor, 1)) cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        /* ------------------------------------------------
       B. æ¶ˆé™¤å‹•ç•« (Elimination: 2s åŠƒåœˆ + çˆ†é–ƒ)
       ------------------------------------------------ */

        /* 1. å®¹å™¨å‹•ç•« (é‚Šæ¡†ç™¼å…‰ - å›ºå®šå¤§å°) */
        @keyframes borderGlowEffect {
            0% {
                border-color: transparent;
                background: rgba(46, 16, 101, 0.3);
                box-shadow: none;
                z-index: 50;
                transform: scale(1);
            }

            10% {
                /* åˆå§‹äº®èµ·ï¼šé’è‰²é›»å…‰ + ç¶ å…‰å¡«å…… */
                border-color: #e0ffff;
                background: rgba(0, 255, 200, 0.1);
                box-shadow: inset 0 0 10px #00ffea, inset 0 0 40px rgba(0, 255, 100, 0.6), 0 0 15px #00ffea;
                opacity: 1;
            }

            37.5% {
                /* ä¸­é–“é–ƒç™½ï¼šé…åˆåœ–æ¡ˆé«˜äº® */
                border-color: #ffffff;
                background: rgba(255, 255, 255, 0.3);
                box-shadow: inset 0 0 30px #ffffff, 0 0 40px #ffffff;
            }

            75% {
                /* æ­¸ä½ç‹€æ…‹ï¼šæ¢å¾©é’ç¶ å…‰ */
                border-color: #e0ffff;
                background: rgba(0, 255, 200, 0.1);
                box-shadow: inset 0 0 10px #00ffea, inset 0 0 40px rgba(0, 255, 100, 0.6), 0 0 15px #00ffea;
                transform: scale(1);
                opacity: 1;
            }

            90% {
                /* çˆ†ç‚¸è“„åŠ› */
                border-color: #ffffff;
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 0 60px #ffffff, inset 0 0 60px #ffffff;
                transform: scale(1.05);
                /* è¼•å¾®æ”¾å¤§ï¼Œå¢åŠ è¡æ“Šæ³¢ */
            }

            100% {
                /* çˆ†ç‚¸çµæŸï¼šé‚Šæ¡†æ¶ˆå¤±ä½†ä¸æ”¾å¤§ */
                border-color: #ffffff;
                background: transparent;
                box-shadow: 0 0 100px transparent;
                transform: scale(1);
                opacity: 0;
            }
        }

        /* 2. åœ–æ¡ˆå‹•ç•« (3DåŠƒåœˆ -> æ­¸ä½ -> çˆ†ç‚¸) */
        @keyframes symbolRotateScale {
            0% {
                transform: perspective(500px) translate3d(0, 0, 0) rotateY(0deg) scale(1);
                filter: brightness(1);
            }

            /* å‘å·¦å‰åŠƒåœˆ (æ”¾å¤§) */
            20% {
                transform: perspective(500px) translate3d(-10%, 0, 0) rotateY(-30deg) scale(1.02);
                filter: brightness(1.1);
            }

            /* ä¸­é–“ï¼šæœ€å¤§æ”¾å¤§ + é–ƒç™½é«˜äº® (1.5s ç¸½æ™‚é•·ä¸­çš„ 0.75s é») */
            37.5% {
                transform: perspective(500px) translate3d(0, 0, 30px) rotateY(0deg) scale(1.08);
                filter: brightness(1.4) contrast(1.2) drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            }

            /* å‘å³å‰åŠƒåœˆ */
            55% {
                transform: perspective(500px) translate3d(10%, 0, 0) rotateY(30deg) scale(1.02);
                filter: brightness(1.1);
            }

            /* å®Œç¾æ­¸ä½ (1.5s) */
            75% {
                transform: perspective(500px) translate3d(0, 0, 0) rotateY(0deg) scale(1);
                filter: brightness(1);
                opacity: 1;
            }

            /* è“„åŠ›å¾Œç¸® */
            85% {
                transform: perspective(500px) translate3d(0, 0, -30px) rotateY(0deg) scale(0.95);
                filter: brightness(2) contrast(1.5);
            }

            /* çˆ†ç‚¸ */
            100% {
                transform: perspective(500px) translate3d(0, 0, 80px) rotateY(0deg) scale(2);
                filter: brightness(5) blur(20px);
                opacity: 0;
            }
        }

.animate-eliminate-shake {
            /* [ç¸½æ™‚é•·] 2ç§’ -> åŠ¨æ€å€é€Ÿ */
            animation: borderGlowEffect calc(2s / var(--speed-factor, 1)) cubic-bezier(0.4, 0, 0.2, 1) forwards;
            border-width: 4px;
            border-style: solid;
            box-sizing: border-box;
        }

        .animate-eliminate-shake img,
        .animate-eliminate-shake>div {
            /* [ç¸½æ™‚é•·] 2ç§’ (å¿…é ˆåŒæ­¥) -> åŠ¨æ€å€é€Ÿ */
            animation: symbolRotateScale calc(2s / var(--speed-factor, 1)) cubic-bezier(0.4, 0, 0.2, 1) forwards;
            will-change: transform, filter, opacity;
        }

        /* ------------------------------------------------
       C. äººç‰©æ–½æ³•å‹•ä½œ (Character Casting)
       ------------------------------------------------ */
        @keyframes characterCastAction {
            0% {
                transform: translateY(-50%) scale(1);
                filter: brightness(1) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            }

            20% {
                transform: translateY(-50%) scale(1.1);
                filter: brightness(1.3) contrast(1.1) drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
            }

            100% {
                transform: translateY(-50%) scale(1);
                filter: brightness(1) drop-shadow(0 10px 20px rgba(0, 0, 0, 0.8));
            }
        }

        .animate-character-cast {
            animation: characterCastAction calc(0.8s / var(--speed-factor, 1)) ease-out forwards;
            z-index: 20 !important;
        }
        /* ------------------------------------------------
       D. é–ƒé›»èˆ‡è¡æ“Šæ³¢ (Lightning & Impact)
       ------------------------------------------------ */
        @keyframes fallingLightningBolt {
            0% {
                opacity: 0;
                transform: translateY(-100%) scaleX(0.2);
            }

            15% {
                opacity: 1;
                transform: translateY(0) scaleX(1);
                filter: brightness(2.5);
            }

            60% {
                opacity: 1;
                transform: translateY(0) scaleX(1);
                filter: brightness(2.5);
            }

            100% {
                opacity: 0;
                transform: translateY(0) scaleX(0);
            }
        }

        @keyframes impactShockwave {
            0% {
                opacity: 0;
                transform: scale(0.2);
            }

            15% {
                opacity: 1;
                transform: scale(1.45);
                background: radial-gradient(circle, #ffffff 20%, #00eaff 80%, #0044aa 100%);
                box-shadow: 0 0 40px #00eaff, inset 0 0 20px #ffffff;
                filter: brightness(2.5);
                z-index: 90;
            }

            60% {
                opacity: 1;
                transform: scale(1.45);
                filter: brightness(1.8);
            }

            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

/* é–ƒé›»å…‰æŸå®¹å™¨ */
        .lightning-bolt-container {
            position: absolute;
            top: -100%;
            bottom: 50%;
            left: 40%;
            right: 40%;
            z-index: 95;
            pointer-events: none;
            background: linear-gradient(to bottom, transparent 0%, rgba(0, 68, 170, 0.8) 70%, #00eaff 90%, #ffffff 100%);
            filter: drop-shadow(0 0 10px #00eaff) blur(3px) brightness(2.5);
            border-radius: 0 0 100px 100px;
            animation: fallingLightningBolt calc(0.8s / var(--speed-factor, 1)) ease-out forwards;
        }

        /* è¡æ“Šæ³¢å®¹å™¨ */
        .lightning-impact-cell {
            position: absolute;
            inset: 0;
            z-index: 90;
            pointer-events: none;
            border-radius: 50%;
            filter: blur(3px);
            animation: impactShockwave calc(0.8s / var(--speed-factor, 1)) ease-out forwards;
        }

        /* ------------------------------------------------
       E. å…¶ä»–é€šç”¨å‹•ç•« (Misc / Legacy)
       ------------------------------------------------ */
        @keyframes floatGroupWin {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -150%) scale(1.5);
                opacity: 1;
                text-shadow: 0 0 20px gold;
            }

            80% {
                transform: translate(-50%, -200%) scale(1.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -300%) scale(1);
                opacity: 0;
            }
        }

        @keyframes winPulse {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.15);
                filter: brightness(1.3) drop-shadow(0 0 10px gold);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        @keyframes spinButtonPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(147, 51, 234, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
            }
        }

        /* ------------------------------------------------
           F. ç²’å­ç³»çµ±å‡çº§ (Visual Upgrade: 3D Coins & Sparks)
           ------------------------------------------------ */
        @keyframes coinFall3D {
            0% { transform: translate3d(0, -100px, 0) rotateX(0) rotateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translate3d(0, 0, 0) rotateX(45deg) rotateY(180deg) scale(1); }
            100% { transform: translate3d(0, 110vh, 0) rotateX(360deg) rotateY(1080deg) scale(1); opacity: 0; }
        }

        @keyframes sparkBurst {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0); opacity: 0; }
        }

        .coin-particle {
            position: fixed;
            top: 0; left: 0;
            width: 40px; height: 40px;
            /* é«˜çº§è´¨æ„Ÿæ¸å˜ */
            background: radial-gradient(circle at 30% 30%, #fff7ed, #ffd700, #b45309);
            border-radius: 50%;
            border: 2px solid #fbbf24;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,215,0,0.8);
            z-index: 9999;
            pointer-events: none;
            will-change: transform;
            /* è‡ªåŠ¨é€‚é…å€é€Ÿå˜é‡ */
            animation: coinFall3D calc(var(--duration, 3s) / var(--speed-factor, 1)) linear forwards;
            animation-delay: calc(var(--delay, 0s) / var(--speed-factor, 1));
        }
        /* é‡‘å¸çº¹ç† */
        .coin-particle::after {
            content: '$';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #92400e;
            font-size: 24px;
            opacity: 0.8;
        }

        .click-particle {
            position: fixed;
            width: 6px; height: 6px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #fbbf24;
            z-index: 99999;
            pointer-events: none;
            /* ç‚¹å‡»ç«èŠ±åŠ¨ç”» */
            animation: sparkBurst calc(0.6s / var(--speed-factor, 1)) ease-out forwards;
        }
        /* ------------------------------------------------
           G. èƒŒæ™¯å‘¼å¸å…‰æ•ˆ (Background Breathing Light)
           ------------------------------------------------ */
        @keyframes bgBreathingAnim {
            0% { opacity: 0.2; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0.2; transform: translate(-50%, -50%) scale(0.8); }
        }

        .bg-breathing-light {
            position: absolute;
            top: 50%; left: 50%;
            width: 120vmax; height: 120vmax; /* è¦†ç›–å…¨å± */
            background: radial-gradient(circle, rgba(251, 191, 36, 0.15) 0%, rgba(180, 83, 9, 0.05) 40%, transparent 70%);
            pointer-events: none;
            z-index: 5; /* ä½äºèƒŒæ™¯(0)ä¹‹ä¸Šï¼Œäººç‰©(10)ä¹‹ä¸‹ */
            mix-blend-mode: screen; /* æ··åˆæ¨¡å¼äº§ç”Ÿå‘å…‰æ„Ÿ */
            will-change: transform, opacity;
            /* è‡ªåŠ¨é€‚é…å€é€Ÿï¼šåŸºå‡†å‘¼å¸å‘¨æœŸ 5ç§’ */
            animation: bgBreathingAnim calc(5s / var(--speed-factor, 1)) infinite ease-in-out;
        }

        #error-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            color: #ff5555;
            padding: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <div id="error-overlay"></div>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const overlay = document.getElementById('error-overlay');
            overlay.style.display = 'block';
            overlay.innerHTML += `<strong>Error:</strong> ${msg}\nAt: ${url}:${lineNo}:${columnNo}\n\n${error ? error.stack : ''}\n----------------\n`;
            return false;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';

        import {
            User, Lock, LogIn, Users, Settings, Play, Plus, Minus,
            RotateCw, Zap, X, Save, LogOut, Terminal, ChevronsRight, Smartphone,
            Trophy, Flame, Trash2, PlusCircle, RefreshCw, Database,
            Activity, BarChart2, Hash, Cpu, Cloud, Loader2, AlertTriangle, Copy,
            ShoppingCart, Coins, Volume2, VolumeX

        } from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ---------------------------------------------------------
        // CONFIGURATION
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyD5a41T_dk-k8iEIxaoAQcET5noB6Zy0ko",
            authDomain: "aiapp-93616.firebaseapp.com",
            projectId: "aiapp-93616",
            storageBucket: "aiapp-93616.firebasestorage.app",
            messagingSenderId: "144618205398",
            appId: "1:144618205398:web:f27098e35e4f5424279977",
            measurementId: "G-67RXLTP8QN"
        };

        const APP_ID = 'seth-casino-v1';

        const spawnCoins = (amount = 20) => {
            const body = document.body;
            for (let i = 0; i < amount; i++) {
                const coin = document.createElement('div');
                coin.className = 'coin-particle';
                
                // éšæœºåŒ–å‚æ•°
                const x = Math.random() * 100; // 0-100vw
                const duration = Math.random() * 2 + 2; // 2-4ç§’
                const delay = Math.random() * 0.5; // 0-0.5ç§’å»¶è¿Ÿ
                
                coin.style.left = `${x}vw`;
                coin.style.setProperty('--duration', `${duration}s`);
                coin.style.setProperty('--delay', `${delay}s`);
                
                body.appendChild(coin);
                // å»¶æ—¶ç§»é™¤ (ç»™è¶³å¤Ÿçš„æ—¶é—´é˜²æ­¢åŠ¨ç”»è¢«åˆ‡æ–­)
                setTimeout(() => coin.remove(), (duration + delay + 1) * 1000);
            }
        };

        // [æ–°å¢] å…¨å±€ç‚¹å‡»/è§¦æ‘¸ç²’å­ç‰¹æ•ˆ
        window.addEventListener('pointerdown', (e) => {
            const count = 8; // æ¯æ¬¡ç‚¹å‡»äº§ç”Ÿçš„ç«èŠ±æ•°é‡
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.className = 'click-particle';
                p.style.left = e.clientX + 'px';
                p.style.top = e.clientY + 'px';
                
                // éšæœºæ•£å°„æ–¹å‘
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 60 + 20; // æ‰©æ•£è·ç¦»
                const tx = Math.cos(angle) * dist + 'px';
                const ty = Math.sin(angle) * dist + 'px';
                
                p.style.setProperty('--tx', tx);
                p.style.setProperty('--ty', ty);
                
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        });

        // ---------------------------------------------------------
        // REFACTORED AUDIO SYSTEM (SINGLE CONTEXT)
        // ---------------------------------------------------------
        // ä¿®å¾©é‡é»ï¼šå»ºç«‹å”¯ä¸€çš„ globalAudioCtxï¼Œé¿å…é‡è¤‡å‰µå»ºå°è‡´è¨˜æ†¶é«”æ´©æ¼å’Œå¡é “
        let globalAudioCtx = null;

        const initAudio = () => {
            if (!globalAudioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    globalAudioCtx = new AudioContext();
                }
            }
            if (globalAudioCtx && globalAudioCtx.state === 'suspended') {
                globalAudioCtx.resume();
            }
        };

        const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";

        let app, auth, db;
        try {
            if (isConfigured) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const COL_USERS = 'users';
        const COL_CONFIG = 'config';
        const ROWS = 5;
        const COLS = 6;

        // [ä¿®æ”¹] ç¬¦è™Ÿå®šç¾©ï¼šæ·»åŠ  scale å±¬æ€§ä¾†æ§åˆ¶å€‹åˆ¥åœ–ç‰‡å¤§å°
        const SYMBOLS_DEF = [
            // ID 99: Scatter (æœ¬èº«å·²æœ‰ç‰¹æ®Šæ¸²æŸ“ï¼Œé€™è£¡çš„ scale å½±éŸ¿ä¸å¤§ï¼Œä½†å¯ä»¥åŠ )
            { id: 99, type: 'scatter', icon: './images/10.png', name: 'Scatter', scale: 1 },

            // ID 88: å€æ•¸çƒ (ç‰¹æ®Šæ¸²æŸ“ï¼Œå¿½ç•¥ scale)
            { id: 88, type: 'mult', icon: 'ğŸ’', color: 'text-green-400', name: 'Multiplier' },

            // æ™®é€šç¬¦è™Ÿç¯„ä¾‹ï¼š
            // è®“é«˜è³ ç‡çš„ç¬¦è™Ÿç¨å¾®å¤§ä¸€é»ï¼Œä½è³ ç‡çš„å°ä¸€é»
            { id: 9, type: 'normal', icon: './images/9.png', payout: { 12: 50, 10: 25, 8: 10 }, name: 'Eye', scale: 1 },
            { id: 8, type: 'normal', icon: './images/8.png', payout: { 12: 25, 10: 10, 8: 2.5 }, name: 'Snake', scale: 1 },
            { id: 7, type: 'normal', icon: './images/7.png', payout: { 12: 15, 10: 5, 8: 2 }, name: 'Bow', scale: 1 },
            { id: 6, type: 'normal', icon: './images/6.png', payout: { 12: 12, 10: 2, 8: 1.5 }, name: 'Blade', scale: 1 }, // é»˜èª 1.0
            { id: 5, type: 'normal', icon: './images/5.png', payout: { 12: 10, 10: 1.5, 8: 1 }, name: 'Gold', scale: 0.7 },
            { id: 4, type: 'normal', icon: './images/4.png', payout: { 12: 8, 10: 1.2, 8: 0.8 }, name: 'Red', scale: 0.7 }, // ç¨å°
            { id: 3, type: 'normal', icon: './images/3.png', payout: { 12: 5, 10: 1, 8: 0.5 }, name: 'Purple', scale: 0.7 },
            { id: 2, type: 'normal', icon: './images/2.png', payout: { 12: 4, 10: 0.9, 8: 0.4 }, name: 'Blue', scale: 0.7 },
            { id: 1, type: 'normal', icon: './images/1.png', payout: { 12: 2, 10: 0.75, 8: 0.25 }, name: 'Green', scale: 0.7 }, // ç¸®å°
        ];

        // [ä¿®æ”¹] å°‡æ¬Šé‡é è¨­å€¼æ”¹ç‚ºç™¾åˆ†æ¯”æ ¼å¼ (ç¸½å’Œå»ºè­°ç‚º 100)
        const DEFAULT_CONFIG = {
            tableCount: 12,            // [æ–°å¢] é»˜è®¤å¼€æ”¾æ¡Œå°æ•°é‡
            emptySpinProbability: 0.2, // å¼·åˆ¶ç©ºè½‰ç‡
            smashProbability: 0.3,     // ç ¸çƒæ©Ÿç‡

            // ç¬¦è™Ÿå‡ºç¾æ©Ÿç‡ (ç¸½å’Œ 100%)
            // ID 1-5 (ä½åˆ†): å„ 15%
            // ID 6-7 (ä¸­åˆ†): å„ 8%
            // ID 8-9 (é«˜åˆ†): å„ 3.5%
            // ID 99 (Scatter): 2%
            // ID 88 (å€æ•¸çƒ): å·²ç§»é™¤ï¼Œç”±ç ¸çƒé‚è¼¯æ§åˆ¶
            symbolWeights: {
                1: 15, 2: 15, 3: 15, 4: 15, 5: 15,
                6: 8, 7: 8, 8: 3.5, 9: 3.5,
                99: 2
            },

            // å€æ•¸çƒæ•¸å€¼æ©Ÿç‡ (ç¸½å’Œ 100%)
            // ç•¶ç«çƒç ¸ä¸­æ™‚ï¼Œè®Šèº«ç‚ºè©²å€æ•¸çš„æ©Ÿç‡
            multiplierWeights: {
                2: 40,   // 40% æ©Ÿç‡æ˜¯ 2x
                3: 25,
                4: 15,
                5: 15,
                6: 15,
                8: 10,
                10: 5,
                15: 3,
                25: 15,
                100: 1.5,
                500: 0.5 // 0.5% æ©Ÿç‡æ˜¯ 500x
            }
        };

        const DEFAULT_USERS = [
            { id: 'admin', name: 'ç³»çµ±ç®¡ç†å“¡', password: 'admin', role: 'admin', balance: 0 },
            { id: 'player1', name: 'æ¸¬è©¦ç©å®¶ä¸€è™Ÿ', password: '1234', role: 'player', balance: 50000 },
        ];

        // ---------------------------------------------------------
        // æ ¸å¿ƒé‚è¼¯é‡æ•´ï¼šæ¬Šé‡èˆ‡ç›¤é¢ç”Ÿæˆ
        // ---------------------------------------------------------

        // 1. è®€å–ç¬¦è™Ÿæ¬Šé‡ (å·²éæ¿¾ ID 88)
        const getWeightsFromConfig = (cfg) => {
            const c = cfg || DEFAULT_CONFIG;
            const weights = [];
            // å…¼å®¹èˆŠç‰ˆèˆ‡æ–°ç‰ˆçµæ§‹
            const sourceWeights = c.symbolWeights || DEFAULT_CONFIG.symbolWeights;

            for (const [idStr, weight] of Object.entries(sourceWeights)) {
                const id = Number(idStr);
                // [å®‰å…¨] å¼·åˆ¶éæ¿¾ ID 88ï¼Œé˜²æ­¢ç”Ÿæˆå‡½æ•¸å¡æ­»
                if (id === 88) continue;
                weights.push({ id: id, weight: Number(weight) });
            }

            // [é˜²å‘†] å¦‚æœæ¬Šé‡å…¨ç©ºï¼Œå›å‚³é è¨­ ID 1
            if (weights.length === 0) return [{ id: 1, weight: 100 }];

            return weights;
        };

        // 2. è®€å–å€æ•¸æ¬Šé‡
        const getMultWeightsFromConfig = (cfg) => {
            const c = cfg || DEFAULT_CONFIG;
            if (!c.multiplierWeights) {
                return Object.entries(DEFAULT_CONFIG.multiplierWeights).map(([val, weight]) => ({ val: Number(val), weight }));
            }
            return Object.entries(c.multiplierWeights).map(([val, weight]) => ({ val: Number(val), weight: Number(weight) }));
        };

        // 3. ç²å–éš¨æ©Ÿç¬¦è™Ÿ (åŸºç¤å‡½æ•¸)
        const getRandomSymbolData = (currentConfig) => {
            const weights = getWeightsFromConfig(currentConfig);
            const totalWeight = weights.reduce((acc, w) => acc + w.weight, 0);
            let random = Math.random() * totalWeight;
            let selectedId = 1; // é è¨­å€¼

            for (let w of weights) {
                random -= w.weight;
                if (random <= 0) { selectedId = w.id; break; }
            }

            // å¾å®šç¾©æª”æ‰¾è³‡æ–™ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±å›å‚³ ID 1 (é˜²å´©æ½°)
            const base = SYMBOLS_DEF.find(s => s.id === selectedId) || SYMBOLS_DEF[0];
            return { ...base };
        };

        // --- [æ–°å¢] å¹³å‡åˆ†å¸ƒç¬¦å·ç”Ÿæˆ (Uniform Random) ---
        const getUniformSymbol = () => {
            // 1. ç­›é€‰å‡ºæ‰€æœ‰å…è®¸æ‰è½çš„ç¬¦å· (æ’é™¤ ID 88)
            const validSymbols = SYMBOLS_DEF.filter(s => s.id !== 88);

            // 2. ç­‰æ¦‚ç‡éšæœºæŠ½å– (1 / N)
            const randIndex = Math.floor(Math.random() * validSymbols.length);

            // 3. è¿”å›ç¬¦å·æ•°æ®çš„å‰¯æœ¬
            return { ...validSymbols[randIndex] };
        };

        // 4. [å¿…è¾“] ç”Ÿæˆå¿…è¾“ç›˜é¢ (ä¿®æ­£ç‰ˆï¼šä¸¥æ ¼é™åˆ¶ Scatter < 3 ä»¥é˜² Retrigger)
        const generateLosingGrid = (cfg) => {
            const grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            const counts = {};

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let sym;
                    let isValid = false;
                    let attempts = 0;

                    while (attempts < 20) {
                        sym = getUniformSymbol();

                        const id = sym.id;
                        const currentCount = counts[id] || 0;

                        // [å…³é”®ä¿®æ”¹] Scatter é™åˆ¶
                        // ä¹‹å‰æ˜¯ 3ï¼Œä¼šå¯¼è‡´ç”Ÿæˆ 3 ä¸ª (0,1,2é€šè¿‡)ã€‚
                        // ç°åœ¨æ”¹ä¸º 2ï¼Œç¡®ä¿æœ€å¤šç”Ÿæˆ 2 ä¸ª (åªæœ‰0,1é€šè¿‡ï¼Œ2ä¸é€šè¿‡)ã€‚
                        let countLimit = (id === 99) ? 2 : 7;

                        // é‚»å±…é¿è®©
                        const left = c > 0 ? grid[r][c - 1] : null;
                        const top = r > 0 ? grid[r - 1][c] : null;

                        if (currentCount < countLimit) {
                            if ((left && left.id === id) || (top && top.id === id)) {
                                isValid = false;
                            } else {
                                isValid = true;
                            }
                        }

                        if (isValid) break;
                        attempts++;
                    }

                    if (!isValid) {
                        let safeId = 1;
                        const leftId = c > 0 ? grid[r][c - 1]?.id : -1;
                        const topId = r > 0 ? grid[r - 1][c]?.id : -1;
                        while (safeId === leftId || safeId === topId) safeId++;
                        const base = SYMBOLS_DEF.find(s => s.id === safeId) || SYMBOLS_DEF[0];
                        sym = { ...base };
                    }

                    counts[sym.id] = (counts[sym.id] || 0) + 1;
                    grid[r][c] = sym;
                }
            }
            return grid;
        };

        // 5. [å¿…èƒœ] ç”Ÿæˆå¿…èƒœç›˜é¢ (ä¿®æ­£ç‰ˆï¼šå…è®¸ FG Retriggerï¼Œä½†é™åˆ¶å¹²æ‰°)
        const generateWinningGrid = (cfg) => {
            const grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            const usedPos = new Set();

            // 1. å†³å®šä¸­å¥–ä¸»è§’
            let targetSym = null;
            let safety = 0;
            do {
                const candidate = getRandomSymbolData(cfg);
                // åªè¦ä¸æ˜¯ ID 88ï¼Œéƒ½å¯ä»¥å½“ä¸­å¥–ä¸»è§’ (åŒ…å« Scatter)
                if (candidate && candidate.id !== 88) {
                    targetSym = candidate;
                }
                safety++;
            } while (!targetSym && safety < 20);

            if (!targetSym) targetSym = { ...SYMBOLS_DEF.find(s => s.id === 1) };

            const isWinFG = (targetSym.id === 99);
            const targetId = targetSym.id;

            // 2. å†³å®šæ•°é‡
            let winCount = 0;
            if (isWinFG) {
                // å¦‚æœè´çš„æ˜¯ Scatter (Retrigger)ï¼Œçµ¦ 4 å€‹ (æˆ–è€… 3 å€‹ä¹Ÿè¡Œï¼Œé€™è£¡çµ¦ 4 å€‹è¼ƒç©©)
                winCount = 4;
            } else {
                // å¦‚æœæ˜¯æ™®é€šè¿çº¿ï¼Œç»™ 8~9 ä¸ª
                winCount = Math.floor(Math.random() * 2) + 8;
            }

            // 3. æ”¾ç½®ä¸­å¥–ç¬¦å·
            let placed = 0;
            while (placed < winCount) {
                const r = Math.floor(Math.random() * ROWS);
                const c = Math.floor(Math.random() * COLS);
                const key = `${r}-${c}`;
                if (!usedPos.has(key)) {
                    grid[r][c] = { ...targetSym };
                    usedPos.add(key);
                    placed++;
                }
            }

            // 4. å¡«å……å‰©ä¸‹çš„æ ¼å­
            const currentCounts = {};
            currentCounts[targetId] = winCount;

            // ç»Ÿè®¡ç›®å‰ Scatter æ•°é‡
            let scatterCount = isWinFG ? 4 : 0;

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (!grid[r][c]) {
                        let filler;
                        let subSafety = 0;
                        do {
                            // å¡«å……æ—¶ä½¿ç”¨æƒé‡éšæœº (æˆ–æ‚¨æƒ³ç”¨ getUniformSymbol ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œç»´æŒæƒé‡è¾ƒè‡ªç„¶)
                            filler = getRandomSymbolData(cfg);
                            subSafety++;

                            // è§„åˆ™ A: ä¸å« ID 88
                            if (filler.id === 88) { filler = null; continue; }
                            // è§„åˆ™ B: ä¸å«ä¸»è§’ (é¿å…å¢åŠ è¿çº¿æ•°)
                            if (filler.id === targetId) { filler = null; continue; }

                            // è§„åˆ™ C: Scatter é™åˆ¶
                            if (filler.id === 99) {
                                // å…³é”®ï¼šå¦‚æœè¿™å±€ä¸æ˜¯èµ¢ FGï¼Œç»å¯¹ä¸èƒ½å‡‘é½ 3 ä¸ª
                                // å¦‚æœæ˜¯èµ¢ FGï¼Œå·²ç»æ”¾äº† 4 ä¸ªï¼Œä¹Ÿä¸èƒ½å†å¤šäº†
                                const limit = isWinFG ? 4 : 2;
                                if (scatterCount >= limit) { filler = null; continue; }
                            } else {
                                if ((currentCounts[filler.id] || 0) >= 7) { filler = null; continue; }
                            }
                        } while (!filler && subSafety < 15);

                        if (!filler) {
                            let safeId = 1;
                            if (targetId === 1) safeId = 2;
                            filler = { ...SYMBOLS_DEF.find(s => s.id === safeId) };
                        }

                        if (filler.id === 99) scatterCount++;
                        currentCounts[filler.id] = (currentCounts[filler.id] || 0) + 1;
                        grid[r][c] = filler;
                    }
                }
            }
            return grid;
        };

        // 6. [éš¨æ©Ÿ] ç´”éš¨æ©Ÿç”Ÿæˆ (åŠ å…¥å…¨å±€ Scatter æ•¸é‡é™åˆ¶)
        const generateGridData = (cfg) => {
            let scatterCount = 0;
            return Array(ROWS).fill(null).map(() =>
                Array(COLS).fill(null).map(() => {
                    let sym;
                    let safety = 0;
                    do {
                        sym = getRandomSymbolData(cfg);
                        if (sym.id === 88) sym = { ...SYMBOLS_DEF.find(s => s.id === 1) };

                        // [é—œéµ] ç¡¬ä¸Šé™æª¢æŸ¥
                        if (sym.id === 99 && scatterCount >= 4) {
                            // å·²é”ä¸Šé™ï¼Œé‡æŠ½ç›´åˆ°ä¸æ˜¯ Scatter
                            sym = null;
                        }
                        safety++;
                    } while (!sym && safety < 10);

                    if (!sym) sym = { ...SYMBOLS_DEF.find(s => s.id === 1) };
                    if (sym.id === 99) scatterCount++;

                    return sym;
                })
            );
        };

        // 7. [ä½œå¼Š] God Mode ç”Ÿæˆ
        const generateRiggedGrid = (cfg, type) => {
            let grid = generateGridData(cfg); // ä½¿ç”¨ç´”éš¨æ©Ÿç‚ºåº•
            if (type === 'SCATTER') {
                let positions = [];
                while (positions.length < 4) {
                    let r = Math.floor(Math.random() * ROWS);
                    let c = Math.floor(Math.random() * COLS);
                    if (!positions.some(p => p.r === r && p.c === c)) positions.push({ r, c });
                }
                positions.forEach(p => {
                    grid[p.r][p.c] = { ...SYMBOLS_DEF.find(s => s.id === 99) };
                });
            } else if (type === 'BIG_WIN') {
                // å¼·åˆ¶æ”¾ 12 å€‹ ID 9 (Eye)
                let count = 0;
                const target = SYMBOLS_DEF.find(s => s.id === 9);
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (Math.random() > 0.4 && count < 12) {
                            grid[r][c] = { ...target };
                            count++;
                        }
                    }
                }
            }
            return grid;
        };

        const getPayout = (id, count) => {
            const s = SYMBOLS_DEF.find(sym => sym.id === id);
            if (!s || !s.payout) return 0;
            if (count >= 12) return s.payout[12];
            if (count >= 10) return s.payout[10];
            if (count >= 8) return s.payout[8];
            return 0;
        };

        function PermissionErrorModal({ isOpen }) {
            if (!isOpen) return null;
            const rules = `rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}`;
            return (
                <div className="fixed inset-0 z-[9999] bg-black/95 flex items-center justify-center p-4 font-noto">
                    <div className="bg-[#1c1917] border border-red-500 w-full max-w-2xl rounded-xl shadow-2xl p-6 text-white">
                        <h2 className="text-2xl font-bold text-red-500 mb-4">Permission Denied</h2>
                        <p className="mb-4 text-gray-300">è«‹è‡³ Firebase Console è¨­å®š Firestore Rules:</p>
                        <pre className="bg-black p-4 rounded text-green-400 text-xs font-mono overflow-auto">{rules}</pre>
                        <button onClick={() => window.location.reload()} className="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded w-full">é‡æ•´é é¢</button>
                    </div>
                </div>
            );
        }

        function BuyBonusModal({ isOpen, onClose, bet, onBuy, playSound = () => { } }) {
            if (!isOpen) return null;
            const cost = bet * 100;

            return (
                <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 font-noto animate-bounce-drop">
                    <div className="bg-gradient-to-b from-[#2d1b0e] to-[#0f0500] border-2 border-[#fbbf24] w-full max-w-sm rounded-xl shadow-[0_0_50px_rgba(251,191,36,0.3)] p-6 text-center relative">
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><X size={24} /></button>

                        <h2 className="text-2xl font-black text-[#fbbf24] mb-2 font-cinzel tracking-widest">BUY FREE SPINS</h2>
                        <p className="text-gray-400 text-xs mb-6">æ”¯ä»˜ 100 å€ä¸‹æ³¨é¡ï¼Œç›´æ¥è§¸ç™¼å…è²»éŠæˆ²ï¼</p>

                        <div className="flex items-center justify-center gap-4 mb-6">
                            <div className="text-right">
                                <div className="text-[10px] text-gray-500 uppercase">Cost</div>
                                <div className="text-2xl font-mono text-white font-bold">${cost.toLocaleString()}</div>
                            </div>
                            <div className="text-4xl">â”</div>
                            <div className="text-left">
                                <div className="text-[10px] text-gray-500 uppercase">Get</div>
                                <div className="text-2xl font-black text-rose-500 flex items-center gap-1"><Trophy size={24} /> 15 SPINS</div>
                            </div>
                        </div>

                        <button onClick={() => { playSound('click'); onBuy(cost); }} className="w-full bg-gradient-to-r from-[#b45309] to-[#fbbf24] hover:brightness-110 text-black font-black py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95">
                            <ShoppingCart size={20} /> ç¢ºèªè³¼è²· (${cost})
                        </button>
                    </div>
                </div>
            );
        }

        function BigWinOverlay({ winAmount, onClose }) {
            const [displayWin, setDisplayWin] = useState(0);

            useEffect(() => {
                spawnCoins(50);
                let start = 0;
                const duration = 2000;
                const startTime = performance.now();

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 3);

                    setDisplayWin(Math.floor(winAmount * ease));

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                requestAnimationFrame(animate);
            }, [winAmount]);

            return (
                <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in duration-300" onClick={onClose}>
                    <div className="text-center relative">
                        <div className="absolute inset-0 bg-[#fbbf24] blur-[100px] opacity-20 rounded-full animate-pulse"></div>
                        <h1 className="text-6xl md:text-8xl font-black text-[#fbbf24] font-cinzel tracking-tighter mb-4 drop-shadow-[0_5px_0_rgba(0,0,0,1)] animate-text-zoom">
                            BIG WIN
                        </h1>
                        <div className="text-4xl md:text-6xl font-mono font-bold text-white drop-shadow-lg">
                            {displayWin.toLocaleString()}
                        </div>
                        <p className="text-gray-400 mt-8 animate-pulse">é»æ“Šä»»æ„è™•é—œé–‰ / Tap to Continue</p>
                    </div>
                </div>
            );
        }

        // ------------------------------------------------------------
        // 3. çœŸå®é€»è¾‘ RTP æ¨¡æ‹Ÿå™¨ (ä¸­æ–‡ä»‹é¢ç‰ˆ)
        // ------------------------------------------------------------
        function SimulatorModal({ isOpen, onClose, config }) {
            const [simCount, setSimCount] = useState(1000);
            const [inputCount, setInputCount] = useState("1000");
            const [isRunning, setIsRunning] = useState(false);
            const [progress, setProgress] = useState(0);
            const [stats, setStats] = useState(null);

            // è¾…åŠ©ï¼šæ·±æ‹·è´ Grid
            const cloneGrid = (g) => g.map(row => row.map(c => ({ ...c })));

            // --- ç¿»è­¯å°ç…§è¡¨ (ç”¨æ–¼è´åˆ†åˆ†ä½ˆ) ---
            const labelMap = {
                "Zero": "æœªä¸­ç (0)",
                "0-1x": "å°ç (0-1å€)",
                "1-10x": "æ™®é€š (1-10å€)",
                "10-50x": "å¤§ç (10-50å€)",
                "50-100x": "å·¨ç (50-100å€)",
                "100x+": "è¶…å·¨ç (100å€+)"
            };

            const runSim = async () => {
                if (simCount <= 0) return;
                setIsRunning(true); setProgress(0); setStats(null);

                const totalRuns = simCount;
                const bet = 100;
                const BATCH_SIZE = 100;

                const tempStats = {
                    runs: 0, totalBet: 0, totalWin: 0, maxWin: 0,
                    fgCount: 0, baseGameEmptyCount: 0, smashCount: 0, multCounts: {},
                    winDistribution: { "Zero": 0, "0-1x": 0, "1-10x": 0, "10-50x": 0, "50-100x": 0, "100x+": 0 }
                };

                // ... (æ¨¡æ“¬å–®å±€çš„æ ¸å¿ƒé‚è¼¯ simulateRound ä¿æŒå®Œå…¨ä¸è®Š) ...
                const simulateRound = (initialGrid, isFG, currentAccMult = 0) => {
                    let grid = cloneGrid(initialGrid);
                    let roundTotalWin = 0;
                    let active = true;
                    let loops = 0;
                    let triggerFG = false;
                    let retriggerFG = false;

                    const smashRate = config.smashProbability !== undefined ? config.smashProbability : 0.3;
                    const emptyRate = config.emptySpinProbability !== undefined ? config.emptySpinProbability : 0.2;
                    let localAccMult = currentAccMult;

                    while (active && loops < 20) {
                        loops++;
                        // 1. ç ¸çƒ
                        const shouldSmash = Math.random() < smashRate;
                        const candidates = [];
                        for (let r = 0; r < ROWS; r++) { for (let c = 0; c < COLS; c++) { if (grid[r][c] && grid[r][c].id <= 9) candidates.push({ r, c }); } }

                        if (shouldSmash && candidates.length > 0) {
                            tempStats.smashCount++;
                            const t = candidates[Math.floor(Math.random() * candidates.length)];
                            const multWeights = getMultWeightsFromConfig(config);
                            const totalMW = multWeights.reduce((a, w) => a + w.weight, 0);
                            let randomM = Math.random() * totalMW;
                            let selectedVal = 2;
                            for (let w of multWeights) { randomM -= w.weight; if (randomM <= 0) { selectedVal = w.val; break; } }
                            tempStats.multCounts[selectedVal] = (tempStats.multCounts[selectedVal] || 0) + 1;
                            grid[t.r][t.c] = { id: 88, type: 'mult', val: selectedVal, name: 'Multiplier', icon: 'ğŸ’' };
                        }

                        // 2. æ¶ˆé™¤
                        const counts = {};
                        grid.flat().forEach(c => { if (c && c.type === 'normal') counts[c.id] = (counts[c.id] || 0) + 1; });
                        const wins = Object.keys(counts).filter(id => counts[id] >= 8);
                        const scatters = grid.flat().filter(c => c && c.id === 99).length;
                        if (!isFG && scatters >= 4) triggerFG = true;
                        if (isFG && scatters >= 3) retriggerFG = true;

                        if (wins.length === 0) { active = false; break; }

                        let batchWin = 0;
                        wins.forEach(id => { batchWin += bet * getPayout(Number(id), counts[id]); });
                        roundTotalWin += batchWin;

                        const eliminatedSet = new Set();
                        wins.forEach(targetId => {
                            for (let r = 0; r < ROWS; r++) { for (let c = 0; c < COLS; c++) { if (grid[r][c] && String(grid[r][c].id) === String(targetId)) { eliminatedSet.add(`${r}-${c}`); } } }
                        });

                        // 3. æ‰è½
                        const nextGrid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
                        const isNextDropEmpty = Math.random() < emptyRate;
                        let predictedScatterCount = 0;
                        for (let r = 0; r < ROWS; r++) { for (let c = 0; c < COLS; c++) { if (grid[r][c] && grid[r][c].id === 99 && !eliminatedSet.has(`${r}-${c}`)) { predictedScatterCount++; } } }

                        let forceWinCol = -1;
                        let forceWinSymbol = null;
                        if (!isNextDropEmpty) {
                            forceWinCol = Math.floor(Math.random() * COLS);
                            let s = getUniformSymbol();
                            if (s.id > 9) s = { ...SYMBOLS_DEF.find(sym => sym.id === 1) };
                            forceWinSymbol = s;
                        }

                        for (let c = 0; c < COLS; c++) {
                            let colData = [];
                            for (let r = 0; r < ROWS; r++) { if (grid[r][c] && !eliminatedSet.has(`${r}-${c}`)) { colData.push(grid[r][c]); } }

                            // ... (å‰ç•¥: Step 3 æ‰è½è£œæ»¿çš„é–‹é ­) ...
                            // B. è£œæ»¿æ–°çƒ
                            // ... (å‰ç•¥: æ¨¡æ“¬å™¨ Step 3 æ‰è½è£œæ»¿) ...
                            // è¡¥æ»¡æ–°çƒ
                            let dropIndex = 0;
                            while (colData.length < ROWS) {
                                let sym;

                                // [åˆ†æ”¯ A] å¼ºåˆ¶ä¸­å¥–
                                if (!isNextDropEmpty && c === forceWinCol && dropIndex < 3) {
                                    sym = { ...forceWinSymbol };
                                }
                                // [åˆ†æ”¯ B] å¼ºåˆ¶ç©ºè½¬ / æ™®é€šå¡«å……
                                else {
                                    let safety = 0;
                                    do {
                                        // -----------------------------------------------------
                                        // [æ ¸å¿ƒä¿®æ”¹] æ¨¡æ“¬å™¨åŒæ­¥ï¼šæ··åˆæ©Ÿç‡ç”Ÿæˆ
                                        // -----------------------------------------------------
                                        const scatterProb = config.symbolWeights?.[99] !== undefined ? config.symbolWeights[99] : 2;
                                        const isScatterRoll = (Math.random() * 100) < scatterProb;

                                        if (isScatterRoll) {
                                            sym = { ...SYMBOLS_DEF.find(s => s.id === 99) };
                                        } else {
                                            // æ™®é€šç¬¦è™Ÿ ID 1-9 å¹³å‡åˆ†ä½ˆ
                                            const normalSymbols = SYMBOLS_DEF.filter(s => s.id >= 1 && s.id <= 9);
                                            const randIdx = Math.floor(Math.random() * normalSymbols.length);
                                            sym = { ...normalSymbols[randIdx] };
                                        }

                                        // éæ¿¾ ID 88
                                        if (sym.id === 88) sym = { ...SYMBOLS_DEF.find(s => s.id === 1) };

                                        // éæ¿¾ Scatter ç¡¬ä¸Šé™
                                        if (sym.id === 99 && predictedScatterCount >= 4) {
                                            const normalSymbols = SYMBOLS_DEF.filter(s => s.id >= 1 && s.id <= 9);
                                            const randIdx = Math.floor(Math.random() * normalSymbols.length);
                                            sym = { ...normalSymbols[randIdx] };
                                        }

                                        // é˜²é€£ç·šæª¢æŸ¥
                                        if (isNextDropEmpty && colData.length > 0) {
                                            const lastSym = colData[0];
                                            if (lastSym.id === sym.id) {
                                                sym = null;
                                            }
                                        }
                                        safety++;
                                    } while (!sym && safety < 10);

                                    if (!sym) sym = { ...SYMBOLS_DEF.find(s => s.id === 1) };
                                }

                                if (sym.id === 99) predictedScatterCount++;
                                colData.unshift(sym);
                                dropIndex++;
                            }
                            for (let r = 0; r < ROWS; r++) nextGrid[r][c] = colData[r];
                        }
                        grid = nextGrid;
                    }

                    const mults = grid.flat().filter(c => c && c.id === 88);
                    const totalMult = mults.reduce((a, b) => a + b.val, 0);
                    let finalWin = 0;
                    if (isFG) {
                        if (roundTotalWin > 0) {
                            localAccMult += totalMult;
                            finalWin = roundTotalWin * (localAccMult > 0 ? localAccMult : 1);
                        }
                    } else {
                        finalWin = roundTotalWin * (totalMult > 0 ? totalMult : 1);
                    }
                    return { win: finalWin, triggerFG, retriggerFG, newAccMult: localAccMult };
                };

                setTimeout(() => {
                    let currentRun = 0;
                    const processBatch = () => {
                        const end = Math.min(currentRun + BATCH_SIZE, totalRuns);
                        while (currentRun < end) {
                            currentRun++;
                            tempStats.runs++;
                            tempStats.totalBet += bet;

                            const emptyRate = config.emptySpinProbability !== undefined ? config.emptySpinProbability : 0.2;
                            const isForcedEmpty = Math.random() < emptyRate;

                            let baseGrid;
                            if (isForcedEmpty) {
                                baseGrid = generateLosingGrid(config);
                                tempStats.baseGameEmptyCount++;
                            } else {
                                baseGrid = generateWinningGrid(config);
                            }

                            const baseResult = simulateRound(baseGrid, false, 0);
                            let totalSpinWin = baseResult.win;

                            if (baseResult.triggerFG) {
                                tempStats.fgCount++;
                                let spins = 15;
                                let fgAccMult = 0;
                                while (spins > 0) {
                                    spins--;
                                    const isFgEmpty = Math.random() < emptyRate;
                                    let fgGrid = isFgEmpty ? generateLosingGrid(config) : generateWinningGrid(config, true);
                                    const fgResult = simulateRound(fgGrid, true, fgAccMult);
                                    totalSpinWin += fgResult.win;
                                    fgAccMult = fgResult.newAccMult;
                                    if (fgResult.retriggerFG) spins += 5;
                                }
                            }

                            tempStats.totalWin += totalSpinWin;
                            if (totalSpinWin > tempStats.maxWin) tempStats.maxWin = totalSpinWin;

                            const x = totalSpinWin / bet;
                            if (x === 0) tempStats.winDistribution["Zero"]++;
                            else if (x < 1) tempStats.winDistribution["0-1x"]++;
                            else if (x < 10) tempStats.winDistribution["1-10x"]++;
                            else if (x < 50) tempStats.winDistribution["10-50x"]++;
                            else if (x < 100) tempStats.winDistribution["50-100x"]++;
                            else tempStats.winDistribution["100x+"]++;
                        }
                        setProgress(Math.round((currentRun / totalRuns) * 100));
                        if (currentRun < totalRuns) { setTimeout(processBatch, 0); }
                        else { setStats(tempStats); setIsRunning(false); }
                    };
                    processBatch();
                }, 100);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[150] bg-black/95 backdrop-blur flex items-center justify-center p-4 font-noto overflow-y-auto">
                    <div className="bg-[#1c1917] border border-[#fbbf24] w-full max-w-4xl rounded-xl p-6 relative my-8">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={24} /></button>
                        <h2 className="text-2xl font-bold text-[#fbbf24] mb-6 flex items-center gap-2">
                            <Activity /> çœŸå¯¦é‚è¼¯æ¨¡æ“¬å™¨ (True Logic Simulator)
                        </h2>

                        {/* æ§åˆ¶å€ */}
                        <div className="flex gap-4 mb-6 items-end">
                            <div className="flex-grow">
                                <label className="text-xs text-gray-400 font-bold uppercase block mb-1">æ¨¡æ“¬å±€æ•¸ (Run Count)</label>
                                <div className="flex gap-2">
                                    <input type="number" value={inputCount} onChange={e => { setInputCount(e.target.value); setSimCount(Number(e.target.value)); }} className="flex-grow bg-black border border-white/20 rounded px-3 py-2 text-white font-mono outline-none focus:border-[#fbbf24]" />
                                    <button onClick={() => { setInputCount("1000"); setSimCount(1000) }} className="px-3 border border-white/10 rounded hover:bg-white/5 text-gray-300">1K</button>
                                    <button onClick={() => { setInputCount("10000"); setSimCount(10000) }} className="px-3 border border-white/10 rounded hover:bg-white/5 text-gray-300">10K</button>
                                </div>
                            </div>
                            <button onClick={runSim} disabled={isRunning} className={`px-8 py-2 h-[42px] rounded font-bold text-black transition-colors flex items-center gap-2 ${isRunning ? 'bg-gray-600' : 'bg-[#fbbf24] hover:bg-[#f59e0b]'}`}>
                                {isRunning ? <Loader2 className="animate-spin" /> : <Play size={18} />} {isRunning ? 'è¨ˆç®—ä¸­...' : 'é–‹å§‹æ¨¡æ“¬'}
                            </button>
                        </div>

                        {/* é€²åº¦æ¢ */}
                        {isRunning && (
                            <div className="mb-6">
                                <div className="flex justify-between text-xs text-gray-400 mb-1"><span>é€²åº¦ (Progress)</span><span>{progress}%</span></div>
                                <div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-[#fbbf24]" style={{ width: `${progress}%` }}></div></div>
                            </div>
                        )}

                        {/* å„€è¡¨æ¿ */}
                        {stats && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <div className="text-xs text-gray-500 uppercase font-bold">RTP (å›å ±ç‡)</div>
                                        <div className={`text-3xl font-bold font-mono ${stats.totalWin / stats.totalBet > 1 ? 'text-red-500' : 'text-emerald-500'}`}>
                                            {((stats.totalWin / stats.totalBet) * 100).toFixed(2)}%
                                        </div>
                                    </div>
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <div className="text-xs text-gray-500 uppercase font-bold">æœ€å¤§è´åˆ† (Max Win)</div>
                                        <div className="text-3xl font-bold font-mono text-[#fbbf24]">x{(stats.maxWin / 100).toFixed(0)}</div>
                                    </div>
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <div className="text-xs text-gray-500 uppercase font-bold">FG è§¸ç™¼ç‡</div>
                                        <div className="text-xl font-mono text-white">1 / {stats.fgCount > 0 ? Math.round(stats.runs / stats.fgCount) : '-'}</div>
                                        <div className="text-xs text-gray-600">è§¸ç™¼æ¬¡æ•¸: {stats.fgCount}</div>
                                    </div>
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <div className="text-xs text-gray-500 uppercase font-bold">å¯¦æ¸¬ç©ºè½‰ç‡</div>
                                        <div className="text-xl font-mono text-rose-400">{((stats.baseGameEmptyCount / stats.runs) * 100).toFixed(1)}%</div>
                                        <div className="text-xs text-gray-600">ç›®æ¨™è¨­å®š: {((config.emptySpinProbability || 0.2) * 100).toFixed(0)}%</div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* è´åˆ†åˆ†ä½ˆ */}
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <h3 className="text-sm font-bold text-gray-300 mb-4 border-b border-white/10 pb-2">è´åˆ†åˆ†ä½ˆ (Win Distribution)</h3>
                                        <div className="space-y-2 text-xs">
                                            {Object.entries(stats.winDistribution).map(([range, count]) => (
                                                <div key={range} className="flex items-center gap-2">
                                                    <span className="w-24 text-gray-400">{labelMap[range] || range}</span>
                                                    <div className="flex-grow h-4 bg-gray-800 rounded overflow-hidden relative">
                                                        <div className="h-full bg-blue-600" style={{ width: `${(count / stats.runs) * 100}%` }}></div>
                                                        <span className="absolute inset-0 flex items-center justify-start px-2 text-[10px] text-white drop-shadow">
                                                            {count} ({((count / stats.runs) * 100).toFixed(1)}%)
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* æ©Ÿåˆ¶çµ±è¨ˆ */}
                                    <div className="bg-black/40 p-4 rounded border border-white/10">
                                        <h3 className="text-sm font-bold text-gray-300 mb-4 border-b border-white/10 pb-2">ç ¸çƒèˆ‡å€æ•¸çµ±è¨ˆ</h3>
                                        <div className="mb-4 flex justify-between text-xs">
                                            <span>ç ¸çƒç¸½æ•¸: <span className="text-purple-400 font-bold">{stats.smashCount}</span></span>
                                            <span>é »ç‡: å¹³å‡æ¯ {(stats.runs / stats.smashCount).toFixed(1)} å±€ä¸€æ¬¡</span>
                                        </div>
                                        <div className="grid grid-cols-4 gap-2 text-center">
                                            {Object.entries(stats.multCounts).sort((a, b) => Number(a[0]) - Number(b[0])).map(([mult, count]) => (
                                                <div key={mult} className="bg-white/5 rounded p-1 border border-white/5">
                                                    <div className="text-[#fbbf24] font-bold">{mult}x</div>
                                                    <div className="text-[10px] text-gray-400">{count}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
           );
        }

// --- [ä¿®æ”¹] ç©å®¶æ•°æ®é¢æ¿ (å«è¯¦ç»† FG ç»Ÿè®¡) ---
        function PlayerStatsModal({ isOpen, onClose, history, globalStats }) {
            if (!isOpen) return null;
            
            const calcRTP = (win, bet) => bet > 0 ? ((win / bet) * 100).toFixed(2) : "0.00";
            const tableTodayRTP = calcRTP(globalStats.todayWin || 0, globalStats.todayBet || 0);
            const tableMonthRTP = calcRTP(globalStats.totalWin || 0, globalStats.totalBet || 0);

            // FG ç»Ÿè®¡è®¡ç®—
            const totalSpins = globalStats.totalSpins || 0;
            const fgCount = globalStats.fgCount || 0;
            // å¹³å‡å¤šå°‘è½¬è¿›ä¸€æ¬¡ = æ€»è½¬æ•° / FGæ¬¡æ•°
            const avgFG = fgCount > 0 ? Math.round(totalSpins / fgCount) : 0;
            
            // å†å²è®°å½•
            const fgHist = globalStats.fgHistory || [];
            const last1 = fgHist.length > 0 ? fgHist[fgHist.length - 1] : '-';
            const last2 = fgHist.length > 1 ? fgHist[fgHist.length - 2] : '-';

            return (
                <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 font-noto animate-in fade-in" onClick={onClose}>
                    <div className="bg-[#1c1917] border border-[#fbbf24] w-full max-w-lg rounded-lg p-4 md:p-6 relative shadow-2xl max-h-[90vh] overflow-y-auto custom-scroll" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={24} /></button>
                        <h2 className="text-xl font-bold text-[#fbbf24] mb-6 flex items-center gap-2"><BarChart2 /> æœ¬æ¡Œæ•°æ® (Table Stats)</h2>
                        
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-black/40 p-3 rounded border border-white/10 text-center">
                                <div className="text-xs text-gray-500 uppercase font-bold mb-1">æœ¬æ¡Œä»Šæ—¥ RTP</div>
                                <div className={`text-3xl font-mono font-black ${Number(tableTodayRTP) >= 100 ? 'text-rose-500' : 'text-emerald-400'}`}>{tableTodayRTP}%</div>
                                <div className="text-[10px] text-gray-500">Bet: {(globalStats.todayBet || 0).toLocaleString()}</div>
                            </div>
                            <div className="bg-black/40 p-3 rounded border border-white/10 text-center">
                                <div className="text-xs text-gray-500 uppercase font-bold mb-1">æœ¬æ¡Œ30æ—¥ RTP</div>
                                <div className={`text-3xl font-mono font-black ${Number(tableMonthRTP) >= 100 ? 'text-rose-500' : 'text-blue-400'}`}>{tableMonthRTP}%</div>
                                <div className="text-[10px] text-gray-500">Bet: {(globalStats.totalBet || 0).toLocaleString()}</div>
                            </div>
                        </div>

                         {/* [æ–°å¢] è¯¦ç»† FG ç»Ÿè®¡ */}
                         <div className="bg-purple-900/20 border border-purple-500/30 p-4 rounded mb-6">
                            <div className="flex justify-between items-center mb-3 border-b border-purple-500/20 pb-2">
                                <span className="text-xs font-bold text-purple-400 uppercase">FG å¹³å‡æœºç‡</span>
                                <span className="text-xl font-mono font-bold text-white">1 / <span className="text-[#fbbf24]">{avgFG}</span></span>
                            </div>
                            <div className="flex justify-between text-xs">
                                <div className="text-center">
                                    <div className="text-gray-500 mb-1">ä¸Š1æ¬¡ FG</div>
                                    <div className="font-mono font-bold text-white bg-black/40 px-2 py-1 rounded border border-white/10">{last1} è½¬</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-gray-500 mb-1">ä¸Š2æ¬¡ FG</div>
                                    <div className="font-mono font-bold text-gray-400 bg-black/40 px-2 py-1 rounded border border-white/10">{last2} è½¬</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-gray-500 mb-1">FG æ€»æ´¾å½©</div>
                                    <div className="font-mono font-bold text-[#fbbf24]">${(globalStats.fgTotalWin || 0).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>

                        <h3 className="text-sm font-bold text-white mb-2 flex items-center gap-2"><ChevronsRight size={16} /> æœ€è¿‘æ¸¸æˆè®°å½• (Last 10)</h3>
                        <div className="bg-black/40 rounded border border-white/10 overflow-hidden h-[150px] overflow-y-auto custom-scroll">
                            <table className="w-full text-xs text-left">
                                <thead className="text-gray-400 sticky top-0 bg-[#2d2a26] z-10 shadow-md">
                                    <tr><th className="p-2">Time</th><th className="p-2">Bet</th><th className="p-2">Win</th><th className="p-2">Mult</th></tr>
                                </thead>
                                <tbody className="divide-y divide-white/5">
                                    {(!history || history.length === 0) ? 
                                        <tr><td colSpan="4" className="p-8 text-center text-gray-500 italic">æš‚æ— æ¸¸æˆè®°å½•...</td></tr> : 
                                        history.map((h, i) => (
                                        <tr key={i} className="hover:bg-white/5 transition-colors">
                                            <td className="p-2 text-gray-400 font-mono text-[10px]">{h.time}</td>
                                            <td className="p-2 font-bold text-gray-300">{h.bet}</td>
                                            <td className={`p-2 font-bold font-mono ${h.win > 0 ? 'text-[#fbbf24]' : 'text-gray-600'}`}>{h.win > 0 ? h.win.toFixed(1) : '-'}</td>
                                            <td className={`p-2 font-mono ${h.mult > 1 ? 'text-purple-400' : 'text-gray-600'}`}>{h.mult > 0 ? h.mult + 'x' : '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // ------------------------------------------------------------
        // Game Engine (æœ€ç»ˆå®Œæ•´ç‰ˆï¼šä¿®å¤éŸ³é‡å˜é‡æœªå®šä¹‰é”™è¯¯)
        // ------------------------------------------------------------
        function GameEngine({ user, globalConfig, onLogout, onUpdateBalance, tableId, onLeaveTable }) {
            const [config, setConfig] = useState(globalConfig);
            const configRef = useRef(globalConfig);

            // --- [1. æ ¸å¿ƒçŠ¶æ€] ---
            const [grid, setGrid] = useState(() => generateGridData(globalConfig).map(row => row.map(c => ({ ...c, key: Math.random().toString(36) }))));
            const [bet, setBet] = useState(10);
            const [isSpinning, setIsSpinning] = useState(false);
            const [autoSpin, setAutoSpin] = useState(false);
            const [uiState, setUiState] = useState({ currentWin: 0, totalWin: 0, winMult: 0, displayWinText: "0.00" });
            const [freeGame, setFreeGame] = useState({ active: false, spinsLeft: 0, accMult: 0, totalWin: 0 });

            // --- [2. åŠ¨ç”»ä¸ç‰¹æ•ˆçŠ¶æ€] ---
            const [eliminatingCells, setEliminatingCells] = useState(new Set());
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [lasers, setLasers] = useState([]);
            const [lightningStrikes, setLightningStrikes] = useState(new Set()); // é—ªç”µç‰¹æ•ˆ
            const [isFastDrop, setIsFastDrop] = useState(false); // è‡ªåŠ¨åŠ é€ŸçŠ¶æ€

            // --- [3. äººç‰©åŠ¨ä½œçŠ¶æ€] ---
            const [isManCasting, setIsManCasting] = useState(false);
            const [isWomanCasting, setIsWomanCasting] = useState(false);

            // --- [4. å¼¹çª—ä¸èœå•çŠ¶æ€] ---
            const [showBuyModal, setShowBuyModal] = useState(false);
            const [showBigWin, setShowBigWin] = useState(null);
            const [showSimModal, setShowSimModal] = useState(false);
            const [showFGTrigger, setShowFGTrigger] = useState(false);
            const [betMenuOpen, setBetMenuOpen] = useState(null);

            // --- [5. ç®¡ç†å‘˜ä¸æ—¥å¿—çŠ¶æ€] ---
            const [isAdminOpen, setIsAdminOpen] = useState(false);
            const [showLogger, setShowLogger] = useState(true);
            const [logs, setLogs] = useState([]);

            // --- [6. éŸ³é‡æ§åˆ¶çŠ¶æ€ (å…³é”®ä¿®å¤ç‚¹)] ---
            const [showVolumePanel, setShowVolumePanel] = useState(false);
const [bgmVolume, setBgmVolume] = useState(0.4); // éŸ³ä¹éŸ³é‡
            const [sfxVolume, setSfxVolume] = useState(0.6); // éŸ³æ•ˆéŸ³é‡
            const bgmRef = useRef(null);

            // [Speed Control]
            const [showSpeedPanel, setShowSpeedPanel] = useState(false);
            const [gameSpeed, setGameSpeed] = useState(1);

            // [Data: Real Stats] 
            const [showStatsModal, setShowStatsModal] = useState(false);
            const [globalStats, setGlobalStats] = useState({ bet: 0, win: 0 });
            const [todayStats, setTodayStats] = useState({ bet: 0, win: 0 });
            const [playHistory, setPlayHistory] = useState(user.history || []); // ä»ç”¨æˆ·æ•°æ®åˆå§‹åŒ–

            // [Listener] ç›‘å¬å…¨å±€ä¸ä»Šæ—¥æ•°æ®
            useEffect(() => {
                const todayStr = new Date().toISOString().split('T')[0];
                
                // 1. ç›‘å¬å…¨å±€å†å² (Lifetime)
                const unsubGlobal = onSnapshot(doc(db, 'apps', APP_ID, 'stats', 'global'), (doc) => {
                    if (doc.exists()) setGlobalStats(doc.data());
                    else setDoc(doc.ref, { bet: 0, win: 0 });
                });

                // 2. ç›‘å¬ä»Šæ—¥æ•°æ® (Today)
                const unsubToday = onSnapshot(doc(db, 'apps', APP_ID, 'stats', todayStr), (doc) => {
                    if (doc.exists()) setTodayStats(doc.data());
                    else setDoc(doc.ref, { bet: 0, win: 0 });
                });

                // 3. ç›‘å¬å½“å‰ç”¨æˆ·å†å²è®°å½• (Real-time update)
                const unsubUser = onSnapshot(doc(db, 'apps', APP_ID, COL_USERS, user.id), (doc) => {
                    if (doc.exists() && doc.data().history) {
                        setPlayHistory(doc.data().history);
                    }
                });

                return () => { unsubGlobal(); unsubToday(); unsubUser(); };
            }, []);

            // [DB Save] å†™å…¥ Table ç‹¬ç«‹æ•°æ® (å« FG é—´éš”ç»Ÿè®¡)
            const saveGameStats = async (betAmount, winAmount, finalMult, isFGTrigger, isFGWin) => {
                const tableRef = doc(db, 'apps', APP_ID, 'tables', `table_${tableId}`);
                const userRef = doc(db, 'apps', APP_ID, COL_USERS, user.id);
                const todayStr = new Date().toISOString().split('T')[0];

                const newRecord = { time: new Date().toLocaleTimeString('zh-TW', { hour12: false }), bet: betAmount, win: winAmount, mult: finalMult };
                
                try {
                    const tableDoc = await getDoc(tableRef);
                    let updates = {
                        totalBet: increment(betAmount),
                        totalWin: increment(winAmount),
                        lastUpdate: new Date().getTime()
                    };

                    // [æ–°å¢] ç»Ÿè®¡æ€»å±€æ•°ä¸ FG é—´éš”
                    let currentTotalSpins = 0;
                    let currentHistory = [];
                    let lastFGSpins = 0;

                    if (tableDoc.exists()) {
                        const data = tableDoc.data();
                        
                        // 1. å¤„ç†ä»Šæ—¥/è·¨å¤©
                        if (data.todayDate !== todayStr) {
                            updates.todayDate = todayStr;
                            updates.todayBet = betAmount;
                            updates.todayWin = winAmount;
                        } else {
                            updates.todayBet = increment(betAmount);
                            updates.todayWin = increment(winAmount);
                        }

                        // 2. è¯»å–ç°æœ‰ç»Ÿè®¡æ•°æ®
                        currentTotalSpins = data.totalSpins || 0;
                        currentHistory = data.fgHistory || [];
                        lastFGSpins = data.lastFGSpins || 0;
                    } else {
                        updates = { ...updates, todayDate: todayStr, todayBet: betAmount, todayWin: winAmount, fgCount: 0, fgTotalWin: 0 };
                    }

                    // 3. æ›´æ–°å±€æ•°
                    const newTotalSpins = currentTotalSpins + 1;
                    updates.totalSpins = newTotalSpins;

                    // 4. å¤„ç† FG è§¦å‘é€»è¾‘ (è®°å½•é—´éš”)
                    if (isFGTrigger) {
                        updates.fgCount = increment(1);
                        // è®¡ç®—è·ç¦»ä¸Šä¸€æ¬¡ FG è¿‡äº†å¤šå°‘è½¬
                        const gap = newTotalSpins - lastFGSpins;
                        // æ›´æ–°å†å²è®°å½• (ä¿ç•™æœ€è¿‘5æ¬¡)
                        const newHistory = [...currentHistory, gap].slice(-5);
                        
                        updates.fgHistory = newHistory;
                        updates.lastFGSpins = newTotalSpins;
                    }
                    
                    if (isFGWin) updates.fgTotalWin = increment(winAmount);

                    updateDoc(tableRef, updates).catch(() => setDoc(tableRef, { ...updates, status: 'occupied' }));
                    
                    const userDoc = await getDoc(userRef);
                    let userHistory = userDoc.exists() && userDoc.data().history ? userDoc.data().history : [];
                    updateDoc(userRef, { history: [newRecord, ...userHistory].slice(0, 10) });

                } catch (e) { console.error("Stats Save Error", e); }
            };

            // [Monitor] å®æ—¶åŒæ­¥ç›˜é¢ä¸æ¶ˆé™¤çŠ¶æ€ (å«åŠ¨ç”»æ ‡è®°)
            const syncTableGrid = (newGrid, eliminatingList = []) => {
                if (!newGrid) return;
                // [ä¼˜åŒ–] ä¼ è¾“ isNew(n) å’Œ isJustRevealed(r)ï¼Œç¡®ä¿è§‚æˆ˜ç«¯çŸ¥é“ä½•æ—¶æ’­æ”¾åŠ¨ç”»
                const simpleGrid = newGrid.flat().map(c => c ? { 
                    i: c.id, 
                    v: c.val || 0, 
                    n: c.isNew ? 1 : 0, 
                    r: c.isJustRevealed ? 1 : 0 
                } : { i: 0, v: 0 });
                
                updateDoc(doc(db, 'apps', APP_ID, 'tables', `table_${tableId}`), { 
                    monitorGrid: simpleGrid,
                    monitorEliminating: eliminatingList,
                    lastActive: new Date().getTime()
                }).catch(e => {});
            };

            // --- [7. Refs] ---
            const mounted = useRef(true);
            const autoSpinRef = useRef(false);
            const topBarRef = useRef(null);
            const audioPool = useRef({}); // éŸ³é¢‘æ± 

            // --- [8. åˆå§‹åŒ–ä¸ç›‘å¬] ---
            useEffect(() => { setConfig(globalConfig); configRef.current = globalConfig; }, [globalConfig]);
            useEffect(() => { mounted.current = true; return () => { mounted.current = false; }; }, []);

            // [Table Occupancy] æ™ºèƒ½è¿›æ¡Œ + å¿ƒè·³ä¿æ´» (ä¿®å¤æ­»é”BUG)
            useEffect(() => { 
                mounted.current = true;
                const tableRef = doc(db, 'apps', APP_ID, 'tables', `table_${tableId}`);
                let amIOccupier = false; 
                let heartbeatTimer = null;

                const enterTable = async () => {
                    try {
                        const snap = await getDoc(tableRef);
                        const d = snap.data();
                        const now = new Date().getTime();
                        
                        // [åˆ¤å®šæ‰çº¿] å¦‚æœå¯¹æ–¹æœ€åæ´»è·ƒæ—¶é—´è¶…è¿‡ 15ç§’ï¼Œè§†ä¸ºæ‰çº¿ï¼Œå…è®¸è¦†ç›–
                        const isStale = d && d.lastActive && (now - d.lastActive > 15000);
                        const isBusy = d && (d.status === 'occupied' || d.status === 'spinning') && !isStale;

                        // [è§‚æˆ˜åˆ¤æ–­] ç®¡ç†å‘˜ + æ¡Œå­çœŸå¿™(æœªæ‰çº¿) + ä¸æ˜¯è‡ªå·± -> è§‚æˆ˜
                        if (user.role === 'admin' && isBusy && d.currentUserId !== user.id) {
                            amIOccupier = false;
                            return; 
                        }

                        // [å ç”¨/æŠ¢æ¡Œ]
                        amIOccupier = true;
                        // å†™å…¥å ç”¨çŠ¶æ€å¹¶ç«‹å³æ›´æ–°å¿ƒè·³
                        const updateData = { status: 'occupied', currentUser: user.name, currentUserId: user.id, lastActive: now };
                        await updateDoc(tableRef, updateData).catch(() => setDoc(tableRef, { ...updateData, totalBet:0, totalWin:0 }));

                        // [å¯åŠ¨å¿ƒè·³] æ¯3ç§’æ›´æ–°ä¸€æ¬¡ lastActiveï¼Œè¯æ˜æˆ‘è¿˜æ´»ç€
                        heartbeatTimer = setInterval(() => {
                            if(mounted.current) updateDoc(tableRef, { lastActive: new Date().getTime() }).catch(e=>{});
                        }, 3000);

                    } catch (e) { console.error(e); }
                };
                enterTable();

                return () => { 
                    mounted.current = false;
                    if (heartbeatTimer) clearInterval(heartbeatTimer);
                    // æ­£å¸¸ç¦»å¼€æ—¶ï¼Œä¸»åŠ¨é‡Šæ”¾æ¡Œå­
                    if (amIOccupier) {
                        updateDoc(tableRef, { status: 'idle', currentUser: null, currentUserId: null });
                    }
                }; 
            }, [tableId, user.name, user.id, user.role]);

            // [Listener] ç›‘å¬æœ¬æ¡Œæ•°æ® (è§‚æˆ˜é˜²æŠ–ä¼˜åŒ–ç‰ˆ - ä¿®å¤åŠ¨ç”»å¡é¡¿)
            const [isSpectating, setIsSpectating] = useState(false);

            useEffect(() => {
                // [å…³é”®] æœ¬åœ°ç¼“å­˜ï¼Œç”¨äºæ¯”å¯¹æ•°æ®æ˜¯å¦å˜åŒ–
                let lastGridStr = ''; 

                const unsubTable = onSnapshot(doc(db, 'apps', APP_ID, 'tables', `table_${tableId}`), (docSnap) => {
                    if (docSnap.exists()) {
                         const d = docSnap.data();
                         setGlobalStats(d); // RTP æ•°æ®ç…§å¸¸æ›´æ–°ï¼Œä¸å½±å“åŠ¨ç”»

                         // [åˆ¤å®šè§‚æˆ˜]
                         const isBusy = d.status === 'occupied' || d.status === 'spinning';
                         const shouldSpectate = user.role === 'admin' && isBusy && d.currentUserId !== user.id;
                         
                         if (shouldSpectate) {
                             setIsSpectating(true);
                             const remoteSpinning = d.status === 'spinning';
                             setIsSpinning(remoteSpinning);

                             // åŒæ­¥æ¶ˆé™¤çŠ¶æ€
                             if (d.monitorEliminating) setEliminatingCells(new Set(d.monitorEliminating));
                             else setEliminatingCells(new Set());

                             // [è¿˜åŸç›˜é¢] é˜²æŠ–é€»è¾‘ï¼šåªæœ‰ Grid çœŸçš„å˜äº†æ‰é‡ç»˜
                             // è¿™èƒ½å®Œç¾è¿‡æ»¤æ‰ å¿ƒè·³(lastActive) å’Œ RTPé‡‘é¢ å˜åŒ–å¸¦æ¥çš„å¹²æ‰°
                             const currentGridStr = JSON.stringify(d.monitorGrid);
                             
                             if (d.monitorGrid && currentGridStr !== lastGridStr) {
                                 lastGridStr = currentGridStr; // æ›´æ–°ç¼“å­˜

                                 const flat = d.monitorGrid;
                                 const reconstructed = [];
                                 for(let r=0; r<5; r++) {
                                     const row = [];
                                     for(let c=0; c<6; c++) {
                                         const item = flat[r*6 + c];
                                         const id = typeof item === 'object' ? item.i : item;
                                         const val = typeof item === 'object' ? item.v : 0;
                                         // åŠ¨ç”»æ ‡è®°
                                         const isNew = typeof item === 'object' ? (item.n === 1) : false;
                                         const isRev = typeof item === 'object' ? (item.r === 1) : false;
                                         
                                         let sym = SYMBOLS_DEF.find(s => s.id === id);
                                         if(sym) {
                                             row.push({ 
                                                 ...sym, val: val, 
                                                 key: Math.random().toString(36), 
                                                 isNew: isNew, 
                                                 isJustRevealed: isRev 
                                             }); 
                                         } else { row.push(null); }
                                     }
                                     reconstructed.push(row);
                                 }
                                 setGrid(reconstructed);
                             }
                         } else {
                             setIsSpectating(false);
                             // é€€å‡ºè§‚æˆ˜æ—¶æ¸…ç†çŠ¶æ€
                             if(isSpectating) { 
                                 setIsSpinning(false); 
                                 setEliminatingCells(new Set()); 
                                 lastGridStr = ''; // é‡ç½®ç¼“å­˜
                             }
                         }
                    }
                });
                const unsubUser = onSnapshot(doc(db, 'apps', APP_ID, COL_USERS, user.id), (doc) => {
                    if (doc.exists() && doc.data().history) setPlayHistory(doc.data().history);
                });
                return () => { unsubTable(); unsubUser(); };
            }, [tableId, user.id, user.role]);

            // è‡ªåŠ¨æ—‹è½¬
            useEffect(() => {
                autoSpinRef.current = autoSpin;
                if (autoSpin && !isSpinning && !freeGame.active) {
                    const t = setTimeout(() => startSpin(), 100);
                    return () => clearTimeout(t);
                }
            }, [autoSpin, isSpinning, freeGame.active]);

            // FG è‡ªåŠ¨æ—‹è½¬
            useEffect(() => {
                if (freeGame.active && !isSpinning) {
                    if (freeGame.spinsLeft > 0) {
                        // [ä¼˜åŒ–] FG é—´éš”åŠ é€Ÿ
                        const timer = setTimeout(() => { if (mounted.current) startSpin(); }, 800 / gameSpeed);
                        return () => clearTimeout(timer);
                    } else {
                        // [ä¼˜åŒ–] FG ç»“æŸå»¶è¿ŸåŠ é€Ÿ
                        setTimeout(() => endFreeGame(), 1000 / gameSpeed);
                    }
                }
            }, [freeGame.active, freeGame.spinsLeft, isSpinning, gameSpeed]);

            // --- [9. éŸ³é¢‘æ§åˆ¶é€»è¾‘] ---

            // éŸ³é¢‘æ± åˆå§‹åŒ–ï¼ˆé¢„åŠ è½½æ‰€æœ‰éŸ³æ•ˆï¼‰
            useEffect(() => {
                const soundFiles = {
                    'spin': './sound/sprint.mp3',
                    'win': './sound/clear.mp3',
                    'man': './sound/man.mp3',
                    'woman': './sound/woman.mp3',
                };

                // é¢„åŠ è½½éŸ³é¢‘åˆ°æ± ä¸­
                Object.entries(soundFiles).forEach(([key, src]) => {
                    const audio = new Audio(src);
                    audio.preload = 'auto'; // è‡ªåŠ¨é¢„åŠ è½½
                    audio.volume = sfxVolume;
                    audioPool.current[key] = audio;
                });

                // æ¸…ç†å‡½æ•°ï¼šå¸è½½æ—¶é‡Šæ”¾èµ„æº
                return () => {
                    Object.values(audioPool.current).forEach(audio => {
                        audio.pause();
                        audio.src = '';
                    });
                    audioPool.current = {};
                };
            }, []); // ä»…åˆå§‹åŒ–ä¸€æ¬¡

            // BGM å®æ—¶ç›‘å¬
            useEffect(() => {
                const audio = bgmRef.current;
                if (audio) {
                    audio.volume = bgmVolume; // åº”ç”¨çŠ¶æ€
                    if (bgmVolume > 0 && audio.paused) {
                        audio.play().catch(() => { }); // å°è¯•æ’­æ”¾
                    } else if (bgmVolume === 0 && !audio.paused) {
                        audio.pause();
                    }
                }
            }, [bgmVolume]);

            // SFX éŸ³é‡åŒæ­¥ï¼ˆå½“éŸ³é‡å˜åŒ–æ—¶åŒæ­¥åˆ°æ‰€æœ‰é¢„åŠ è½½çš„éŸ³é¢‘ï¼‰
            useEffect(() => {
                Object.values(audioPool.current).forEach(audio => {
                    if (audio) audio.volume = sfxVolume;
                });
            }, [sfxVolume]);

            // SFX æ’­æ”¾å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼šä½¿ç”¨éŸ³é¢‘æ±  + å…‹éš†æ¨¡å¼ï¼‰
            const playSound = useCallback((type) => { 
                const audio = audioPool.current[type]; 
                if (!audio) return; 
                
                // [ä¼˜åŒ–] ç§»åŠ¨ç«¯ç¦æ­¢ cloneNodeï¼Œç›´æ¥é‡ç½®è¿›åº¦æ’­æ”¾ï¼Œæ¶ˆé™¤å¡é¡¿
                audio.volume = sfxVolume;
                audio.currentTime = 0; 
                audio.play().catch(() => {}); // å¿½ç•¥äº¤äº’æŠ¥é”™
            }, [sfxVolume]);

// Keyboard
            useEffect(() => {
                const handleKeyDown = (e) => { 
                    if (e.code === 'Space') { 
                        e.preventDefault(); 
                        // [ä¿®å¤] è§‚æˆ˜æ¨¡å¼ä¸‹ç¦æ­¢ç©ºæ ¼é”®æ“ä½œ
                        if (!isSpinning && !showBuyModal && !showSimModal && !isAdminOpen && !freeGame.active && !isSpectating) { 
                            startSpin(); 
                        } 
                    } 
                };
                window.addEventListener('keydown', handleKeyDown); 
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isSpinning, showBuyModal, showSimModal, isAdminOpen, freeGame.active, bet, gameSpeed, isSpectating]);
            // --- [10. è¾…åŠ©å‡½æ•°] ---
            const getStep = (currentBet) => {
                if (currentBet < 10) return 1;
                if (currentBet < 100) return 10;
                if (currentBet < 1000) return 100;
                return 500;
            };

            const adjustBetSmart = (direction) => {
                setBet(prev => {
                    let step = getStep(prev);
                    if (direction === -1) {
                        if (prev === 10) step = 1;
                        else if (prev === 100) step = 10;
                        else if (prev === 1000) step = 100;
                    }
                    const newBet = prev + (step * direction);
                    return Math.max(1, newBet);
                });
            };

            const getCenter = (el) => {
                const rect = el.getBoundingClientRect();
                return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            };

            const addLog = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString().split(' ')[0];
                setLogs(prev => [{ time: timestamp, msg, type }, ...prev].slice(0, 50));
            };

const smartWait = (ms, isFastMode = false) => {
                return new Promise(resolve => {
                    const finalMs = isFastMode ? ms * 0.5 : ms;
                    setTimeout(resolve, finalMs / gameSpeed); // åº”ç”¨å€é€Ÿ
                });
            };
            const checkIsBoring = (gridToCheck) => {
                if (gridToCheck.flat().some(c => c.id === 88)) return false;
                const scatterCount = gridToCheck.flat().filter(c => c.id === 99).length;
                if (scatterCount >= 3) return false;
                const counts = {};
                gridToCheck.flat().forEach(c => { if (c && c.type === 'normal') counts[c.id] = (counts[c.id] || 0) + 1; });
                const hasWin = Object.values(counts).some(cnt => cnt >= 8);
                if (hasWin) return false;
                return true;
            };

            // ---------------------------------------------------------
            // æ ¸å¿ƒé€»è¾‘ 1: å¼€å§‹æ—‹è½¬
            // ---------------------------------------------------------
            const startSpin = async (forceType = null, isBuy = false, buyCost = 0) => {
                if (isSpinning) return;

                try {
                    const cost = isBuy ? buyCost : bet;
                    if (!freeGame.active && user.balance < cost && !forceType) {
                        setAutoSpin(false); alert("ä½™é¢ä¸è¶³ï¼"); return;
                    }

                    setIsSpinning(true);
                    setShowBuyModal(false);
                    setUiState(prev => ({ ...prev, currentWin: 0, winMult: 0, displayWinText: "0.00" }));
                    setFloatingTexts([]); setEliminatingCells(new Set()); setLasers([]); setShowFGTrigger(false); setBetMenuOpen(null);
                    setLightningStrikes(new Set());
                    setIsManCasting(false); setIsWomanCasting(false);

                    setGrid(Array(ROWS).fill(null).map(() => Array(COLS).fill(null)));

                    let currentBalance = user.balance;
if (!freeGame.active) { 
                        currentBalance -= cost; 
                        onUpdateBalance(currentBalance); 
                    } 
                    else { 
                        setFreeGame(prev => ({ ...prev, spinsLeft: prev.spinsLeft - 1 })); 
                    }

                    // [Monitor] æ›´æ–°çŠ¶æ€ä¸ºæ—‹è½¬ä¸­
                    updateDoc(doc(db, 'apps', APP_ID, 'tables', `table_${tableId}`), { status: 'spinning' });

                    playSound('spin');
                    await new Promise(r => setTimeout(r, 50 / gameSpeed));

                    const activeCfg = configRef.current;
                    let rawGrid;
                    const emptyRate = activeCfg.emptySpinProbability !== undefined ? activeCfg.emptySpinProbability : 0.2;
                    const isForcedLogic = !isBuy && !forceType;
                    const isEmptyGame = isForcedLogic && Math.random() < emptyRate;

                    if (isBuy) {
                        rawGrid = generateRiggedGrid(activeCfg, 'SCATTER');
                        addLog(`ğŸ›’ è´­ä¹°ç‰¹è‰²æ¸¸æˆ (-${cost})`, 'gold');
                    } else if (forceType && user.role === 'admin') {
                        rawGrid = generateRiggedGrid(activeCfg, forceType);
                        addLog(`ğŸ”¨ GOD MODE: å¼ºåˆ¶ ${forceType}`, 'warning');
                    } else if (isEmptyGame) {
                        rawGrid = generateLosingGrid(activeCfg);
                        if (user.role === 'admin') addLog(`ğŸ’€ å¼ºåˆ¶ç©ºè½¬ (RTPæ§åˆ¶)`, 'gray');
                    } else {
                        rawGrid = generateWinningGrid(activeCfg, freeGame.active);
                        if (user.role === 'admin') addLog(`ğŸ‰ å¼ºåˆ¶ä¸­å¥– (RTPæ§åˆ¶)`, 'success');
                    }

                    const isBoring = checkIsBoring(rawGrid);
                    // [æ•´åˆ] ç§»é™¤å¿«/æ…¢æ¨¡å¼åŒºåˆ«ï¼Œç»Ÿä¸€ä½¿ç”¨æ ‡å‡†æµç•…åŠ¨ç”»
                    setIsFastDrop(false);

                    // --- ç ¸çƒåˆ¤å®š (åŒæ­¥é€»è¾‘) ---
                    const smashRate = activeCfg.smashProbability !== undefined ? activeCfg.smashProbability : 0.3;
                    const shouldSmash = Math.random() < smashRate;
                    const candidates = [];
                    rawGrid.forEach((row, r) => { row.forEach((cell, c) => { if (cell && cell.id <= 9) candidates.push({ r, c }); }); });

                    let gridToDisplay = rawGrid.map(row => row.map(c => ({ ...c, key: Math.random().toString(36), isNew: true })));
                    let gridForLogic = gridToDisplay;
                    let smashHappened = false;
                    setGrid(gridToDisplay);
                    syncTableGrid(gridToDisplay, []); // [Monitor] åŒæ­¥å¹¶æ¸…ç©ºæ¶ˆé™¤çŠ¶æ€

                    if (shouldSmash && candidates.length > 0) {
                        const smashCount = 1;
                        const targetCoords = [];
                        for (let i = 0; i < smashCount; i++) {
                            if (candidates.length === 0) break;
                            const randIdx = Math.floor(Math.random() * candidates.length);
                            targetCoords.push(candidates[randIdx]);
                            candidates.splice(randIdx, 1);
                        }

                        // [ä¼˜åŒ–] åŠ¨æ€è®¡ç®—å»¶è¿Ÿï¼Œé™¤ä»¥ gameSpeed
                        const delayStrike = 250 / gameSpeed;
                        const delayReveal = 650 / gameSpeed;
                        const delayClear = 1050 / gameSpeed;

                        setTimeout(() => {
                            const newStrikes = new Set();
                            targetCoords.forEach(t => newStrikes.add(`${t.r}-${t.c}`));
                            setLightningStrikes(newStrikes);

                            const hasLeft = targetCoords.some(t => t.c < 3);
                            const hasRight = targetCoords.some(t => t.c >= 3);
                            if (hasLeft) { playSound('man'); setIsManCasting(true); }
                            if (hasRight) { playSound('woman'); setIsWomanCasting(true); }

                            if (user.role === 'admin') addLog(`âš¡ åˆå§‹æ‰è½: è§¦å‘åŒæ­¥ç ¸çƒ`, 'warning');
                        }, delayStrike);

                        const multWeights = getMultWeightsFromConfig(activeCfg);
                        const totalMW = multWeights.reduce((a, w) => a + w.weight, 0);
                        const smashedGrid = gridToDisplay.map(row => row.map(cell => ({ ...cell })));

                        targetCoords.forEach(t => {
                            let randomM = Math.random() * totalMW; let selectedVal = 2;
                            for (let w of multWeights) { randomM -= w.weight; if (randomM <= 0) { selectedVal = w.val; break; } }
                            smashedGrid[t.r][t.c] = {
                                ...smashedGrid[t.r][t.c],
                                id: 88, type: 'mult', icon: 'ğŸ’', color: 'text-green-400', name: 'Multiplier', val: selectedVal,
                                isJustRevealed: true,
                                isNew: false
                            };
                        });

                        gridForLogic = smashedGrid;

                        // é—ªç”µè¦†ç›–æ—¶å·æ¢æ•°æ®
                        setTimeout(() => { setGrid(smashedGrid); }, delayReveal);

                        // æ¸…é™¤é—ªç”µ
                        setTimeout(() => {
                            setLightningStrikes(new Set());
                            setIsManCasting(false); setIsWomanCasting(false);
                        }, delayClear);

                        smashHappened = true;
                    }

                    // [æ•´åˆ] ç»Ÿä¸€åŸºç¡€ç­‰å¾…æ—¶é—´ä¸º 800msï¼Œä¸å†åŒºåˆ†æ— èŠ/ä¸­å¥–
                    const baseWait = 800;
                    const totalWait = smashHappened ? Math.max(baseWait, 1100) : baseWait;

                    // [ä¼˜åŒ–] æ ¸å¿ƒç­‰å¾…æ—¶é—´éšå€é€Ÿç¼©çŸ­
                    await new Promise(r => setTimeout(r, totalWait / gameSpeed));

                    await processVisualLogic(gridForLogic, activeCfg, currentBalance, isEmptyGame, smashHappened, cost);
                } catch (error) {
                    console.error("SPIN ERROR:", error);
                    setIsSpinning(false); setAutoSpin(false); addLog("æ¸¸æˆå‘ç”Ÿé”™è¯¯: " + error.message, "error");
                }
            };

            // ---------------------------------------------------------
            // æ ¸å¿ƒé€»è¾‘ 2: æ¶ˆé™¤ä¸æ‰è½å¾ªç¯
            // ---------------------------------------------------------
           const processVisualLogic = async (initialGrid, activeCfg, startBalance, isEmptyGame, skipFirstSmash = false, currentCost = 0) => {
                let currentGrid = JSON.parse(JSON.stringify(initialGrid));
                let keepPlaying = true; let roundWin = 0; let loop = 0; let runningBalance = startBalance;

                const smashRate = activeCfg.smashProbability !== undefined ? activeCfg.smashProbability : 0.3;
                const emptyRate = activeCfg.emptySpinProbability !== undefined ? activeCfg.emptySpinProbability : 0.2;

                while (keepPlaying && loop < 20) {
                    loop++;

                    // 1. é—ªç”µå˜èº«é˜¶æ®µ
                    if (!(loop === 1 && skipFirstSmash)) {
                        const shouldSmash = Math.random() < smashRate;
                        const candidates = [];
                        currentGrid.forEach((row, r) => { row.forEach((cell, c) => { if (cell && cell.id <= 9) candidates.push({ r, c }); }); });

                        if (shouldSmash && candidates.length > 0) {
                            const smashCount = 1;
                            const targetCoords = [];
                            for (let i = 0; i < smashCount; i++) {
                                if (candidates.length === 0) break;
                                const randIdx = Math.floor(Math.random() * candidates.length);
                                targetCoords.push(candidates[randIdx]);
                                candidates.splice(randIdx, 1);
                            }

                            const newStrikes = new Set();
                            targetCoords.forEach(t => newStrikes.add(`${t.r}-${t.c}`));
                            setLightningStrikes(newStrikes);

                            const hasLeft = targetCoords.some(t => t.c < 3);
                            const hasRight = targetCoords.some(t => t.c >= 3);
                            if (hasLeft) { playSound('man'); setIsManCasting(true); }
                            if (hasRight) { playSound('woman'); setIsWomanCasting(true); }

                            if (user.role === 'admin') addLog(`âš¡ ç¬¬ ${loop} è½®: é—ªç”µå‡»ä¸­`, 'warning');

                            await smartWait(400, isEmptyGame);

                            const multWeights = getMultWeightsFromConfig(activeCfg);
                            const totalMW = multWeights.reduce((a, w) => a + w.weight, 0);
                            targetCoords.forEach(t => {
                                let randomM = Math.random() * totalMW; let selectedVal = 2;
                                for (let w of multWeights) { randomM -= w.weight; if (randomM <= 0) { selectedVal = w.val; break; } }
                                currentGrid[t.r][t.c] = { id: 88, type: 'mult', icon: 'ğŸ’', color: 'text-green-400', name: 'Multiplier', val: selectedVal, key: Math.random().toString(36), isNew: false, isJustRevealed: true };
                            });
                            setGrid([...currentGrid]);

                            await smartWait(400, isEmptyGame);

                            setLightningStrikes(new Set());
                            setIsManCasting(false); setIsWomanCasting(false);
                            await smartWait(200, isEmptyGame);
                        }
                    }

                    // 2. æ¶ˆé™¤åˆ¤å®š
                    const counts = {};
                    currentGrid.flat().forEach(c => { if (c && c.type === 'normal') counts[c.id] = (counts[c.id] || 0) + 1; });
                    const winIds = Object.keys(counts).filter(id => counts[id] >= 8);

                    if (winIds.length === 0) {
                        if (user.role === 'admin') addLog(`ğŸ›‘ ç¬¬ ${loop} è½®: ç»“ç®—`, 'gray');
                        keepPlaying = false;
                        break;
                    }

                    const currentEliminatingSet = new Set();
                    const currentRoundTexts = [];
                    let batchWin = 0;
                    let totalR = 0; let totalC = 0; let totalEliminatedCount = 0;

                    winIds.forEach(targetId => {
                        const count = counts[targetId];
                        const basePay = getPayout(parseInt(targetId), count);
                        const totalWinForSymbol = bet * basePay;
                        batchWin += totalWinForSymbol;
                        currentGrid.forEach((row, r) => {
                            row.forEach((col, c) => {
                                if (col && String(col.id) === String(targetId)) {
                                    currentEliminatingSet.add(`${r}-${c}`);
                                    totalR += r; totalC += c; totalEliminatedCount++;
                                }
                            });
                        });
                    });

                    if (batchWin > 0 && totalEliminatedCount > 0) {
                        const avgR = totalR / totalEliminatedCount; const avgC = totalC / totalEliminatedCount;
                        currentRoundTexts.push({ id: Math.random(), r: avgR, c: avgC, val: batchWin.toFixed(1), isGroup: true });
                        playSound('win'); if (user.role === 'admin') addLog(`ğŸ’° ç¬¬ ${loop} è½®: èµ¢åˆ† ${batchWin.toFixed(0)}`, 'success');
                    }

                    setEliminatingCells(currentEliminatingSet); 
                    // [Monitor] ç«‹å³åŒæ­¥æ¶ˆé™¤çŠ¶æ€ï¼Œè®©è§‚æˆ˜ç«¯æ’­æ”¾æ¶ˆé™¤åŠ¨ç”»
                    syncTableGrid(currentGrid, Array.from(currentEliminatingSet));
                    
                    setFloatingTexts(prev => [...prev, ...currentRoundTexts]);
                    roundWin += batchWin; setUiState(prev => ({ ...prev, currentWin: roundWin, displayWinText: roundWin.toFixed(2) }));
                    setUiState(prev => ({ ...prev, currentWin: roundWin, displayWinText: roundWin.toFixed(2) }));

                    await smartWait(2050, isEmptyGame);

                    currentGrid = currentGrid.map((row, r) => row.map((c, colIdx) => (c && currentEliminatingSet.has(`${r}-${colIdx}`)) ? null : c));
                    setGrid([...currentGrid]);
                    setEliminatingCells(new Set());

                    // 3. æ‰è½è¡¥æ»¡
                    const nextGrid = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
                    const isNextDropEmpty = Math.random() < emptyRate;
                    if (user.role === 'admin') addLog(`ğŸ² ç¬¬ ${loop} è½®æ‰è½: ${isNextDropEmpty ? 'ç©ºè½¬' : 'ä¸­å¥–'}`, isNextDropEmpty ? 'gray' : 'gold');

                    let predictedScatterCount = 0;
                    for (let r = 0; r < ROWS; r++) { for (let c = 0; c < COLS; c++) { if (currentGrid[r][c] && currentGrid[r][c].id === 99) predictedScatterCount++; } }
                    let forceWinCol = -1; let forceWinSymbol = null;
                    if (!isNextDropEmpty) { forceWinCol = Math.floor(Math.random() * COLS); let s = getUniformSymbol(); if (s.id > 9) s = { ...SYMBOLS_DEF.find(sym => sym.id === 1) }; forceWinSymbol = s; }

                    for (let c = 0; c < COLS; c++) {
                        let colData = [];
                        for (let r = 0; r < ROWS; r++) { if (currentGrid[r][c]) { colData.push({ ...currentGrid[r][c], isNew: false, oldRow: r }); } }

                        let dropIndex = 0;
                        while (colData.length < ROWS) {
                            let sym;
                            if (!isNextDropEmpty && c === forceWinCol && dropIndex < 3) { sym = { ...forceWinSymbol }; }
                            else {
                                let safety = 0;
                                do {
                                    const scatterProb = activeCfg.symbolWeights?.[99] !== undefined ? activeCfg.symbolWeights[99] : 2;
                                    const isScatterRoll = (Math.random() * 100) < scatterProb;
                                    if (isScatterRoll) { sym = { ...SYMBOLS_DEF.find(s => s.id === 99) }; }
                                    else { const normalSymbols = SYMBOLS_DEF.filter(s => s.id >= 1 && s.id <= 9); const randIdx = Math.floor(Math.random() * normalSymbols.length); sym = { ...normalSymbols[randIdx] }; }

                                    if (sym.id === 88) sym = { ...SYMBOLS_DEF.find(s => s.id === 1) };
                                    if (sym.id === 99 && predictedScatterCount >= 4) { const normalSymbols = SYMBOLS_DEF.filter(s => s.id >= 1 && s.id <= 9); const randIdx = Math.floor(Math.random() * normalSymbols.length); sym = { ...normalSymbols[randIdx] }; }
                                    if (isNextDropEmpty && colData.length > 0) { const lastSym = colData[0]; if (lastSym.id === sym.id) { sym = null; } }
                                    safety++;
                                } while (!sym && safety < 10);
                                if (!sym) sym = { ...SYMBOLS_DEF.find(s => s.id === 1) };
                            }
                            if (sym.id === 99) predictedScatterCount++;
                            colData.unshift({ ...sym, key: Math.random().toString(36), isNew: true });
                            dropIndex++;
                        }
                        for (let r = 0; r < ROWS; r++) { const sym = colData[r]; if (!sym.isNew) { sym.isDropping = (r !== sym.oldRow); } nextGrid[r][c] = sym; }
                    }

                    const isBoring = checkIsBoring(nextGrid);
                    // [æ•´åˆ] ç»Ÿä¸€åŠ¨ç”»æ¨¡å¼
                    setIsFastDrop(false);
                    playSound('drop');
                    currentGrid = nextGrid;
                    setGrid(currentGrid);
                    syncTableGrid(currentGrid); // [Monitor] åŒæ­¥æ‰è½åçš„ç›˜é¢çŠ¶æ€
                    setFloatingTexts([]);

                    // [æ•´åˆ] ç»Ÿä¸€æ‰è½åç­‰å¾…æ—¶é—´ (800ms)
                    await smartWait(800, isEmptyGame);
                }

                // 4. ç»“ç®—
                const mults = currentGrid.flat().filter(c => c && c.id === 88);
                const totalMultOnBoard = mults.reduce((a, b) => a + b.val, 0);
                let finalMult = 1; let actualMultToApply = 0;

                if (freeGame.active) {
                    if (roundWin > 0) {
                        const newAcc = freeGame.accMult + totalMultOnBoard;
                        setFreeGame(prev => ({ ...prev, accMult: newAcc }));
                        finalMult = newAcc > 0 ? newAcc : 1;
                        actualMultToApply = newAcc;
                    } else { finalMult = freeGame.accMult > 0 ? freeGame.accMult : 1; }
                } else {
                    finalMult = totalMultOnBoard > 0 ? totalMultOnBoard : 1;
                    actualMultToApply = totalMultOnBoard;
                }

                if (roundWin > 0 && totalMultOnBoard > 0) {
                    const targetEl = topBarRef.current;
                    if (targetEl) {
                        const targetPos = getCenter(targetEl);
                        const newLasers = [];
                        const orbElements = document.querySelectorAll('[data-symbol-id="88"]');
                        orbElements.forEach((el) => {
                            const srcPos = getCenter(el);
                            newLasers.push({ id: Math.random(), x1: srcPos.x, y1: srcPos.y, x2: targetPos.x, y2: targetPos.y });
                        });
                        if (newLasers.length > 0) {
                            setLasers(newLasers); playSound('bigwin');
                            setUiState(prev => ({ ...prev, displayWinText: `x ${actualMultToApply}` }));
                            await smartWait(800, isEmptyGame);
                            setLasers([]);
                        }
                    }
                }

                finalMult = Math.max(1, finalMult);
                setUiState(prev => ({ ...prev, winMult: finalMult > 1 ? finalMult : 0 }));
                const finalWin = roundWin * finalMult;

                if (finalWin > 0) {
                    runningBalance += finalWin; onUpdateBalance(runningBalance);
                    setUiState(prev => ({ ...prev, currentWin: finalWin, displayWinText: finalWin.toFixed(2) }));
                    if (freeGame.active) setFreeGame(prev => ({ ...prev, totalWin: prev.totalWin + finalWin }));
                    addLog(`ğŸ† èµ¢åˆ†: ${finalWin.toFixed(0)} (x${finalMult})`, 'success');

                    if (finalWin >= bet * 20) { playSound('bigwin'); setShowBigWin(finalWin); await smartWait(5000, false); setShowBigWin(null); }
                    else if (finalWin > bet * 5) { playSound('bigwin'); await smartWait(1500, isEmptyGame); }
                    else { await smartWait(500, isEmptyGame); }
                } else { setUiState(prev => ({ ...prev, displayWinText: roundWin > 0 ? roundWin.toFixed(2) : "0.00" })); }

                // [Status Update] ä¿æŒå ç”¨çŠ¶æ€
                updateDoc(doc(db, 'apps', APP_ID, 'tables', `table_${tableId}`), { status: 'occupied' });

                // 1. ç»Ÿä¸€è®¡ç®—æ‰€æœ‰çŠ¶æ€ (åªå£°æ˜ä¸€æ¬¡)
                const finalScattersCount = currentGrid.flat().filter(c => c && c.id === 99).length;
                const triggerFG = !freeGame.active && finalScattersCount >= 4;
                const triggerRetrigger = freeGame.active && finalScattersCount >= 3;
                const isFGWin = freeGame.active && finalWin > 0;

                // 2. ä¿å­˜æ•°æ® (ä½¿ç”¨ä¸Šé¢è®¡ç®—å¥½çš„å˜é‡)
                if (currentCost > 0 || finalWin > 0) {
                    saveGameStats(currentCost, finalWin, finalMult, triggerFG, isFGWin);
                }

                // 3. è§¦å‘æ¸¸æˆäº‹ä»¶ (é€»è¾‘åˆ¤æ–­)
                if (triggerFG) {
                    addLog("âœ¨ è§¦å‘ Free Game", 'gold');
                    setShowFGTrigger(true);
                    playSound('bigwin');
                    await smartWait(3000, false);
                    setShowFGTrigger(false);
                    setFreeGame({ active: true, spinsLeft: 15, accMult: 0, totalWin: 0 });
                } else if (triggerRetrigger) {
                    addLog("ğŸ”„ Retrigger +5 Spins", 'gold');
                    setFreeGame(prev => ({ ...prev, spinsLeft: prev.spinsLeft + 5 }));
                    playSound('bigwin');
                    await smartWait(1000, false);
                }

                setIsSpinning(false);
            };

            const endFreeGame = () => {
                setFreeGame(prev => ({ ...prev, active: false }));
                setIsSpinning(false); setAutoSpin(false); alert(`å…è´¹æ¸¸æˆç»“æŸï¼æ€»åˆ†: ${Math.floor(freeGame.totalWin)}`);
            };

// ---------------------------------------------------------
            // Render UI
            // ---------------------------------------------------------
            return (
                <div 
                    className="fixed inset-0 w-full h-[100dvh] bg-black font-roboto select-none flex flex-col landscape:flex-row overflow-hidden text-white"
                    style={{ '--speed-factor': gameSpeed }}
                >
                    {/* [æ–°å¢] ç«–å±æ—‹è½¬æç¤ºé®ç½© (ä»…ç«–å±æ˜¾ç¤º) */}
                    <div className="fixed inset-0 z-[9999] bg-[#0f0500] flex flex-col items-center justify-center landscape:hidden font-noto text-center p-8 animate-in fade-in duration-500">
                        <div className="relative mb-8">
                            <Smartphone size={80} className="text-gray-700" />
                            <RotateCw size={40} className="text-[#fbbf24] absolute -right-2 -bottom-2 animate-spin duration-[3s]" />
                        </div>
                        <h2 className="text-2xl font-bold text-[#fbbf24] mb-3 font-cinzel">PLEASE ROTATE</h2>
                        <p className="text-gray-400 text-sm tracking-widest uppercase">ä¸ºäº†è·å¾—æœ€ä½³ä½“éªŒ<br/>è¯·æ—‹è½¬æ‚¨çš„è®¾å¤‡è‡³æ¨ªå±æ¨¡å¼</p>
                    </div>

                    {betMenuOpen && <div className="fixed inset-0 z-[60]" onClick={() => setBetMenuOpen(null)}></div>}
{/* Modals */}
                    <PlayerStatsModal 
                        isOpen={showStatsModal} 
                        onClose={() => setShowStatsModal(false)} 
                        history={playHistory} 
                        globalStats={globalStats}
                        todayStats={todayStats}
                    />                    <SimulatorModal isOpen={showSimModal} onClose={() => setShowSimModal(false)} config={configRef.current} />
                    <BuyBonusModal
                        isOpen={showBuyModal}
                        onClose={() => setShowBuyModal(false)}
                        bet={bet}
                        onBuy={(cost) => startSpin(null, true, cost)}
                        playSound={playSound}
                    />
                    {showBigWin && <BigWinOverlay winAmount={showBigWin} onClose={() => setShowBigWin(null)} />}

                    {/* Lasers */}
                    {lasers.length > 0 && (
                        <svg className="absolute inset-0 w-full h-full pointer-events-none z-[9999] overflow-visible">
                            <defs>
                                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                                    <feMerge><feMergeNode in="coloredBlur" /><feMergeNode in="SourceGraphic" /></feMerge>
                                </filter>
                            </defs>
                            {lasers.map(laser => (
                                <line key={laser.id} x1={laser.x1} y1={laser.y1} x2={laser.x2} y2={laser.y2} stroke="#fbbf24" strokeWidth="6" strokeLinecap="round" filter="url(#glow)" className="animate-laser-shot" />
                            ))}
                        </svg>
                    )}

                    {/* Logger */}
                    {user.role === 'admin' && (
                        <FloatingLogger
                            logs={logs}
                            visible={showLogger}
                            onToggle={() => setShowLogger(!showLogger)}
                        />
                    )}

                    {/* Top Buttons (Landscape) */}
                    <div className="hidden landscape:flex fixed top-2 right-2 z-50 gap-2 items-start">
                        <div className="relative flex flex-col items-end">
                            <button
                                onClick={() => setShowVolumePanel(!showVolumePanel)}
                                className={`p-2 rounded-full border transition-colors ${showVolumePanel || bgmVolume > 0 ? 'bg-emerald-900/50 border-emerald-500 text-emerald-400' : 'bg-black/50 border-gray-500 text-gray-400'}`}
                            >
                                {bgmVolume > 0 ? <Volume2 size={14} /> : <VolumeX size={14} />}
                            </button>
                            {showVolumePanel && (
                                <div className="absolute top-10 right-0 bg-[#1c1917] border border-[#fbbf24]/30 p-4 rounded-xl shadow-2xl flex flex-col gap-4 w-48 animate-in fade-in slide-in-from-top-2 z-[60]">
                                    <div className="space-y-1"><div className="flex justify-between text-xs text-[#fbbf24] font-bold"><span>Music</span><span>{Math.round(bgmVolume * 100)}%</span></div><input type="range" min="0" max="1" step="0.05" value={bgmVolume} onChange={(e) => setBgmVolume(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#fbbf24]" /></div>
                                    <div className="space-y-1"><div className="flex justify-between text-xs text-emerald-400 font-bold"><span>Sound</span><span>{Math.round(sfxVolume * 100)}%</span></div><input type="range" min="0" max="1" step="0.05" value={sfxVolume} onChange={(e) => setSfxVolume(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" /></div>
                                </div>
                            )}
                        </div>

<button onClick={() => setShowStatsModal(!showStatsModal)} className="bg-black/50 text-blue-400 p-2 rounded-full border border-blue-500/30">
                            <BarChart2 size={14} />
                        </button>

                        {/* Speed Control Button */}
                        <div className="relative flex flex-col items-end">
                            <button
                                onClick={() => setShowSpeedPanel(!showSpeedPanel)}
                                className={`p-2 rounded-full border transition-colors ${gameSpeed > 1 ? 'bg-yellow-900/50 border-yellow-500 text-yellow-400' : 'bg-black/50 border-gray-500 text-gray-400'}`}
                            >
                                <ChevronsRight size={14} />
                                {gameSpeed > 1 && <span className="absolute -bottom-1 -right-1 bg-yellow-500 text-black text-[8px] font-bold px-1 rounded-full">{gameSpeed}x</span>}
                            </button>
                            {showSpeedPanel && (
                                <div className="absolute top-10 right-0 bg-[#1c1917] border border-[#fbbf24]/30 p-4 rounded-xl shadow-2xl flex flex-col gap-4 w-48 animate-in fade-in slide-in-from-top-2 z-[60]">
                                    <div className="space-y-1">
                                        <div className="flex justify-between text-xs text-[#fbbf24] font-bold">
                                            <span>Speed</span>
                                            <span>{gameSpeed}x</span>
                                        </div>
                                        <input 
                                            type="range" min="1" max="10" step="1" 
                                            value={gameSpeed} 
                                            onChange={(e) => setGameSpeed(Number(e.target.value))} 
                                            className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#fbbf24]" 
                                        />
                                        <div className="flex justify-between text-[10px] text-gray-500 font-mono">
                                            <span>1x</span><span>5x</span><span>10x</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {user.role === 'admin' && (
                            <button onClick={() => setIsAdminOpen(!isAdminOpen)} className="bg-black/50 text-[#fbbf24] p-2 rounded-full border border-[#fbbf24]/30">
                                <Settings size={14} />
                            </button>
                        )}
                        <button onClick={onLeaveTable} className="bg-black/50 text-rose-400 p-2 rounded-full border border-rose-500/30">
                            <LogOut size={14} />
                        </button>
                    </div>

                    {/* GAME VIEW AREA */}
                    <div className={`relative flex-grow flex flex-col items-center justify-center p-2 landscape:p-0 landscape:pb-8 overflow-hidden w-full`}>

                        {/* Background & Characters */}
                        {/* [ä¿®æ”¹] æ›¿æ›ç‚ºé‡‘è‰²èƒŒæ™¯åœ– */}
                        <div className="absolute inset-0 z-0 bg-black">
                            <img src="./images/golden-seth.jpg" alt="Background" className="w-full h-full object-cover opacity-60" />
                            <div className="absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-black/80"></div>
                        </div>
                        
                        {/* [æ–°å¢] èƒŒæ™¯å‘¼å¸å…‰æ•ˆå±‚ */}
                        <div className="bg-breathing-light"></div>

                       {/* [ä¼˜åŒ–] æ‰‹æœºç«¯äººç‰©å‘ä¸­é—´é æ‹¢ (10%) */}
                        <img src="./images/man.png" alt="Character Left" className={`hidden landscape:block absolute left-[10%] lg:left-[2%] top-1/2 -translate-y-1/2 h-[80%] lg:h-[90%] max-h-[900px] w-auto object-contain z-0 lg:z-10 opacity-40 lg:opacity-100 drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)] pointer-events-none transition-transform duration-500 ${isManCasting ? 'animate-character-cast' : ''}`} />
                        <img src="./images/woman.png" alt="Character Right" className={`hidden landscape:block absolute right-[10%] lg:right-[4%] top-1/2 -translate-y-1/2 h-[80%] lg:h-[90%] max-h-[900px] w-auto object-contain z-0 lg:z-10 opacity-40 lg:opacity-100 drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)] pointer-events-none transition-transform duration-500 ${isWomanCasting ? 'animate-character-cast' : ''}`} style={{ transform: 'translateY(-50%)' }} />                        {/* FG Info */}
                        {freeGame.active && (
                            <div className="absolute left-24 top-1/2 -translate-y-1/2 z-40 hidden lg:block animate-bounce-drop pointer-events-none">
                                <div className="flex flex-col items-center justify-center">
                                    <div className="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-b from-[#fff7ed] via-[#fbbf24] to-[#b45309] drop-shadow-[0_5px_0_#78350f] font-cinzel tracking-tighter leading-[0.8]">{freeGame.spinsLeft}</div>
                                    <div className="flex flex-col items-center mt-4 space-y-[-5px]"><span className="text-3xl font-black text-[#fbbf24] drop-shadow-[0_2px_0_black] font-cinzel tracking-[0.2em]">FREE</span><span className="text-3xl font-black text-[#fbbf24] drop-shadow-[0_2px_0_black] font-cinzel tracking-[0.2em]">GAMES</span></div>
                                    <div className="mt-6 bg-black/60 border border-[#fbbf24] px-4 py-1 rounded-full backdrop-blur-sm"><span className="text-xs text-gray-300 uppercase mr-2">Total Win</span><span className="text-xl font-mono text-white font-bold">{Math.floor(freeGame.totalWin).toLocaleString()}</span></div>
                                </div>
                            </div>
                        )}

                        {/* Buy Button */}
                        {!freeGame.active && !isSpinning && (<div className="absolute left-2 top-2 z-30 lg:hidden landscape:hidden"><button onClick={() => { playSound('click'); setShowBuyModal(true); }} className="bg-[#b45309] border border-[#fbbf24] text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1"><ShoppingCart size={12} /> BUY</button></div>)}
{!freeGame.active && (<div className="hidden landscape:block absolute left-4 z-30"><button onClick={() => { playSound('click'); setShowBuyModal(true); }} disabled={isSpinning} className="flex flex-col items-center justify-center w-16 h-16 bg-gradient-to-b from-[#b45309] to-[#451a03] border-2 border-[#fbbf24] rounded-xl shadow-lg hover:scale-105 active:scale-95 transition-all group"><div className="text-sm text-[#fde047] font-black drop-shadow-md -mt-3 mb-1">BUY</div><ShoppingCart className="text-white w-6 h-6 group-hover:text-[#fbbf24] transition-colors" /></button></div>)}
                        {/* Spin Controls */}
                        {/* [ä¼˜åŒ–] æ‰‹æœºæ¨ªå±ç¼©æ”¾æŒ‰é’®ç»„ï¼Œé˜²æ­¢é®æŒ¡å³ä¸Šè§’é€€å‡ºé”® */}
                        <div className="hidden landscape:flex flex-col gap-3 absolute right-4 top-1/2 -translate-y-1/2 z-50 items-center landscape:scale-75 landscape:origin-right lg:landscape:scale-100">
                            <button onClick={() => setAutoSpin(!autoSpin)} className={`w-10 h-10 rounded-full border flex items-center justify-center shadow-lg bg-black/60 backdrop-blur ${autoSpin ? 'border-emerald-500 text-emerald-400' : 'border-white/20 text-gray-400'}`}><RotateCw size={16} className={autoSpin ? 'animate-spin-btn' : ''} /></button>
                            <div className="relative flex flex-col items-center bg-black/80 rounded-2xl border border-white/20 p-1 gap-1 backdrop-blur-md shadow-lg"><button disabled={isSpinning} onClick={(e) => { e.stopPropagation(); adjustBetSmart(1); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-white active:scale-90 transition-transform"><Plus size={14} /></button><div className="text-[#fbbf24] font-bold font-mono text-xs py-1 select-none min-w-[24px] text-center">{bet}</div><button disabled={isSpinning} onClick={(e) => { e.stopPropagation(); adjustBetSmart(-1); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-white active:scale-90 transition-transform"><Minus size={14} /></button></div>
                            {!isSpectating ? (
                                <button onClick={() => startSpin()} disabled={isSpinning && !autoSpin} className="w-20 h-20 rounded-full bg-gradient-to-b from-[#f59e0b] to-[#b45309] border-4 border-[#451a03] shadow-[0_5px_15px_rgba(0,0,0,0.5)] flex items-center justify-center active:scale-95 transition-transform hover:brightness-110">
                                    {isSpinning ? <RotateCw className="animate-spin text-[#451a03]" size={28} /> : <Play className="fill-[#451a03] text-[#451a03] ml-1" size={32} />}
                                </button>
                            ) : (
                                <div className="w-20 h-20 rounded-full bg-black/80 border-4 border-gray-600 flex flex-col items-center justify-center animate-pulse">
                                    <Activity size={24} className="text-emerald-500" />
                                    <span className="text-[8px] font-bold text-emerald-500 mt-1">LIVE</span>
                                </div>
                            )}
                        </div>

<div ref={topBarRef} className="relative z-20 w-full max-w-[95vw] md:max-w-[800px] h-10 md:h-16 mb-1 bg-black/60 border border-[#fbbf24]/30 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(0,0,0,0.5)] backdrop-blur-sm transition-all"><div className={`text-3xl md:text-5xl font-black tracking-widest transition-all duration-200 ${lasers.length > 0 ? 'text-white scale-125 drop-shadow-[0_0_10px_white]' : 'text-[#fbbf24] drop-shadow-md'}`}>{uiState.displayWinText}</div></div>

                        {/* [ä¿®æ”¹] æ‰‹æœºç«¯(ç«–å±+æ¨ªå±)å…¨ç¨‹æ˜¾ç¤ºå·¦ä¸‹è§’æ‚¬æµ®ä¿¡æ¯ï¼Œä»…åœ¨ç”µè„‘ç«¯(lg)éšè— */}
                        <div className="absolute bottom-2 left-2 z-30 flex flex-col gap-1 lg:hidden pointer-events-none">
                            <div className="bg-black/60 backdrop-blur-sm border border-white/10 px-3 py-1 rounded-lg shadow-lg">
                                <div className="text-[8px] text-gray-400 uppercase font-bold">BALANCE</div>
                                <div className="text-sm font-mono font-bold text-white">${Math.floor(user.balance).toLocaleString()}</div>
                            </div>
                            <div className="bg-black/60 backdrop-blur-sm border border-yellow-500/30 px-3 py-1 rounded-lg shadow-lg">
                                <div className="text-[8px] text-yellow-500 uppercase font-bold">WIN</div>
                                <div className="text-sm font-mono font-bold text-[#fbbf24]">${Math.floor(freeGame.active ? freeGame.totalWin : uiState.currentWin).toLocaleString()}</div>
                            </div>
                        </div>

                        {/* [ä¿®å¾©] é™åˆ¶æ©«å±æœ€å¤§å¯¬åº¦ï¼Œé˜²æ­¢é®æ“‹å·¦å³æŒ‰éˆ• (æ¡Œé¢ç«¯è§£é™¤é™åˆ¶) */}
                        <div className="relative w-full max-w-[95vw] md:max-w-[800px] max-h-[65vh] landscape:max-h-none aspect-[4/3] landscape:w-auto landscape:h-[85%] landscape:aspect-[16/10] landscape:max-w-[65vw] lg:landscape:max-w-none z-20 transition-all duration-300">                            {showFGTrigger && (<div className="absolute inset-0 z-50 flex items-center justify-center pointer-events-none"><div className="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 via-yellow-500 to-yellow-800 drop-shadow-[0_0_20px_rgba(255,215,0,0.8)] animate-bounce-drop font-cinzel tracking-tighter text-center leading-tight">FREE<br />GAMES</div></div>)}
                            
                            {freeGame.active && (<div className="absolute -right-2 -top-10 z-50 w-16 h-16 bg-[#2d1b0e] border-2 border-rose-500 rounded-xl flex flex-col items-center justify-center shadow-[0_0_20px_rgba(220,38,38,0.8)] animate-bounce-drop rotate-3"><div className="absolute -top-2 bg-rose-600 text-white text-[8px] font-bold px-2 rounded-full border border-rose-400">TOTAL</div><span className="text-2xl font-black text-white drop-shadow-md">{freeGame.accMult}x</span></div>)}

                            <div className="w-full h-full bg-gradient-to-b from-[#0b1c38] via-[#2b5a7a] to-[#0b1c38] rounded-lg border-2 md:border-4 border-amber-600 shadow-[0_0_60px_rgba(0,0,0,0.9)] grid grid-cols-6 grid-rows-5 gap-px p-0.5 relative overflow-hidden ring-2 ring-[#fbbf24]/30">
                                {(() => {
                                    const scatterCount = grid.flat().filter(c => c && c.id === 99).length;
                                    return grid.map((row, r) => (
                                        row.map((cell, c) => {
                                            if (!cell) return <div key={`${r}-${c}`} className="bg-transparent"></div>;
                                            
                                            const isEliminating = eliminatingCells.has(`${r}-${c}`);
                                            const isSpecialScatter = cell.id === 99 && scatterCount >= 4 && showFGTrigger;
                                            const isJustRevealed = cell.isJustRevealed;
                                            const isStruck = lightningStrikes.has(`${r}-${c}`);
                                            
                                            const dropAnimationClass = (isSpinning && !isEliminating)
                                                ? (cell.isNew ? 'animate-heavy-drop' : (cell.isDropping ? 'animate-survivor-drop' : ''))
                                                : '';

                                            return (
                                                <div
                                                    key={cell.key}
                                                    data-symbol-id={cell.id}
                                                    style={{
                                                        zIndex: isEliminating ? 100 : (isSpecialScatter ? 90 : 10),
                                                        // [ä¼˜åŒ–] æ‰è½å»¶è¿Ÿéšå€é€Ÿç¼©çŸ­ï¼Œä¿æŒæµç•…æ„Ÿ (å¾®è°ƒæ ‡å‡†å‚æ•° 0.1s -> 0.08s ä»¥é€‚åº”ç»Ÿä¸€èŠ‚å¥)
                                                        animationDelay: (cell.isNew && isSpinning)
                                                            ? (isFastDrop ? `${(c * 0.06) / gameSpeed}s` : `${(c * 0.08) / gameSpeed}s`)
                                                            : '0s',
                                                        // [ä¼˜åŒ–] å¼ºåˆ¶è¦†ç›–åŠ¨ç”»æ—¶é•¿ (é€‚é…å€é€Ÿ)
                                                        animationDuration: isFastDrop ? `calc(0.25s / ${gameSpeed})` : undefined,
                                                        transition: isFastDrop ? `all calc(0.25s / ${gameSpeed}) ease-out` : `all calc(0.2s / ${gameSpeed})`
                                                    }}
                                                    className={`
                                                    relative flex items-center justify-center 
                                                    border border-white/5 overflow-visible 
                                                    ${!isFastDrop ? 'transition-all duration-200' : ''} 
                                                    ${dropAnimationClass} 
                                                    ${isEliminating ? 'animate-eliminate-shake' : 'bg-black/20'} 
                                                    ${isSpecialScatter ? 'scale-125 animate-pulse drop-shadow-[0_0_15px_gold]' : ''} 
                                                    ${isJustRevealed ? 'animate-magic-appear' : ''}
                                                `}
                                                >
                                                    {isStruck && (
                                                        <>
                                                            <div className="lightning-impact-cell"></div>
                                                            <div className="lightning-bolt-container"></div>
                                                        </>
                                                    )}

                                                    {cell.id === 88 ? (() => {
                                                        let orbImageStr = './images/small.png'; const val = cell.val;
                                                        if (val <= 3) orbImageStr = './images/small.png'; else if (val <= 8) orbImageStr = './images/small2.png'; else if (val <= 15) orbImageStr = './images/small3.png'; else orbImageStr = './images/small4.png';
                                                        return (
                                                            <div className="relative w-full h-full flex items-center justify-center p-1 group">
                                                                <img src={orbImageStr} alt={`${val}x`} className="w-full h-full object-contain drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] transition-transform duration-200 group-hover:scale-105" />
                                                                {/* [ä¿®æ”¹] æ”¹ä¸ºäº®é‡‘è‰²æ–‡å­—ï¼Œå¢åŠ å‘å…‰æ•ˆæœ */}
                                                                <span className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#fde047] font-black text-2xl md:text-6xl z-20 pointer-events-none pb-1 md:pb-2 drop-shadow-[0_2px_2px_rgba(0,0,0,0.9)]" style={{ textShadow: '0 0 10px rgba(253, 224, 71, 0.5)' }}>{val}x</span>
                                                            </div>
                                                        );
                                                    })() : cell.id === 99 ? (
                                                        <div className="relative w-full h-full flex flex-col items-center justify-center p-1">
                                                            <img src={cell.icon} alt="Scatter" className="w-full h-full object-contain drop-shadow-[0_0_10px_rgba(255,215,0,0.6)]" />
                                                            {/* [ä¿®æ”¹] å·²ç§»é™¤åº•éƒ¨çš„ SCATTER æ–‡å­— */}
                                                        </div>
                                                    ) : ((() => {
                                                        const scale = cell.scale || 1;
                                                        const sizePct = `${scale * 100}%`;
                                                        return (
                                                            <div className="w-full h-full flex items-center justify-center p-1 relative">
                                                                <img src={cell.icon} alt={cell.name} className="object-contain drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] transition-transform duration-200" style={{ width: sizePct, height: sizePct }} />
                                                            </div>
                                                        );
                                                    })())}
                                                </div>
                                            )
                                        })
                                    ));
                                })()}
                                {floatingTexts.map(f => (<div key={f.id} className="absolute z-[200] font-black text-4xl md:text-6xl text-yellow-400 animate-group-win pointer-events-none select-none whitespace-nowrap font-noto drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] flex items-center justify-center" style={{ top: `calc(${f.r} * 20% + 10%)`, left: `calc(${f.c} * 16.666% + 8.333%)`, transform: 'translate(-50%, -50%)' }}>{f.val}</div>))}
                            </div>
                        </div>
                    </div>

                    {/* Bottom Bar (Desktop Only) */}
                    <div className="hidden lg:flex absolute bottom-0 w-full h-16 bg-black/90 border-t border-[#fbbf24]/30 z-50 items-center justify-center font-noto gap-12">
                        <div className="flex items-center gap-4"><span className="text-[#fbbf24] font-black text-lg tracking-widest">é¤˜é¡</span><span className="text-5xl font-black text-white font-mono drop-shadow-[0_0_15px_rgba(251,191,36,0.6)]">{Math.floor(user.balance).toLocaleString()}</span></div>
                        <div className="flex items-center gap-4 absolute right-8 opacity-90"><span className="text-gray-400 font-bold text-sm">è´åˆ†</span><span className="text-3xl font-black text-[#fbbf24] font-mono">{Math.floor(freeGame.active ? freeGame.totalWin : uiState.currentWin)}</span></div>
                    </div>

{/* Portrait Bottom Controls */}
                    {/* [ä¼˜åŒ–] å¢åŠ åº•éƒ¨ padding ç¡®ä¿ä¸è´´åº• */}
                    <div className="shrink-0 bg-[#0c0a09]/80 backdrop-blur border-t border-[#fbbf24]/20 relative z-30 shadow-lg pb-6 pt-2 landscape:hidden">
                            <div className="flex flex-col items-center justify-between px-4 py-2 gap-2">
                            <div className="flex w-full justify-between gap-2"><div className="bg-[#1c1917] px-2 py-1 rounded border border-white/5 flex-1 text-center"><div className="text-[8px] text-gray-500 font-bold tracking-wider font-noto">é¤˜é¡</div><div className="text-sm font-mono text-white">{Math.floor(user.balance).toLocaleString()}</div></div><div className="bg-[#1c1917] px-2 py-1 rounded border border-yellow-900/30 flex-1 text-center"><div className="text-[8px] text-yellow-600 font-bold tracking-wider font-noto">è´åˆ†</div><div className="text-sm font-mono text-[#fbbf24]">{Math.floor(freeGame.active ? freeGame.totalWin : uiState.currentWin)}</div></div></div>
                            <div className="flex w-full items-center justify-between gap-2">
                                <button onClick={() => setAutoSpin(!autoSpin)} className={`w-10 h-10 rounded-full border flex items-center justify-center ${autoSpin ? 'bg-emerald-900/50 border-emerald-500 text-emerald-400' : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10'}`}><RotateCw size={16} className={autoSpin ? 'animate-spin-btn' : ''} /></button>
                                <div className="relative flex items-center bg-[#1c1917] rounded-full border border-white/10 p-1 gap-1 flex-grow max-w-[200px] justify-between"><button disabled={isSpinning} onClick={(e) => { e.stopPropagation(); adjustBetSmart(-1); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 active:scale-90 transition-transform"><Minus size={12} /></button><div className="w-full text-center font-bold text-sm text-white select-none">{bet}</div><button disabled={isSpinning} onClick={(e) => { e.stopPropagation(); adjustBetSmart(1); }} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 active:scale-90 transition-transform"><Plus size={12} /></button></div>
                                <button onClick={() => startSpin()} disabled={isSpinning && !autoSpin} className="w-16 h-16 rounded-full bg-gradient-to-b from-[#f59e0b] to-[#b45309] border-2 border-[#451a03] shadow-xl flex items-center justify-center active:scale-95 transition-transform hover:brightness-110 group shrink-0"><RotateCw className={isSpinning ? "animate-spin text-[#451a03]" : "hidden"} size={24} /><Play className={!isSpinning ? "fill-[#451a03] text-[#451a03] ml-1" : "hidden"} size={28} /></button>
                            </div>
                        </div>
                    </div>

                    {/* Admin Sidebar */}
                    {user.role === 'admin' && (
                        <div className={`fixed right-0 top-0 bottom-0 bg-[#121212] border-l border-[#fbbf24]/20 shadow-2xl transition-transform duration-300 flex flex-col z-[60] w-[300px] ${isAdminOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                            <div className="h-14 shrink-0 flex items-center justify-between px-4 border-b border-white/10 bg-[#1a1a1a]"><div className="flex items-center gap-2 text-[#fbbf24] font-bold text-sm font-noto"><Settings size={16} /> ç®¡ç†å“¡æ§åˆ¶å°</div><button onClick={() => setIsAdminOpen(false)} className="text-gray-500 hover:text-white"><ChevronsRight size={20} /></button></div>
                            <div className="p-4 space-y-6 overflow-y-auto custom-scroll flex-grow font-noto">
                                <button onClick={() => setShowSimModal(true)} className="w-full bg-indigo-900/50 border border-indigo-500 text-indigo-200 py-2 rounded font-bold flex items-center justify-center gap-2 hover:bg-indigo-900 transition-colors"><Activity size={16} /> é–‹å•Ÿ RTP æ¨¡æ“¬å™¨</button>
                                <div className="space-y-3"><h3 className="text-xs font-bold text-gray-400 uppercase flex items-center gap-2"><Zap size={12} className="text-yellow-500" /> ä¸Šå¸æ¨¡å¼</h3><div className="grid grid-cols-2 gap-2"><button disabled={isSpinning} onClick={() => startSpin('SCATTER')} className="bg-rose-900/20 hover:bg-rose-900/40 border border-rose-700/50 text-rose-400 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition-colors">FG</button><button disabled={isSpinning} onClick={() => startSpin('BIG_WIN')} className="bg-emerald-900/20 hover:bg-emerald-900/40 border border-emerald-700/50 text-emerald-400 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition-colors">WIN</button></div></div>
                            </div>
                        </div>
                    )}
                    <style>{`@keyframes laserShoot { 0% { stroke-dasharray: 0, 1000; stroke-dashoffset: 0; opacity: 0.8; } 50% { opacity: 1; stroke-width: 8; } 100% { stroke-dasharray: 1000, 0; stroke-dashoffset: 0; opacity: 0; stroke-width: 2; } } .animate-laser-shot { animation: laserShoot 0.6s ease-out forwards; }`}</style>

                    {/* Background Music */}
                    <audio ref={bgmRef} loop src="./sound/bgm.MP3" />

                </div>
            );
        }
        // --- [è¡¥å›] æ‚¬æµ®æ—¥å¿—çª—å£ ---
        function FloatingLogger({ logs, visible, onToggle }) {
            if (!visible) return (
                <button onClick={onToggle} className="fixed top-2 left-2 z-[100] bg-black/50 text-white p-2 rounded-full border border-white/20 hover:bg-black/80">
                    <Terminal size={16} />
                </button>
            );

            return (
                <div className="fixed top-2 left-2 z-[100] w-64 max-h-[300px] flex flex-col font-noto animate-in slide-in-from-left-10">
                    <div className="bg-black/80 backdrop-blur-md border border-white/20 rounded-t-lg p-2 flex justify-between items-center cursor-pointer" onClick={onToggle}>
                        <span className="text-xs font-bold text-[#fbbf24] flex items-center gap-2"><Terminal size={12} /> ç³»ç»Ÿæ—¥å¿—</span>
                        <Minus size={12} className="text-gray-400" />
                    </div>
                    <div className="bg-black/60 border-x border-b border-white/10 rounded-b-lg p-2 overflow-y-auto custom-scroll h-full text-[10px] font-mono">
                        {logs.length === 0 && <div className="text-gray-500 italic">ç­‰å¾…æ•°æ®...</div>}
                        {logs.map((l, i) => (
                            <div key={i} className={`mb-1 border-b border-white/5 pb-1 last:border-0 ${l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-emerald-400' : l.type === 'gold' ? 'text-yellow-400' : l.type === 'warning' ? 'text-orange-400' : 'text-gray-300'}`}>
                                <span className="opacity-50 mr-1">[{l.time}]</span>
                                {l.msg}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        // --- [å‡çº§] é€‰æ¡Œå¤§å…ç»„ä»¶ (Filter & FG Detail) ---
        // --- [ä¿®å¤] é€‰æ¡Œå¤§å…ç»„ä»¶ (Correct Version) ---
        function TableLobby({ tableCount, onSelectTable, user, onLogout }) {
            const [tables, setTables] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [filter, setFilter] = useState('all'); // ç©å®¶ç«¯åªç”¨ filterï¼Œä¸ç”¨ activeTab

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'apps', APP_ID, 'tables'), (snapshot) => {
                    const list = Array.from({length: tableCount}, (_, i) => ({ id: i+1, status: 'idle', currentUser: null, totalBet:0, totalWin:0, todayBet:0, todayWin:0, fgCount:0, totalSpins:0, fgHistory:[] }));
                    snapshot.forEach(doc => {
                        const id = parseInt(doc.id.replace('table_', ''));
                        if (id > 0 && id <= tableCount) list[id-1] = { ...list[id-1], ...doc.data() };
                    });
                    setTables(list);
                });
                return () => unsub();
            }, [tableCount]);

            // è¾…åŠ©ï¼šåˆ¤æ–­æ¡Œå­æ˜¯å¦çœŸçš„ç¹å¿™ (å«è¶…æ—¶æ£€æµ‹)
            const isTableBusy = (t) => {
                const isStale = t.lastActive && (new Date().getTime() - t.lastActive > 15000);
                return (t.status === 'occupied' || t.status === 'spinning') && !isStale;
            };

            // è¿‡æ»¤é€»è¾‘
            const displayedTables = tables.filter(t => filter === 'all' || !isTableBusy(t));

            // åº•éƒ¨çŠ¶æ€æ é€»è¾‘
            const activeTable = selectedId ? tables.find(t => t.id === selectedId) : null;
            const isRealOccupied = activeTable && isTableBusy(activeTable);
            const calcRTP = (win, bet) => bet > 0 ? ((win/bet)*100).toFixed(2) : '0.00';

            // FG ç»Ÿè®¡è®¡ç®—
            const avgFG = (activeTable && activeTable.fgCount > 0) ? Math.round((activeTable.totalSpins || 0) / activeTable.fgCount) : '-';
            const fgHist = activeTable ? (activeTable.fgHistory || []) : [];
            const last1 = fgHist.length > 0 ? fgHist[fgHist.length - 1] : '-';
            const last2 = fgHist.length > 1 ? fgHist[fgHist.length - 2] : '-';

            return (
                <div className="min-h-screen bg-[#0f0500] text-white font-noto flex flex-col animate-in fade-in relative">
                    {/* Header */}
                    <div className="h-16 bg-[#1c1917] border-b border-[#fbbf24]/30 flex items-center justify-between px-6 shrink-0 z-10 shadow-xl">
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2"><span className="text-2xl font-cinzel font-bold text-[#fbbf24]">SETH II</span><span className="bg-[#fbbf24]/20 text-[#fbbf24] px-2 py-0.5 rounded text-xs font-bold">LOBBY</span></div>
                            
                            {/* æ¡Œå°ç­›é€‰æŒ‰é’® */}
                            <div className="flex bg-black/50 p-1 rounded-lg border border-white/10">
                                <button onClick={() => setFilter('all')} className={`px-4 py-1 rounded text-xs font-bold transition-all ${filter === 'all' ? 'bg-[#fbbf24] text-black' : 'text-gray-400 hover:text-white'}`}>å…¨éƒ¨æ¡Œå°</button>
                                <button onClick={() => setFilter('empty')} className={`px-4 py-1 rounded text-xs font-bold transition-all ${filter === 'empty' ? 'bg-[#fbbf24] text-black' : 'text-gray-400 hover:text-white'}`}>ç©ºæ¡Œ</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-4"><div className="flex flex-col items-end mr-4"><span className="text-sm font-bold text-gray-300">{user.name}</span><span className="text-xs font-mono text-[#fbbf24]">${Math.floor(user.balance).toLocaleString()}</span></div><button onClick={onLogout} className="bg-white/5 hover:bg-white/10 p-2 rounded-full transition-colors text-gray-400 hover:text-white"><LogOut size={20} /></button></div>
                    </div>

                    {/* Table Grid */}
                    <div className="flex-grow p-6 pb-48 overflow-y-auto custom-scroll">
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-7xl mx-auto">
                            {displayedTables.map(t => {
                                const occupied = isTableBusy(t);
                                const isSelf = t.currentUserId === user.id;
                                const isSelected = selectedId === t.id;
                                
                                return (
                                    <button 
                                        key={t.id}
                                        onClick={() => setSelectedId(t.id)}
                                        className={`group relative aspect-[4/3] rounded-xl border-2 transition-all duration-300 flex flex-col items-center justify-center gap-3 overflow-hidden shadow-2xl
                                            ${isSelected ? 'border-[#fbbf24] ring-2 ring-[#fbbf24]/50 scale-105 z-10 bg-[#2d1b0e]' : 
                                              occupied ? (isSelf ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-red-900/10 border-red-900/30 opacity-60') : 
                                              'bg-[#1c1917] border-[#fbbf24]/30 hover:border-[#fbbf24]'}
                                        `}
                                    >
                                        <div className={`absolute top-0 left-0 px-3 py-1 rounded-br-lg font-black font-cinzel text-lg ${occupied && !isSelf ? 'bg-red-900 text-red-200' : 'bg-[#fbbf24] text-black'}`}>#{t.id}</div>
                                        <div className={`p-4 rounded-full border-2 ${occupied ? 'bg-black/50 border-white/10' : 'bg-gradient-to-br from-[#fbbf24] to-[#b45309] border-white/20'}`}>{occupied ? <Lock size={32} className="text-gray-400" /> : <Play size={32} className="text-black ml-1" />}</div>
                                        {occupied && <div className="absolute bottom-2 text-[10px] text-gray-400 bg-black/80 px-2 rounded">{isSelf ? 'YOU ARE HERE' : t.currentUser}</div>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* åº•éƒ¨è¯¦æƒ…çŠ¶æ€æ  */}
                    {/* [é€‚é…] åº•éƒ¨è¯¦æƒ…çŠ¶æ€æ  (æ‰‹æœºç«¯ç´§å‡‘ç‰ˆ / æ¡Œé¢ç«¯å®Œæ•´ç‰ˆ) */}
                    <div className={`fixed bottom-0 left-0 w-full bg-[#1c1917] border-t border-[#fbbf24] p-3 md:p-4 transition-transform duration-300 z-50 shadow-[0_-5px_30px_rgba(0,0,0,0.9)] ${selectedId ? 'translate-y-0' : 'translate-y-full'}`}>
                        {activeTable && (
                            <div className="max-w-7xl mx-auto flex flex-col lg:flex-row items-center gap-3 lg:gap-8">
                                
                                {/* 1. æ‰‹æœºç«¯é¡¶éƒ¨ï¼šæ¡Œå· + æŒ‰é’® (å·¦å³åˆ†å¸ƒ) */}
                                <div className="flex items-center justify-between w-full lg:w-auto lg:hidden">
                                    <div className="text-3xl font-cinzel font-bold text-[#fbbf24]">#{activeTable.id}</div>
                                    <button 
                                        onClick={() => { if (isRealOccupied && activeTable.currentUserId !== user.id) alert("è¯¥æ¡Œå·²è¢«å ç”¨"); else onSelectTable(activeTable.id); }}
                                        disabled={isRealOccupied && activeTable.currentUserId !== user.id}
                                        className={`px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 ${ (isRealOccupied && activeTable.currentUserId !== user.id) ? 'bg-gray-800 text-gray-500' : 'bg-[#fbbf24] text-black' }`}
                                    >
                                        {(isRealOccupied && activeTable.currentUserId !== user.id) ? <Lock size={16}/> : <Play size={16}/>}
                                        {(isRealOccupied && activeTable.currentUserId === user.id) ? 'è¿”å›' : 'è¿›å…¥'}
                                    </button>
                                </div>

                                {/* 2. æ•°æ®å±•ç¤ºåŒº (æ‰‹æœºç«¯ Grid / æ¡Œé¢ç«¯ Flex) */}
                                <div className="w-full lg:flex-grow flex flex-col lg:flex-row items-center gap-3 lg:gap-8">
                                    {/* RTP æ•°æ® */}
                                    <div className="grid grid-cols-4 lg:flex gap-2 lg:gap-6 w-full lg:w-auto text-center lg:text-left bg-white/5 lg:bg-transparent p-2 lg:p-0 rounded-lg">
                                        <div className="col-span-2 lg:col-span-1 flex lg:block items-center justify-between lg:justify-center px-2 lg:px-0">
                                            <div className="text-[10px] text-gray-500 font-bold uppercase lg:mb-1">ä»Šæ—¥ RTP</div>
                                            <div className={`text-lg lg:text-xl font-mono font-bold ${Number(calcRTP(activeTable.todayWin, activeTable.todayBet))>100?'text-red-500':'text-emerald-500'}`}>{calcRTP(activeTable.todayWin, activeTable.todayBet)}%</div>
                                        </div>
                                        <div className="col-span-2 lg:col-span-1 flex lg:block items-center justify-between lg:justify-center px-2 lg:px-0 border-l border-white/10 lg:border-0 pl-2 lg:pl-0">
                                            <div className="text-[10px] text-gray-500 font-bold uppercase lg:mb-1">30æ—¥ RTP</div>
                                            <div className="text-lg lg:text-xl font-mono font-bold text-blue-400">{calcRTP(activeTable.totalWin, activeTable.totalBet)}%</div>
                                        </div>
                                        
                                        {/* æ‰‹æœºç«¯é¢å¤–æ˜¾ç¤ºçš„ FG ç®€ç•¥æ•°æ® */}
                                        <div className="col-span-2 lg:hidden flex items-center justify-between px-2 border-t border-white/10 pt-2 mt-1">
                                            <div className="text-[10px] text-purple-400 font-bold uppercase">å¹³å‡ FG</div>
                                            <div className="text-sm font-mono text-white">1 / <span className="text-[#fbbf24]">{avgFG}</span></div>
                                        </div>
                                        <div className="col-span-2 lg:hidden flex items-center justify-between px-2 border-t border-white/10 pt-2 mt-1 border-l pl-2">
                                            <div className="text-[10px] text-purple-400 font-bold uppercase">FG æ¬¡æ•°</div>
                                            <div className="text-sm font-mono text-white">{activeTable.fgCount || 0}</div>
                                        </div>
                                    </div>

                                    {/* æ¡Œé¢ç«¯è¯¦ç»† FG æ•°æ®æ  (æ‰‹æœºç«¯éšè—) */}
                                    <div className="hidden lg:flex flex-grow bg-white/5 rounded-lg border border-white/10 p-2 items-center justify-around">
                                        <div className="text-center"><div className="text-[9px] text-purple-400 uppercase font-bold">å¹³å‡ FG æ©Ÿç‡</div><div className="text-lg font-mono font-bold text-white">1 / <span className="text-[#fbbf24]">{avgFG}</span></div></div>
                                        <div className="h-8 w-px bg-white/10"></div>
                                        <div className="text-center"><div className="text-[9px] text-gray-500 uppercase font-bold">ä¸Š1æ¬¡ / ä¸Š2æ¬¡</div><div className="text-lg font-mono text-gray-300">{last1} / {last2}</div></div>
                                        <div className="h-8 w-px bg-white/10"></div>
                                        <div className="text-center"><div className="text-[9px] text-gray-500 uppercase font-bold">FG é€²å…¥æ¬¡æ•¸</div><div className="text-lg font-mono font-bold text-white">{activeTable.fgCount || 0}</div></div>
                                    </div>
                                </div>
                                
                                {/* 3. æ¡Œé¢ç«¯å³ä¾§æŒ‰é’® (æ‰‹æœºç«¯éšè—) */}
                                <div className="hidden lg:flex items-center gap-6 shrink-0">
                                    <div className="text-5xl font-cinzel font-bold text-[#fbbf24] drop-shadow-md">#{activeTable.id}</div>
                                    <button 
                                        onClick={() => { if (isRealOccupied && activeTable.currentUserId !== user.id) alert("è¯¥æ¡Œå·²è¢«å ç”¨"); else onSelectTable(activeTable.id); }}
                                        disabled={isRealOccupied && activeTable.currentUserId !== user.id}
                                        className={`shrink-0 px-8 py-4 rounded-lg font-bold text-lg flex items-center gap-2 transition-all ${ (isRealOccupied && activeTable.currentUserId !== user.id) ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-[#b45309] to-[#fbbf24] text-black hover:scale-105' }`}
                                    >
                                        {(isRealOccupied && activeTable.currentUserId !== user.id) ? <Lock size={20}/> : <Play size={20}/>}
                                        {(isRealOccupied && activeTable.currentUserId === user.id) ? 'è¿”å›æ¸¸æˆ' : 'è¿›å…¥æ¸¸æˆ'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ------------------------------------------------------------
        // Admin Dashboard (Updated with Detailed Symbol Config)
        // ------------------------------------------------------------
            function AdminDashboard({ users, onCreateUser, onDeleteUser, onUpdateUserBalance, config, onUpdateConfig, onLogout, onResetData, onSelectTable }) {
            const [activeTab, setActiveTab] = useState('monitor');
            const [newUser, setNewUser] = useState({ id: '', name: '', password: '', balance: 10000 });
            const [localWeights, setLocalWeights] = useState(config.symbolWeights || DEFAULT_CONFIG.symbolWeights);
            const [tables, setTables] = useState([]);

            useEffect(() => { if (config.symbolWeights) setLocalWeights(config.symbolWeights); }, [config]);
            
            // [Monitor] å¯¦æ™‚ç›£è½æ‰€æœ‰æ¡Œå°
            useEffect(() => {
                if (activeTab === 'monitor') {
                    const unsub = onSnapshot(collection(db, 'apps', APP_ID, 'tables'), (snap) => {
                        const list = []; snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                        setTables(list.sort((a,b) => parseInt(a.id.split('_')[1]) - parseInt(b.id.split('_')[1])));
                    });
                    return () => unsub();
                }
            }, [activeTab]);

            // è™•ç†å–®ä¸€ç¬¦è™Ÿæ¬Šé‡è®Šæ›´
            const handleWeightChange = (id, val) => {
                const newWeights = { ...localWeights, [id]: Number(val) };
                setLocalWeights(newWeights);
                // å³æ™‚æ›´æ–°åˆ°çˆ¶å±¤ (æœƒå¯«å…¥ Firebase)
                onUpdateConfig({ ...config, symbolWeights: newWeights });
            };

            const handleCreate = () => { if (!newUser.id || !newUser.name || !newUser.password) { alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™"); return; } onCreateUser(newUser); setNewUser({ id: '', name: '', password: '', balance: 10000 }); };

            // [Helper] ç¬¦è™Ÿé¡è‰²æ˜ å°„ (ç”¨æ–¼åœ–å½¢ç›£æ§)
            const getSymbolColor = (id) => {
                if (id === 99) return 'bg-yellow-500 border-yellow-300 text-black font-black shadow-[0_0_5px_gold]';
                if (id === 88) return 'bg-purple-600 border-purple-400 text-white font-black shadow-[0_0_5px_purple]';
                if (id >= 8) return 'bg-red-700 border-red-500 text-white';
                if (id >= 6) return 'bg-blue-700 border-blue-500 text-white';
                return 'bg-[#2a2a2a] border-white/10 text-gray-500';
            };

// [æ–°å¢] æ§åˆ¶å´é‚Šæ¬„é–‹é—œçš„ç‹€æ…‹
            const [isSidebarOpen, setSidebarOpen] = useState(false);

            return (
                <div className="h-screen bg-[#0f0500] text-white font-noto flex flex-col lg:flex-row overflow-hidden">
                    {/* [æ–°å¢] ç§»å‹•ç«¯é ‚éƒ¨æ¬„ (Mobile Header) */}
                    <div className="h-14 bg-[#1c1917] border-b border-white/10 flex items-center justify-between px-4 shrink-0 lg:hidden z-30 relative">
                        <div className="flex items-center gap-2 text-[#fbbf24] font-cinzel font-bold text-lg"><Settings size={18}/> SETH ADMIN</div>
                        <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-2 text-white hover:bg-white/10 rounded">
                            {isSidebarOpen ? <X size={20}/> : <Settings size={20}/>}
                        </button>
                    </div>

                    {/* Sidebar (Responsive) */}
                    <div className={`
                        fixed inset-y-0 left-0 w-64 bg-[#1c1917] border-r border-white/10 flex flex-col z-40 shadow-2xl transition-transform duration-300
                        lg:static lg:transform-none
                        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}
                    `}>
                        <div className="h-16 hidden lg:flex items-center gap-2 px-6 border-b border-white/10 text-[#fbbf24] font-cinzel font-bold text-xl"><Settings className="text-[#fbbf24]" /> SETH ADMIN</div>
                        <nav className="flex-grow p-4 space-y-2 overflow-y-auto custom-scroll">
                            <button onClick={() => { setActiveTab('monitor'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-colors ${activeTab === 'monitor' ? 'bg-[#fbbf24] text-black font-bold shadow-[0_0_15px_rgba(251,191,36,0.3)]' : 'text-gray-400 hover:bg-white/5'}`}><Activity size={18} /> å³æ™‚ç›£æ§ (Live)</button>
                            <button onClick={() => { setActiveTab('config'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-colors ${activeTab === 'config' ? 'bg-[#fbbf24] text-black font-bold shadow-[0_0_15px_rgba(251,191,36,0.3)]' : 'text-gray-400 hover:bg-white/5'}`}><RotateCw size={18} /> æ©Ÿç‡èˆ‡æ¡Œå°</button>
                            <button onClick={() => { setActiveTab('users'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-colors ${activeTab === 'users' ? 'bg-[#fbbf24] text-black font-bold shadow-[0_0_15px_rgba(251,191,36,0.3)]' : 'text-gray-400 hover:bg-white/5'}`}><Users size={18} /> ç©å®¶ç®¡ç†</button>
                            <button onClick={() => { setActiveTab('data'); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-colors ${activeTab === 'data' ? 'bg-[#fbbf24] text-black font-bold shadow-[0_0_15px_rgba(251,191,36,0.3)]' : 'text-gray-400 hover:bg-white/5'}`}><Database size={18} /> æ•¸æ“šç¶­è­·</button>
                        </nav>
                        <div className="p-4 border-t border-white/10"><button onClick={onLogout} className="w-full flex items-center gap-2 px-4 py-2 text-gray-400 hover:text-white hover:bg-white/5 rounded transition-colors"><LogOut size={16} /> ç™»å‡ºç³»çµ±</button></div>
                    </div>

                    {/* Main Content (Scrollable) */}
                    <div className="flex-grow overflow-y-auto custom-scroll p-8 bg-[#0a0a0a] relative">
                        
                        {/* MONITOR TAB (Graphical) */}
                        {/* MONITOR TAB (Graphical) */}
                        {activeTab === 'monitor' && (
                            <>
                                {/* [æ–°å¢] å…¨å±€æ•°æ®ç»Ÿè®¡æ  (Global Stats Bar) */}
                                {(() => {
                                    // å®æ—¶è®¡ç®—å…¨åœºæ€»æ•°æ®
                                    const gStats = tables.reduce((acc, t) => ({
                                        todayBet: acc.todayBet + (t.todayBet || 0),
                                        todayWin: acc.todayWin + (t.todayWin || 0),
                                        totalBet: acc.totalBet + (t.totalBet || 0),
                                        totalWin: acc.totalWin + (t.totalWin || 0),
                                        active: acc.active + (t.status === 'occupied' || t.status === 'spinning' ? 1 : 0)
                                    }), { todayBet: 0, todayWin: 0, totalBet: 0, totalWin: 0, active: 0 });

                                    const allTodayRTP = gStats.todayBet > 0 ? ((gStats.todayWin / gStats.todayBet) * 100).toFixed(2) : "0.00";
                                    const allMonthRTP = gStats.totalBet > 0 ? ((gStats.totalWin / gStats.totalBet) * 100).toFixed(2) : "0.00";

                                    return (
                                        <div className="bg-[#1c1917] border-l-4 border-[#fbbf24] p-4 rounded-r-lg mb-6 shadow-lg flex flex-wrap items-center justify-between gap-6 animate-in slide-in-from-top-2">
                                            <div className="flex items-center gap-4">
                                                <div className="bg-black/40 p-2 rounded border border-white/5 text-center min-w-[120px]">
                                                    <div className="text-[10px] text-gray-500 uppercase font-bold">å…¨å ´ä»Šæ—¥ RTP</div>
                                                    <div className={`text-2xl font-mono font-black ${Number(allTodayRTP)>100 ? 'text-red-500' : 'text-emerald-400'}`}>{allTodayRTP}%</div>
                                                </div>
                                                <div className="bg-black/40 p-2 rounded border border-white/5 text-center min-w-[120px]">
                                                    <div className="text-[10px] text-gray-500 uppercase font-bold">å…¨å ´30æ—¥ RTP</div>
                                                    <div className={`text-2xl font-mono font-black ${Number(allMonthRTP)>100 ? 'text-red-500' : 'text-blue-400'}`}>{allMonthRTP}%</div>
                                                </div>
                                            </div>
                                            <div className="flex gap-6 text-xs font-mono text-gray-400 border-l border-white/10 pl-6">
                                                <div>ä»Šæ—¥ç¸½æŠ•: <span className="text-white font-bold">${gStats.todayBet.toLocaleString()}</span></div>
                                                <div>ç¸½ç›ˆåˆ©(åº„): <span className={`${(gStats.todayBet-gStats.todayWin)<0 ? 'text-red-400' : 'text-green-400'} font-bold`}>${(gStats.todayBet - gStats.todayWin).toLocaleString()}</span></div>
                                                <div>æ´»èºæ¡Œå°: <span className="text-[#fbbf24] font-bold">{gStats.active} / {config.tableCount || 12}</span></div>
                                            </div>
                                        </div>
                                    );
                                })()}

                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20">

                                {Array.from({length: config.tableCount || 12}).map((_, i) => {
                                    const tableNum = i + 1;
                                    const t = tables.find(tb => tb.id === `table_${tableNum}`) || {};
                                    
                                    // [è¶…æ—¶æ£€æŸ¥] è¶…è¿‡ 15ç§’ æ— å¿ƒè·³è§†ä¸º IDLE
                                    const isStale = t.lastActive && (new Date().getTime() - t.lastActive > 15000);
                                    const isBusy = (t.status === 'occupied' || t.status === 'spinning') && !isStale;
                                    
                                    const gridData = t.monitorGrid || Array(5).fill(Array(6).fill(0));
                                    const rtp = t.totalBet > 0 ? ((t.totalWin/t.totalBet)*100).toFixed(1) : '0.0';
                                    
                                    return (
                                        <div key={tableNum} className={`rounded-xl border overflow-hidden transition-all hover:shadow-[0_0_20px_rgba(251,191,36,0.2)] group ${isBusy ? 'bg-[#1a1510] border-[#fbbf24]/40' : 'bg-[#1c1917] border-white/10 opacity-80'}`}>
                                            {/* Header */}
                                            <div className="px-4 py-3 bg-black/40 flex justify-between items-center border-b border-white/5">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-cinzel font-bold text-[#fbbf24] text-lg">TABLE {tableNum}</span>
                                                    {t.status === 'spinning' && <Loader2 size={14} className="text-[#fbbf24] animate-spin"/>}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className={`w-2 h-2 rounded-full ${isBusy ? 'bg-emerald-500 shadow-[0_0_5px_#10b981] animate-pulse' : 'bg-gray-600'}`}></span>
                                                    <span className={`text-[10px] font-bold tracking-wider ${isBusy ? 'text-emerald-400' : 'text-gray-500'}`}>{isBusy ? (t.status === 'spinning' ? 'SPINNING' : 'ACTIVE') : 'IDLE'}</span>
                                                </div>
                                            </div>

                                            {/* Graphical Grid (5x6) - Visual Upgrade */}
                                            <div className="p-4 flex justify-center bg-black/20 relative">
                                                <div className="grid grid-cols-6 gap-1 w-full max-w-[220px] aspect-[6/5]">
                                                    {gridData.flat().map((item, idx) => {
                                                        // å…¼å®¹æ—§æ•°æ®(æ•°å­—)å’Œæ–°æ•°æ®(å¯¹è±¡)
                                                        const id = typeof item === 'object' ? item.i : item;
                                                        const val = typeof item === 'object' ? item.v : 0;
                                                        
                                                        const sym = SYMBOLS_DEF.find(s => s.id === id);
                                                        if (!sym) return <div key={idx} className="bg-white/5 rounded-[2px]"></div>;

                                                        return (
                                                            <div key={idx} className={`relative w-full h-full rounded-[2px] flex items-center justify-center overflow-hidden ${id===99?'bg-yellow-900/30':''}`}>
                                                                {id === 88 ? (
                                                                        <div className="w-full h-full flex items-center justify-center bg-purple-900/50 border border-purple-500/50 rounded-full">
                                                                            <span className="text-xs md:text-[10px] font-black text-[#fbbf24] drop-shadow-md">{val}x</span>
                                                                        </div>
                                                                ) : (
                                                                    // æ™®é€šç¬¦å·æ˜¾ç¤ºå›¾ç‰‡
                                                                    sym.icon.includes('.') 
                                                                    ? <img src={sym.icon} className="w-[90%] h-[90%] object-contain" />
                                                                    : <span className="text-[10px]">{sym.icon}</span>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                
                                                {/* Overlay Action */}
                                                <div className="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity duration-200">
                                                    <button onClick={() => onSelectTable && onSelectTable(tableNum)} className="bg-[#fbbf24] text-black px-6 py-2 rounded-full font-bold hover:scale-105 transition-transform flex items-center gap-2 shadow-[0_0_20px_rgba(251,191,36,0.5)]">
                                                        <Play size={16} fill="black"/> é€²å…¥æ¸¬è©¦
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Stats (Enhanced) */}
                                            <div className="p-3 bg-[#121212] space-y-2 text-xs border-t border-white/5">
                                                <div className="flex justify-between border-b border-white/5 pb-1 mb-1">
                                                    <span className="text-gray-500">Player: <span className="text-white font-bold">{t.currentUser || '-'}</span></span>
                                                    <span className={`${Number(rtp)>100?'text-red-400':'text-blue-400'} font-mono font-bold`}>RTP {rtp}%</span>
                                                </div>
                                                
                                                {/* FG Stats Row */}
                                                <div className="flex justify-between items-center bg-white/5 p-1.5 rounded">
                                                    <div className="flex flex-col">
                                                        <span className="text-[8px] text-gray-500 uppercase">å¹³å‡ FG</span>
                                                        <span className="text-[#fbbf24] font-mono font-bold">1 / {t.fgCount > 0 ? Math.round((t.totalSpins||0)/t.fgCount) : '-'}</span>
                                                    </div>
                                                    <div className="flex flex-col items-end">
                                                        <span className="text-[8px] text-gray-500 uppercase">ä¸Š1æ¬¡ / ä¸Š2æ¬¡</span>
                                                        <span className="text-gray-300 font-mono">
                                                            {t.fgHistory && t.fgHistory.length > 0 ? t.fgHistory[t.fgHistory.length-1] : '-'} / {t.fgHistory && t.fgHistory.length > 1 ? t.fgHistory[t.fgHistory.length-2] : '-'}
                                                        </span>
                                                    </div>
                                                </div>

                                                <div className="flex justify-between text-[10px] text-gray-500">
                                                    <span>Total Win: <span className="text-[#fbbf24]">${(t.totalWin||0).toLocaleString()}</span></span>
                                                    <span>FG Hits: <span className="text-purple-400">{t.fgCount || 0}</span></span>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                             </div>
                            </>
                        )}

                        {/* CONFIG TAB */}
                        {activeTab === 'config' && (
                            <div className="max-w-5xl mx-auto">
                                <div className="bg-[#1c1917] p-6 rounded-lg border border-white/10 mb-8"><h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-blue-400"><Settings size={20}/> åŸºç¡€è®¾å®š</h2><div className="grid grid-cols-2 gap-8"><div><label className="text-sm text-gray-300 mb-2 block">å¼€æ”¾æ¡Œå°æ•°é‡</label><input type="number" min="1" max="50" value={config.tableCount || 12} onChange={e => onUpdateConfig({ ...config, tableCount: Number(e.target.value) })} className="w-full bg-black border border-white/20 rounded px-3 py-2 text-white font-mono font-bold outline-none focus:border-blue-500" /></div></div></div>

                                {/* --- ç¬¬ä¸€éƒ¨åˆ†ï¼šç¬¦è™Ÿå‡ºç¾æ©Ÿç‡ (Symbol Probability) --- */}
                                <div className="mb-8">
                                    {(() => {
                                        const currentSymbolTotal = SYMBOLS_DEF
                                            .filter(s => s.id !== 88) // æ’é™¤ ID 88
                                            .reduce((acc, s) => {
                                                const val = localWeights[s.id] !== undefined ? Number(localWeights[s.id]) : 0;
                                                return acc + val;
                                            }, 0);

                                        return (
                                            <>
                                                <div className="flex justify-between items-end mb-4 border-b border-white/10 pb-2">
                                                    <h2 className="text-xl font-bold flex items-center gap-2 text-[#fbbf24]">
                                                        <BarChart2 className="text-[#fbbf24]" /> ç¬¦è™Ÿæ‰è½æ©Ÿç‡ (Symbol %)
                                                    </h2>
                                                    {/* è¨ˆç®—ç›®å‰ç¸½å’Œ */}
                                                    <div className="text-sm font-mono">
                                                        ç¸½è¨ˆ: <span className={`${currentSymbolTotal.toFixed(1) == 100 ? 'text-green-400' : 'text-red-400'} font-bold`}>
                                                            {currentSymbolTotal.toFixed(1)}%
                                                        </span>
                                                    </div>
                                                </div>
                                                <p className="text-gray-400 text-xs mb-4">
                                                    * è¨­å®šå„ç¬¦è™Ÿåœ¨ç›¤é¢å‡ºç¾çš„ç™¾åˆ†æ¯”æ©Ÿç‡ã€‚å»ºè­°ç¸½å’Œç‚º 100%ã€‚(ID 88 å·²ç”±ç ¸çƒæ©Ÿåˆ¶æ¥ç®¡ï¼Œæ•…ä¸åœ¨æ­¤åˆ—)
                                                </p>

                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                                    {SYMBOLS_DEF.map(s => {
                                                        if (s.id === 88) return null; // éš±è— ID 88
                                                        return (
                                                            <div key={s.id} className="bg-[#1c1917] p-3 rounded-lg border border-white/10 flex items-center gap-3 hover:border-[#fbbf24]/50 transition-colors relative group">
                                                                <div className="w-12 h-12 flex items-center justify-center shrink-0">
                                                                    {s.icon.includes('.') ? (
                                                                        <img src={s.icon} alt={s.name} className="w-full h-full object-contain drop-shadow-md transition-transform group-hover:scale-110" />
                                                                    ) : (
                                                                        <span className={`text-4xl ${s.color} drop-shadow-md transition-transform group-hover:scale-110`}>{s.icon}</span>
                                                                    )}
                                                                </div>
                                                                <div className="flex-grow">
                                                                    <div className="flex justify-between items-end mb-1">
                                                                        <span className="text-xs text-gray-400 font-bold uppercase">{s.name}</span>
                                                                        <span className="text-[10px] text-gray-600 font-mono">ID:{s.id}</span>
                                                                    </div>
                                                                    <div className="relative">
                                                                        <input
                                                                            type="number"
                                                                            min="0"
                                                                            max="100"
                                                                            step="0.1"
                                                                            value={localWeights[s.id] !== undefined ? localWeights[s.id] : 0}
                                                                            onChange={(e) => handleWeightChange(s.id, e.target.value)}
                                                                            className="w-full bg-black border border-white/20 rounded px-2 py-1 text-[#fbbf24] font-mono font-bold text-sm focus:border-[#fbbf24] outline-none transition-all pr-6"
                                                                        />
                                                                        <span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs">%</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>

                                {/* --- ç¬¬äºŒéƒ¨åˆ†ï¼šéŠæˆ²ç¯€å¥æ§åˆ¶ (RTP) --- */}
                                <div className="mb-8 bg-[#1c1917] p-6 rounded-lg border border-rose-900/30">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-rose-400 border-b border-white/10 pb-2">
                                        <Activity className="text-rose-400" /> éŠæˆ²ç¯€å¥æ§åˆ¶ (RTP Control)
                                    </h2>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        {/* 1. ç©ºè½‰æ©Ÿç‡ */}
                                        <div>
                                            <label className="text-sm text-gray-300 mb-2 block">å¼·åˆ¶ç©ºè½‰æ©Ÿç‡ (Loss Rate)</label>
                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="number" step="0.01" min="0" max="1"
                                                    value={config.emptySpinProbability !== undefined ? config.emptySpinProbability : 0.2}
                                                    onChange={e => {
                                                        let val = parseFloat(e.target.value);
                                                        if (val < 0) val = 0; if (val > 1) val = 1;
                                                        onUpdateConfig({ ...config, emptySpinProbability: val })
                                                    }}
                                                    className="flex-grow bg-black border border-white/20 rounded px-3 py-2 text-rose-400 font-mono font-bold outline-none focus:border-rose-500"
                                                />
                                                <span className="text-xs text-gray-500 w-12 text-right">{Math.round((config.emptySpinProbability || 0.2) * 100)}%</span>
                                            </div>
                                        </div>

                                        {/* 2. ç ¸çƒæ©Ÿç‡ */}
                                        <div>
                                            <label className="text-sm text-gray-300 mb-2 block">å€æ•¸çƒè§¸ç™¼æ©Ÿç‡ (Smash Rate)</label>
                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="number" step="0.01" min="0" max="1"
                                                    value={config.smashProbability !== undefined ? config.smashProbability : 0.3}
                                                    onChange={e => {
                                                        let val = parseFloat(e.target.value);
                                                        if (val < 0) val = 0; if (val > 1) val = 1;
                                                        onUpdateConfig({ ...config, smashProbability: val })
                                                    }}
                                                    className="flex-grow bg-black border border-white/20 rounded px-3 py-2 text-purple-400 font-mono font-bold outline-none focus:border-purple-500"
                                                />
                                                <span className="text-xs text-gray-500 w-12 text-right">{Math.round((config.smashProbability || 0.3) * 100)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* --- ç¬¬ä¸‰éƒ¨åˆ†ï¼šå€æ•¸çƒæ•¸å€¼æ©Ÿç‡ (Multiplier Value %) --- */}
                                <div>
                                    {/* å®šç¾©æ‚¨æƒ³è¦ä½¿ç”¨çš„å€æ•¸åˆ—è¡¨ (èˆ‡ç•«é¢é¡¯ç¤ºä¸€è‡´) */}
                                    {(() => {
                                        // [é—œéµä¿®æ”¹] é€™è£¡å®šç¾©æ‚¨ä»‹é¢ä¸Šè¦é¡¯ç¤ºçš„æ‰€æœ‰å€æ•¸
                                        // é€™æ¨£è¨ˆç®—ç¸½å’Œæ™‚ï¼Œåªæœƒè¨ˆç®—é€™äº›ï¼Œä¸æœƒè¨ˆç®—è³‡æ–™åº«è£¡çš„èˆŠè³‡æ–™(é«’æ•¸æ“š)
                                        const DISPLAY_MULTS = [2, 3, 4, 5, 6, 8, 10, 15, 25, 50, 100, 500];

                                        // è¨ˆç®—åªé‡å°ä¸Šè¿°åˆ—è¡¨çš„ç¸½å’Œ
                                        const currentTotal = DISPLAY_MULTS.reduce((acc, val) => {
                                            const weight = (config.multiplierWeights && config.multiplierWeights[val]) !== undefined
                                                ? Number(config.multiplierWeights[val])
                                                : (DEFAULT_CONFIG.multiplierWeights[val] || 0);
                                            return acc + weight;
                                        }, 0);

                                        return (
                                            <>
                                                <div className="flex justify-between items-end mb-4 border-b border-white/10 pb-2">
                                                    <h2 className="text-xl font-bold flex items-center gap-2 text-purple-400">
                                                        <Zap className="text-purple-400" /> å€æ•¸çƒæ•¸å€¼æ©Ÿç‡ (Multiplier %)
                                                    </h2>
                                                    <div className="text-sm font-mono">
                                                        ç¸½è¨ˆ: <span className={`${currentTotal.toFixed(1) == 100 ? 'text-green-400' : 'text-red-400'} font-bold`}>
                                                            {currentTotal.toFixed(1)}%
                                                        </span>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                    {DISPLAY_MULTS.map(val => {
                                                        const currentWeight = (config.multiplierWeights && config.multiplierWeights[val]) !== undefined
                                                            ? config.multiplierWeights[val]
                                                            : (DEFAULT_CONFIG.multiplierWeights[val] || 0);

                                                        return (
                                                            <div key={val} className="bg-[#1c1917] p-3 rounded-lg border border-purple-900/30 flex flex-col gap-2">
                                                                <div className="flex justify-between items-center">
                                                                    <span className="text-lg font-black text-white">{val}x</span>
                                                                </div>
                                                                <div className="relative">
                                                                    <input
                                                                        type="number"
                                                                        min="0" max="100" step="0.1"
                                                                        value={currentWeight}
                                                                        onChange={(e) => {
                                                                            const safePrevWeights = config.multiplierWeights || DEFAULT_CONFIG.multiplierWeights;
                                                                            // ç¢ºä¿æ•¸å€¼ç‚ºæ•¸å­—
                                                                            const newMW = { ...safePrevWeights, [val]: Number(e.target.value) };
                                                                            onUpdateConfig({ ...config, multiplierWeights: newMW });
                                                                        }}
                                                                        className="w-full bg-black border border-white/20 rounded px-2 py-1 text-purple-400 font-mono font-bold focus:border-purple-500 outline-none pr-6"
                                                                    />
                                                                    <span className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs">%</span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* USERS TAB */}
                        {activeTab === 'users' && (<div className="space-y-8 max-w-5xl mx-auto">
                                <div className="glass-panel p-6 rounded-xl">
                                    <h3 className="text-lg font-bold text-[#fbbf24] mb-4 flex items-center gap-2"><PlusCircle size={18} /> å‰µå»ºæ–°ç©å®¶</h3>
                                    <div className="grid grid-cols-4 gap-4">
                                        <input placeholder="å¸³è™Ÿ (ID)" value={newUser.id} onChange={e => setNewUser({ ...newUser, id: e.target.value })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#fbbf24] outline-none" />
                                        <input placeholder="æš±ç¨±" value={newUser.name} onChange={e => setNewUser({ ...newUser, name: e.target.value })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#fbbf24] outline-none" />
                                        <input placeholder="å¯†ç¢¼" type="password" value={newUser.password} onChange={e => setNewUser({ ...newUser, password: e.target.value })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#fbbf24] outline-none" />
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="åˆå§‹é¤˜é¡" value={newUser.balance} onChange={e => setNewUser({ ...newUser, balance: Number(e.target.value) })} className="bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#fbbf24] outline-none w-full" />
                                            <button onClick={handleCreate} className="bg-[#fbbf24] text-black font-bold px-4 rounded hover:bg-[#f59e0b] whitespace-nowrap">å‰µå»º</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-panel p-6 rounded-xl">
                                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Users size={18} /> ç©å®¶åˆ—è¡¨</h3>
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-gray-400 uppercase bg-black/30">
                                            <tr>
                                                <th className="px-4 py-3">å¸³è™Ÿ</th>
                                                <th className="px-4 py-3">æš±ç¨±</th>
                                                <th className="px-4 py-3">é¤˜é¡ (é»æ“Šä¿®æ”¹)</th>
                                                <th className="px-4 py-3">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-white/10">
                                            {users.filter(u => u.role !== 'admin').map(u => (
                                                <tr key={u.id} className="hover:bg-white/5">
                                                    <td className="px-4 py-3 font-mono">{u.id}</td>
                                                    <td className="px-4 py-3">{u.name}</td>
                                                    <td className="px-4 py-3">
                                                        <input
                                                            type="number"
                                                            value={u.balance}
                                                            onChange={(e) => onUpdateUserBalance(u.id, Number(e.target.value))}
                                                            className="bg-transparent border border-transparent hover:border-white/20 focus:border-[#fbbf24] rounded px-2 py-1 outline-none font-mono text-[#fbbf24] w-32"
                                                        />
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <button onClick={() => onDeleteUser(u.id)} className="text-red-400 hover:text-red-300 flex items-center gap-1">
                                                            <Trash2 size={14} /> åˆªé™¤
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* DATA TAB */}
                        {activeTab === 'data' && (
                            <div className="glass-panel p-6 rounded-xl max-w-lg mx-auto mt-10">
                                <h3 className="text-lg font-bold text-red-400 mb-4 flex items-center gap-2"><Trash2 size={18} /> å±éšªå€åŸŸ</h3>
                                <p className="text-gray-400 text-sm mb-6">
                                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡æ¸…é™¤æ‰€æœ‰é›²ç«¯æ•¸æ“šï¼Œä¸¦é‡å»ºé è¨­å¸³è™Ÿã€‚æ­¤æ“ä½œå°æ‰€æœ‰ç”¨æˆ¶ç”Ÿæ•ˆï¼Œè«‹è¬¹æ…ä½¿ç”¨ã€‚
                                </p>
                                <button onClick={onResetData} className="bg-red-900/50 border border-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded w-full flex items-center justify-center gap-2 transition-colors">
                                    <RefreshCw size={18} /> é‡ç½®æ‰€æœ‰æ•¸æ“š (Factory Reset)
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function LoginScreen({ onLogin, loading, isConfigured }) {
            const [id, setId] = useState('');
            const [pass, setPass] = useState('');

            if (!isConfigured) {
                return (
                    <div className="fixed inset-0 w-full h-full bg-black flex items-center justify-center text-white p-8">
                        <div className="max-w-lg text-center space-y-4">
                            <AlertTriangle className="w-16 h-16 text-yellow-500 mx-auto" />
                            <h1 className="text-2xl font-bold">å°šæœªè¨­å®š Firebase</h1>
                            <p className="text-gray-400">
                                è«‹åœ¨ä»£ç¢¼ä¸­ <code>const firebaseConfig</code> è™•å¡«å…¥æ‚¨çš„è¨­å®šã€‚
                            </p>
                        </div>
                    </div>
                );
            }

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(id, pass);
            };

            return (
                <div className="fixed inset-0 w-full h-full bg-[#0f0500] flex items-center justify-center p-4 font-noto">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#2d1b0e_0%,_#0f0500_100%)] z-0 opacity-50"></div>
                    <div className="w-full max-w-md bg-[#1c1917] border border-[#fbbf24]/30 p-8 rounded-2xl shadow-2xl relative z-10">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-cinzel font-bold text-[#fbbf24] tracking-widest mb-2 flex items-center justify-center gap-2">
                                SETH II <Cloud size={20} className="text-blue-400" />
                            </h1>
                            <p className="text-gray-500 text-sm tracking-wide">CLOUD CASINO SYSTEM</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-xs text-gray-400 uppercase mb-2 font-bold">å¸³è™Ÿ / User ID</label>
                                <div className="relative">
                                    <User className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} />
                                    <input type="text" value={id} onChange={e => setId(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-3 pl-10 pr-4 text-white focus:border-[#fbbf24] outline-none" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 uppercase mb-2 font-bold">å¯†ç¢¼ / Password</label>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} />
                                    <input type="password" value={pass} onChange={e => setPass(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-3 pl-10 pr-4 text-white focus:border-[#fbbf24] outline-none" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
                                </div>
                            </div>
                            <button disabled={loading} type="submit" className="w-full bg-gradient-to-r from-[#b45309] to-[#fbbf24] text-black font-bold py-3 rounded-lg hover:shadow-[0_0_15px_rgba(251,191,36,0.4)] transition-all flex items-center justify-center gap-2">
                                {loading ? <Loader2 className="animate-spin" /> : <><LogIn size={18} /> ç™»å…¥ç³»çµ±</>}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function SethCasinoCloud() {
            const [userAuth, setUserAuth] = useState(null);
            const [usersData, setUsersData] = useState([]);
            const [configData, setConfigData] = useState(DEFAULT_CONFIG);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentTable, setCurrentTable] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [permissionError, setPermissionError] = useState(false);

            useEffect(() => {
                if (!isConfigured) return;
                const init = async () => { await signInAnonymously(auth); }; init();
                const unsubAuth = onAuthStateChanged(auth, (u) => { setUserAuth(u); });
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!userAuth || !isConfigured) return;
                const usersRef = collection(db, 'apps', APP_ID, COL_USERS);
                const unsubUsers = onSnapshot(usersRef, (snapshot) => {
                    const list = []; snapshot.forEach(doc => list.push(doc.data()));
                    if (list.length === 0) { DEFAULT_USERS.forEach(u => { setDoc(doc(db, 'apps', APP_ID, COL_USERS, u.id), u); }); } 
                    else { setUsersData(list); setLoading(false); }
                }, (error) => { if (error.code === 'permission-denied') setPermissionError(true); });

                const configRef = doc(db, 'apps', APP_ID, COL_CONFIG, 'main');
                const unsubConfig = onSnapshot(configRef, (docSnap) => { if (docSnap.exists()) { setConfigData(docSnap.data()); } else { setDoc(configRef, DEFAULT_CONFIG); } }, (error) => { if (error.code === 'permission-denied') setPermissionError(true); });
                return () => { unsubUsers(); unsubConfig(); };
            }, [userAuth]);

            const handleCreateUser = async (newUser) => { if (usersData.some(u => u.id === newUser.id)) { alert("å¸³è™Ÿå·²å­˜åœ¨"); return; } await setDoc(doc(db, 'apps', APP_ID, COL_USERS, newUser.id), { ...newUser, role: 'player' }); alert("å‰µå»ºæˆåŠŸ"); };
            const handleDeleteUser = async (userId) => { alert("å®‰å…¨è€ƒé‡ï¼Œè«‹è‡³ Firebase Console åˆªé™¤è³‡æ–™ã€‚"); };
            const handleUpdateUserBalance = async (userId, newBalance) => { const user = usersData.find(u => u.id === userId); if (user) { await setDoc(doc(db, 'apps', APP_ID, COL_USERS, userId), { ...user, balance: newBalance }); } };
            const handleUpdateConfig = async (newConfig) => { await setDoc(doc(db, 'apps', APP_ID, COL_CONFIG, 'main'), newConfig); };
            const handleResetData = async () => { if (confirm("ç¢ºå®šé‡ç½®ï¼Ÿé€™å°‡é‚„åŸæ‰€æœ‰è¨­å®šã€‚")) { setLoading(true); await setDoc(doc(db, 'apps', APP_ID, COL_CONFIG, 'main'), DEFAULT_CONFIG); for (const u of DEFAULT_USERS) { await setDoc(doc(db, 'apps', APP_ID, COL_USERS, u.id), u); } alert("å·²é‡ç½®åŸºç¡€è®¾å®šã€‚"); setLoading(false); setCurrentUser(null); setCurrentTable(null); } };
            const handleLogin = (id, pass) => { const user = usersData.find(u => u.id === id && u.password === pass); if (user) setCurrentUser(user); else alert("å¸³è™Ÿå¯†ç¢¼éŒ¯èª¤"); };
            useEffect(() => { if (currentUser) { const freshUser = usersData.find(u => u.id === currentUser.id); if (freshUser) setCurrentUser(prev => ({ ...prev, ...freshUser })); } }, [usersData]);

            // æ¸²æŸ“é€»è¾‘ï¼šåŒºåˆ†ç®¡ç†å‘˜å’Œæ™®é€šç©å®¶
            return (
                <>
                    <PermissionErrorModal isOpen={permissionError} />
                    {!currentUser && <LoginScreen onLogin={handleLogin} loading={loading} isConfigured={isConfigured} />}
                    
                    {/* ç®¡ç†å‘˜è·¯ç”± */}
                    {currentUser && currentUser.role === 'admin' && (
                        currentTable ? (
                            // ç®¡ç†å‘˜è¿›å…¥æ¸¸æˆæµ‹è¯•
                            <GameEngine 
                                user={currentUser} 
                                globalConfig={configData} 
                                tableId={currentTable} 
                                onLeaveTable={() => setCurrentTable(null)} // é€€å‡ºå›åˆ°åå°
                                onUpdateBalance={(val) => handleUpdateUserBalance(currentUser.id, val)}
                                onLogout={() => { setCurrentTable(null); setCurrentUser(null); }} 
                            />
                        ) : (
                            // ç®¡ç†å‘˜åå°
                            <div className="relative w-full h-full">
                                <AdminDashboard 
                                    users={usersData} 
                                    onCreateUser={handleCreateUser} 
                                    onDeleteUser={handleDeleteUser} 
                                    onUpdateUserBalance={handleUpdateUserBalance} 
                                    config={configData} 
                                    onUpdateConfig={handleUpdateConfig} 
                                    onLogout={() => setCurrentUser(null)} 
                                    onResetData={handleResetData}
                                    onSelectTable={(id) => setCurrentTable(id)} // ä¼ å…¥é€‰æ¡Œå›è°ƒ
                                />
                            </div>
                        )
                    )}

                    {/* ç©å®¶è·¯ç”± */}
                    {currentUser && currentUser.role === 'player' && (
                        <>
                            {!currentTable ? (
                                <TableLobby user={currentUser} tableCount={configData.tableCount || 12} onSelectTable={(id) => setCurrentTable(id)} onLogout={() => setCurrentUser(null)} />
                            ) : (
                                <GameEngine user={currentUser} globalConfig={configData} tableId={currentTable} onLeaveTable={() => setCurrentTable(null)} onUpdateBalance={(val) => handleUpdateUserBalance(currentUser.id, val)} onLogout={() => { setCurrentTable(null); setCurrentUser(null); }} />
                            )}
                        </>
                    )}
                </>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<SethCasinoCloud />);
    </script>
</body>

</html>